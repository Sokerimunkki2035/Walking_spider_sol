<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Walking Spider Sol â€“ 3 peliÃ¤</title>
  <style>
    :root{
      --bg:#0f3c35;
      --panel:#ffffff;
      --ink:#0b1b18;
      --muted:#54706a;
      --btn:#1e6a5b;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --radius:18px;
      --gap:10px;
      --cardW: 50px; /* JS sÃ¤Ã¤tÃ¤Ã¤ */
      --cardH: calc(var(--cardW) * 1.35);
      --stackOffset: 14px;
      --zoneH: 520px; /* dropzone korkeus (JS voi sÃ¤Ã¤tÃ¤Ã¤) */
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 30% -10%, #1b6b5d, var(--bg));
      color:#fff;
      -webkit-tap-highlight-color: transparent;
      overflow-x:hidden;
    }
    header{
      position: sticky; top:0; z-index: 10;
      background: rgba(15,60,53,.86);
      backdrop-filter: blur(10px);
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .brand{font-weight:900; letter-spacing:.3px; font-size:18px; display:flex; align-items:center; gap:10px;}
    .pill{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      padding: 8px 10px;
      border-radius: 999px;
      font-weight:800;
      display:flex; gap:8px; align-items:center;
    }
    .tabs{display:flex; gap:8px; margin-top:10px; flex-wrap:wrap}
    .tab{
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.06);
      color:#fff;
      padding:10px 12px;
      border-radius: 999px;
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{background: rgba(255,255,255,.18)}
    main{padding:14px; max-width: 980px; margin:0 auto}
    .card{
      background: rgba(255,255,255,.95);
      color: var(--ink);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 12px 0;
    }
    .card h2{margin:0 0 6px; font-size:28px}
    .sub{color: var(--muted); font-weight:700; line-height:1.35}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      appearance:none; border:0; cursor:pointer;
      background: var(--btn);
      color:#fff; font-weight:900;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: 0 10px 18px rgba(0,0,0,.18);
    }
    button.secondary{background:#dfeeea; color:#10322c; font-weight:900}
    button:disabled{opacity:.55; cursor:not-allowed}
    .hintBox{
      background: #f3fbf8;
      border: 1px solid #d8efea;
      border-radius: 14px;
      padding: 10px 12px;
      color: #12443b;
      font-weight:800;
      margin-top:10px;
    }
    .tiny{font-size:12px; font-weight:800; color: var(--muted)}
    .divider{height:1px; background: rgba(0,0,0,.08); margin:12px 0}
    .boardWrap{
      margin-top: 10px;
      background: linear-gradient(180deg, rgba(16,67,58,.15), rgba(16,67,58,.03));
      border-radius: 18px;
      padding: 10px;
      border: 1px solid rgba(0,0,0,.08);
      overflow: hidden;
    }
    .boardScroll{
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 6px;
    }
    .cols{
      display:flex; gap: var(--gap);
      width: max-content;
      padding: 6px 2px;
    }
    .col{
      width: calc(var(--cardW) + 6px);
      background: rgba(16,67,58,.12);
      border: 1px solid rgba(16,67,58,.22);
      border-radius: 14px;
      padding: 6px 4px 10px;
      position: relative;
    }
    .colTitle{
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,.85);
      text-align:center;
      margin: 4px 0 6px;
      text-shadow: 0 2px 12px rgba(0,0,0,.25);
    }

    /* TÃ„MÃ„ on se fix: aina klikattava dropzone */
    .stackZone{
      position: relative;
      height: var(--zoneH);
      border-radius: 14px;
      overflow: hidden;
    }
    .zoneHit{
      position:absolute;
      inset:0;
      border-radius: 14px;
      /* lÃ¤hes lÃ¤pinÃ¤kyvÃ¤, mutta ottaa klikit */
      background: rgba(255,255,255,0.001);
      z-index: 1;
    }
    .zoneHit.hilight{
      outline: 3px dashed rgba(255,206,84,.85);
      outline-offset: -6px;
      background: rgba(255,206,84,.07);
    }

    .cardEl{
      width: var(--cardW);
      height: var(--cardH);
      border-radius: 10px;
      background:#fff;
      border: 2px solid rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      user-select:none;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 8px 14px rgba(0,0,0,.18);
      z-index: 2; /* kortit zoneHitin pÃ¤Ã¤llÃ¤ */
    }
    .cardEl.down{
      background: repeating-linear-gradient(45deg,#1a6a5b,#1a6a5b 8px,#14564a 8px,#14564a 16px);
      color: transparent;
      border-color: rgba(255,255,255,.18);
    }
    .cardEl.sel{outline: 3px solid #ffce54; border-color:#ffce54}
    .cardEl.ok{outline: 3px solid #66d19a; border-color:#66d19a}

    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; align-items:center;}
    .chip{
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 900;
      color:#fff;
      display:flex; gap:8px; align-items:center;
    }
    .toast{
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.78);
      color:#fff;
      padding: 10px 12px;
      border-radius: 14px;
      font-weight:900;
      z-index: 50;
      max-width: 92vw;
      display:none;
    }
    .lockOverlay{
      position: fixed; inset:0; z-index: 70;
      background: rgba(0,0,0,.72);
      display:none;
      align-items:center; justify-content:center;
      padding: 14px;
      touch-action: none;
    }
    .lockCard{
      width: min(560px, 98vw);
      background: rgba(255,255,255,.98);
      color: var(--ink);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .big{font-size: 54px; font-weight: 1000; letter-spacing: .5px; margin: 8px 0;}
    .bar{height: 12px; background: #dfeeea; border-radius: 999px; overflow:hidden; border: 1px solid #cfe7e1; margin-top: 10px;}
    .bar > i{display:block; height:100%; width: 0%; background: #2da77c;}
    .footer{opacity:.9; font-weight:800; font-size: 12px; text-align:center; padding: 18px 12px 26px;}
    .copyWrap{margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}

    /* modal */
    .modalBack{
      position: fixed; inset:0; z-index: 60;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 14px;
    }
    .modal{
      width: min(560px, 98vw);
      background: rgba(255,255,255,.98);
      color: var(--ink);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .modal h3{margin:0 0 6px; font-size: 22px}
    .modal p{margin: 6px 0; color:#2f4c46; font-weight:800; line-height:1.3}
    .optGrid{display:grid; gap:10px; margin-top:10px}
    .optRow{display:flex; gap:10px; flex-wrap:wrap}
    .optRow button{flex: 1 1 140px}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">ğŸ•·ï¸ Walking Spider Sol <span class="pill"><small>kÃ¤vely</small> <span id="walkDoneTxt">ei</span></span></div>
    <div class="pill">ğŸ”¥ Striikki <span id="streak">0</span></div>
    <div class="pill">ğŸ¯ Tavoite <span id="goalMinTxt">5</span> min</div>
    <div class="pill">âœ… TÃ¤nÃ¤Ã¤n <span id="todayMinTxt">0</span> min</div>
  </div>

  <div class="tabs">
    <button class="tab active" id="tabHome">ğŸ  KÃ¤vely</button>
    <button class="tab" id="tabSpider">ğŸ•·ï¸ Spider</button>
    <button class="tab" id="tabScorpion">ğŸ¦‚ Scorpion</button>
    <button class="tab" id="tabGolf">â›³ Golf</button>
  </div>
</header>

<main>
  <section id="viewHome">
    <div class="card">
      <h2>PÃ¤ivÃ¤n kÃ¤velyvelvoite</h2>
      <div class="sub">
        Valitse tavoite (3/5/7 min). Kun tÃ¤ytÃ¤t, pelit aukeaa. KÃ¤velytilassa kosketus lukitaan.
      </div>
      <div class="btnRow">
        <button class="secondary" id="goal3">3 min</button>
        <button class="secondary" id="goal5">5 min</button>
        <button class="secondary" id="goal7">7 min</button>
      </div>
      <div class="btnRow">
        <button id="startWalk">Aloita kÃ¤vely-tila</button>
        <button class="secondary" id="openAfterWalk">Avaa peli</button>
      </div>
      <div class="hintBox" id="walkHint">
        Nykyinen tavoite: <b><span id="goalNow">5</span> min</b> Â· TÃ¤nÃ¤Ã¤n tehty: <b><span id="doneNow">0</span> min</b><br/>
        TÃ¤mÃ¤ on velvoite, ei tÃ¤ydellinen askelmittari.
      </div>
      <div class="divider"></div>
      <div class="tiny">Tietosuojana: mitÃ¤Ã¤n ei lÃ¤hetetÃ¤ minnekÃ¤Ã¤n. Kaikki pysyy laitteessa (localStorage).</div>
    </div>

    <div class="card">
      <h2>Kopioi koodi talteen</h2>
      <div class="sub">Kopioi koko sivun HTML leikepÃ¶ydÃ¤lle.</div>
      <div class="copyWrap">
        <button class="secondary" id="copyAll">ğŸ“‹ Kopioi tÃ¤mÃ¤ (koko HTML)</button>
        <span class="tiny" id="copyMsg"></span>
      </div>
    </div>
  </section>

  <section id="viewSpider" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:0">ğŸ•·ï¸ Spider (1 maa)</h2>
          <div class="sub">Valitse kortti/sarja â†’ napauta kohdepinoa. Napauta tyhjÃ¤Ã¤ aluetta = poista valinta.</div>
        </div>
        <div class="row">
          <span class="chip">ğŸ“¦ Stock <span id="spStock">0</span></span>
          <span class="chip">â†”ï¸ Siirrot <span id="spMoves">0</span></span>
        </div>
      </div>

      <div class="controls">
        <button id="spNew">New game</button>
        <button class="secondary" id="spRestart">Restart sama jako</button>
        <button class="secondary" id="spUndo">Undo</button>
        <button class="secondary" id="spRedo">Redo</button>
        <button id="spDeal">Deal 10</button>
        <button class="secondary" id="spHint">ğŸ§  Vinkki</button>
        <button class="secondary" id="spDeselect">âœ– Poista valinta</button>
      </div>

      <div class="hintBox">Testimoodi: ei taukoporttia kesken pelin.</div>

      <div class="boardWrap">
        <div class="boardScroll">
          <div class="cols" id="spCols"></div>
        </div>
      </div>
      <div class="tiny">Seed: <span id="spSeed"></span></div>
    </div>
  </section>

  <section id="viewScorpion" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:0">ğŸ¦‚ Scorpion</h2>
          <div class="sub">SiirrÃ¤ mikÃ¤ tahansa face-up kortti + kaikki sen alla. Kohteeksi sama maa + yksi isompi.</div>
        </div>
        <div class="row">
          <span class="chip">â†”ï¸ Siirrot <span id="scMoves">0</span></span>
          <span class="chip">ğŸ Valmiit <span id="scDone">0</span></span>
        </div>
      </div>

      <div class="controls">
        <button id="scNew">New game</button>
        <button class="secondary" id="scUndo">Undo</button>
        <button class="secondary" id="scRedo">Redo</button>
        <button class="secondary" id="scHint">ğŸ§  Vinkki</button>
        <button class="secondary" id="scDeselect">âœ– Poista valinta</button>
      </div>

      <div class="boardWrap">
        <div class="boardScroll">
          <div class="cols" id="scCols"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="viewGolf" style="display:none">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:0">â›³ Golf</h2>
          <div class="sub">SiirrÃ¤ pÃ¶ydÃ¤stÃ¤ wasteen jos Â±1 (A/K kiertÃ¤Ã¤). Muuten nosta stockista.</div>
        </div>
        <div class="row">
          <span class="chip">ğŸ“¦ Stock <span id="gStock">0</span></span>
          <span class="chip">ğŸ—‘ï¸ Waste <span id="gWaste">-</span></span>
          <span class="chip">â†”ï¸ Siirrot <span id="gMoves">0</span></span>
        </div>
      </div>

      <div class="controls">
        <button id="gNew">New game</button>
        <button class="secondary" id="gUndo">Undo</button>
        <button class="secondary" id="gRedo">Redo</button>
        <button id="gDraw">Nosta stockista</button>
        <button class="secondary" id="gHint">ğŸ§  Vinkki</button>
      </div>

      <div class="boardWrap">
        <div class="boardScroll">
          <div class="cols" id="gCols"></div>
        </div>
      </div>
    </div>
  </section>

  <div class="footer">Made with stubbornness + walking breaks ğŸ’š</div>
</main>

<div class="toast" id="toast"></div>

<div class="lockOverlay" id="walkOverlay">
  <div class="lockCard">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:1000;font-size:18px">ğŸš¶ KÃ¤velytila</div>
      <button class="secondary" id="walkStop">Lopeta (pidÃ¤ 2s)</button>
    </div>
    <p class="sub" style="margin-top:10px">Kosketus lukossa. Liiku vapaasti.</p>
    <div class="big"><span id="walkLeft">0</span>s</div>
    <div class="bar"><i id="walkBar"></i></div>
  </div>
</div>

<div class="modalBack" id="checkInBack">
  <div class="modal">
    <h3>ğŸ§  Pieni check-in</h3>
    <p id="checkInWhy">Valitse nopeasti:</p>

    <div class="optGrid">
      <div>
        <p><b>1) Onko ollut hyvÃ¤ pÃ¤ivÃ¤?</b></p>
        <div class="optRow">
          <button class="secondary" data-q="day" data-a="juu">ğŸ‘ Juu</button>
          <button class="secondary" data-q="day" data-a="ei">ğŸ‘ Ei</button>
        </div>
      </div>

      <div>
        <p><b>2) Miten tauko meni?</b></p>
        <div class="optRow">
          <button class="secondary" data-q="break" data-a="kivaa">ğŸ˜„ Kivaa</button>
          <button class="secondary" data-q="break" data-a="ihan ok">ğŸ˜ Ihan ok</button>
          <button class="secondary" data-q="break" data-a="tyhmaa">ğŸ™„ TyhmÃ¤Ã¤</button>
        </div>
      </div>

      <div>
        <p><b>3) Saitko jotain ajatuksia mieleen?</b></p>
        <div class="optRow">
          <button class="secondary" data-q="thought" data-a="ajatukset rullasi">ğŸŒ€ Ajatukset rullasi</button>
          <button class="secondary" data-q="thought" data-a="paras idea">ğŸ’¡ Paras idea</button>
          <button class="secondary" data-q="thought" data-a="tarttee kelata">ğŸ” Tarttee kelata</button>
        </div>
      </div>
    </div>

    <div class="btnRow" style="margin-top:12px">
      <button id="checkInDone">Jatka</button>
    </div>

    <div class="tiny" id="checkInStatus"></div>
  </div>
</div>

<script>
const $ = (id)=>document.getElementById(id);
const LS = { get(k,def){ try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch(e){return def}}, set(k,v){ try{localStorage.setItem(k,JSON.stringify(v))}catch(e){} } };
function toast(msg, ms=1600){
  const t=$("toast"); t.textContent=msg; t.style.display="block";
  clearTimeout(toast._tm); toast._tm=setTimeout(()=>t.style.display="none", ms);
}
function todayISO(){
  const d=new Date();
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

/* Korttikoko + dropzone korkeus */
function updateSizes(){
  const vw = Math.min(window.innerWidth, 980);
  const usable = vw - 34;
  const gap = 10;
  const w = Math.floor((usable - 9*gap) / 10);
  const cardW = clamp(w, 40, 62);
  document.documentElement.style.setProperty("--cardW", cardW+"px");
  const off = clamp(Math.floor(cardW*0.28), 10, 18);
  document.documentElement.style.setProperty("--stackOffset", off+"px");

  // dropzone korkeus: nÃ¤ytÃ¶n mukaan
  const zoneH = clamp(Math.floor(window.innerHeight * 0.50), 360, 640);
  document.documentElement.style.setProperty("--zoneH", zoneH+"px");
}
window.addEventListener("resize", updateSizes);
updateSizes();

/* PÃ¤ivÃ¤ data */
const WALK_KEY="ws_walk";
const STREAK_KEY="ws_streak";
let day = LS.get(WALK_KEY, {date:todayISO(), goal:5, doneMin:0, done:false});
if(day.date !== todayISO()){
  const prev = day;
  let st = LS.get(STREAK_KEY,{count:0,lastDate:null});
  st.count = prev.done ? (st.count||0)+1 : 0;
  st.lastDate = todayISO();
  LS.set(STREAK_KEY, st);
  day = {date:todayISO(), goal:prev.goal||5, doneMin:0, done:false};
  LS.set(WALK_KEY, day);
}
let streak = LS.get(STREAK_KEY, {count:0,lastDate:day.date});

function refreshTop(){
  $("goalMinTxt").textContent=day.goal;
  $("todayMinTxt").textContent=day.doneMin;
  $("walkDoneTxt").textContent=day.done?"kyllÃ¤":"ei";
  $("streak").textContent=streak.count||0;
  $("goalNow").textContent=day.goal;
  $("doneNow").textContent=day.doneMin;
}
refreshTop();

function setGoal(min){
  day.goal=min; LS.set(WALK_KEY, day); refreshTop(); toast(`Tavoite: ${min} min`);
}
$("goal3").onclick=()=>setGoal(3);
$("goal5").onclick=()=>setGoal(5);
$("goal7").onclick=()=>setGoal(7);

/* Tabs */
const views={Home:$("viewHome"),Spider:$("viewSpider"),Scorpion:$("viewScorpion"),Golf:$("viewGolf")};
function setActiveTab(name){
  $("tabHome").classList.toggle("active", name==="Home");
  $("tabSpider").classList.toggle("active", name==="Spider");
  $("tabScorpion").classList.toggle("active", name==="Scorpion");
  $("tabGolf").classList.toggle("active", name==="Golf");
  for(const k in views) views[k].style.display = (k===name)?"block":"none";
}
$("tabHome").onclick=()=>setActiveTab("Home");
$("tabSpider").onclick=()=>{ if(!day.done){toast("Tee ensin pÃ¤ivÃ¤n kÃ¤vely."); setActiveTab("Home");} else setActiveTab("Spider"); };
$("tabScorpion").onclick=()=>{ if(!day.done){toast("Tee ensin pÃ¤ivÃ¤n kÃ¤vely."); setActiveTab("Home");} else setActiveTab("Scorpion"); };
$("tabGolf").onclick=()=>{ if(!day.done){toast("Tee ensin pÃ¤ivÃ¤n kÃ¤vely."); setActiveTab("Home");} else setActiveTab("Golf"); };
$("openAfterWalk").onclick=()=>{ if(!day.done){toast("Tee ensin pÃ¤ivÃ¤n kÃ¤vely."); return;} setActiveTab("Spider"); };

/* Walk lock */
let walkTimer=null, walkLeft=0, walkTotal=0, walkStopHold=null;
function startWalk(){
  walkTotal=day.goal*60; walkLeft=walkTotal;
  $("walkLeft").textContent=walkLeft;
  $("walkBar").style.width="0%";
  $("walkOverlay").style.display="flex";
  clearInterval(walkTimer);
  walkTimer=setInterval(()=>{
    walkLeft--; if(walkLeft<0) walkLeft=0;
    $("walkLeft").textContent=walkLeft;
    const pct = 100*(1-(walkLeft/walkTotal));
    $("walkBar").style.width=pct.toFixed(1)+"%";
    if(walkLeft<=0){
      clearInterval(walkTimer);
      $("walkOverlay").style.display="none";
      day.doneMin=day.goal; day.done=true; LS.set(WALK_KEY, day); refreshTop();
      openCheckIn("walk");
      toast("KÃ¤vely tehty âœ…");
    }
  }, 1000);
}
$("startWalk").onclick=()=>startWalk();

$("walkStop").addEventListener("touchstart", ()=>{
  if(walkStopHold) clearTimeout(walkStopHold);
  walkStopHold=setTimeout(()=>{
    clearInterval(walkTimer);
    $("walkOverlay").style.display="none";
    toast("KÃ¤velytila lopetettu");
  }, 2000);
});
$("walkStop").addEventListener("touchend", ()=>{ if(walkStopHold) clearTimeout(walkStopHold); });

/* Check-in */
const checkIn = {answers:{day:null,break:null,thought:null,reason:null}};
function openCheckIn(reason){
  checkIn.answers={day:null,break:null,thought:null,reason};
  $("checkInWhy").textContent = reason==="walk" ? "KÃ¤vely valmis. Valitse nopeasti:" : "Tauko ohi. Valitse nopeasti:";
  $("checkInBack").style.display="flex";
  $("checkInStatus").textContent="Valitse jokaisesta kohdasta yksi.";
}
function closeCheckIn(){ $("checkInBack").style.display="none"; }
$("checkInBack").addEventListener("click",(e)=>{ if(e.target.id==="checkInBack") closeCheckIn(); });
document.querySelectorAll("#checkInBack button[data-q]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    checkIn.answers[btn.dataset.q]=btn.dataset.a;
    const a1=!!checkIn.answers.day, a2=!!checkIn.answers.break, a3=!!checkIn.answers.thought;
    $("checkInStatus").textContent = `Valittu: ${a1?"1":"_"} ${a2?"2":"_"} ${a3?"3":"_"}`;
    toast(`âœ” ${btn.dataset.q}: ${btn.dataset.a}`, 900);
  });
});
$("checkInDone").onclick=()=>{
  if(!checkIn.answers.day||!checkIn.answers.break||!checkIn.answers.thought){ toast("Valitse kaikki 3 kohtaa ğŸ™‚"); return; }
  const log=LS.get("ws_checkins",[]);
  log.push({ts:Date.now(), date:todayISO(), ...checkIn.answers});
  LS.set("ws_checkins", log);
  closeCheckIn();
  toast("Kiitos ğŸ’š", 1200);
};

/* Copy all */
$("copyAll").onclick=async ()=>{
  const html="<!doctype html>\n"+document.documentElement.outerHTML;
  try{ await navigator.clipboard.writeText(html); $("copyMsg").textContent="Kopioitu âœ…"; toast("Kopioitu âœ…"); }
  catch(e){
    const ta=document.createElement("textarea"); ta.value=html; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
    $("copyMsg").textContent="Kopioitu (fallback) âœ…"; toast("Kopioitu âœ…");
  }
  setTimeout(()=>$("copyMsg").textContent="", 2200);
};

/* Cards */
const SUITS=["â™ ","â™¥","â™¦","â™£"];
function rankToStr(r){ return r===1?"A":r===11?"J":r===12?"Q":r===13?"K":String(r); }
function mulberry32(a){ return function(){ let t=a+=0x6D2B79F5; t=Math.imul(t^(t>>>15),t|1); t^=t+Math.imul(t^(t>>>7),t|61); return ((t^(t>>>14))>>>0)/4294967296; } }
function shuffle(arr, seed){
  const rng=mulberry32(seed);
  for(let i=arr.length-1;i>0;i--){ const j=Math.floor(rng()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  return arr;
}
function makeDeck(){
  const out=[];
  for(let s=0;s<4;s++) for(let r=1;r<=13;r++) out.push({r,s,face:true});
  return out;
}

/* ================== SPIDER ================== */
const spider={seed:0,state:null,undo:[],redo:[],selected:null,moves:0};
function spClone(st){ return { cols: st.cols.map(col=>col.map(c=>({...c}))), stock: st.stock.map(c=>({...c})), doneRuns: st.doneRuns }; }
function spPushUndo(){ spider.undo.push(spClone(spider.state)); if(spider.undo.length>80) spider.undo.shift(); spider.redo=[]; }
function spUpdateUI(){ $("spStock").textContent=spider.state.stock.length; $("spMoves").textContent=spider.moves; $("spSeed").textContent=spider.seed; }
function spInit(seed){
  spider.seed=seed; spider.undo=[]; spider.redo=[]; spider.selected=null; spider.moves=0;

  // 1-suit: 104 korttia â™  (8x 13)
  const cards=[];
  for(let k=0;k<8;k++) for(let r=1;r<=13;r++) cards.push({r,s:0,face:true});
  shuffle(cards, seed);

  const cols=Array.from({length:10},()=>[]);
  for(let i=0;i<10;i++){
    const cnt=(i<4)?6:5;
    for(let j=0;j<cnt;j++){
      const c=cards.pop();
      c.face=(j===cnt-1);
      cols[i].push(c);
    }
  }
  const stock=cards.map(c=>({...c,face:false}));
  spider.state={cols,stock,doneRuns:0};
  spRender(); spUpdateUI();
}
function spSelectableRun(colIndex, cardIndex){
  const col=spider.state.cols[colIndex];
  if(!col[cardIndex] || !col[cardIndex].face) return null;
  for(let i=cardIndex;i<col.length-1;i++){
    const a=col[i], b=col[i+1];
    if(!b.face) return null;
    if(a.r!==b.r+1) return null;
  }
  return {col:colIndex, idx:cardIndex};
}
function spCanPlace(run, targetCol){
  const cols=spider.state.cols;
  const from=cols[run.col];
  const moving=from.slice(run.idx);
  const top=moving[0];
  const tcol=cols[targetCol];
  if(tcol.length===0) return true;
  const dest=tcol[tcol.length-1];
  if(!dest.face) return false;
  return dest.r===top.r+1;
}
function spCheckRuns(){
  const cols=spider.state.cols;
  for(let c=0;c<10;c++){
    const col=cols[c];
    if(col.length<13) continue;
    const tail=col.slice(col.length-13);
    if(tail.some(x=>!x.face)) continue;
    let ok=true;
    for(let i=0;i<12;i++){ if(tail[i].r!==tail[i+1].r+1){ ok=false; break; } }
    if(ok && tail[0].r===13 && tail[12].r===1){
      spPushUndo();
      col.splice(col.length-13,13);
      spider.state.doneRuns++;
      if(col.length>0 && !col[col.length-1].face) col[col.length-1].face=true;
      toast("ğŸ Valmis Kâ†’A poistui!");
    }
  }
}
function spTryMove(run, targetCol){
  if(!spCanPlace(run, targetCol)){ toast("ğŸš« Et voi siirtÃ¤Ã¤ tuohon."); return false; }
  spPushUndo();
  const cols=spider.state.cols;
  const from=cols[run.col];
  const moving=from.splice(run.idx);
  cols[targetCol].push(...moving);
  if(from.length>0 && !from[from.length-1].face) from[from.length-1].face=true;
  spider.moves++; spider.selected=null;
  spCheckRuns();
  spRender(); spUpdateUI();
  return true;
}
function spDeal(){
  if(spider.state.cols.some(col=>col.length===0)){ toast("ğŸš« Jako vain jos mikÃ¤Ã¤n pino ei ole tyhjÃ¤."); return; }
  if(spider.state.stock.length<10){ toast("Stock loppu."); return; }
  spPushUndo();
  for(let i=0;i<10;i++){
    const c=spider.state.stock.pop();
    c.face=true;
    spider.state.cols[i].push(c);
  }
  spider.moves++; spider.selected=null;
  spRender(); spUpdateUI();
  toast("ğŸ“¤ Jaettu 10 korttia.");
}
function spHint(){
  const cols=spider.state.cols;
  for(let c=0;c<10;c++){
    const col=cols[c];
    for(let i=0;i<col.length;i++){
      const run=spSelectableRun(c,i);
      if(!run) continue;
      for(let t=0;t<10;t++){
        if(t===c) continue;
        if(spCanPlace(run,t)){
          spider.selected=run;
          spRender();
          toast(`ğŸ§  Vihje: siirrÃ¤ ${rankToStr(col[i].r)} â†’ Pino ${t+1}`);
          return;
        }
      }
    }
  }
  toast("ğŸ§  Ei helppoa siirtoa. Kokeile Deal.");
}

function spRender(){
  const root=$("spCols");
  root.innerHTML="";
  const off=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--stackOffset"))||14;

  for(let ci=0;ci<10;ci++){
    const colDiv=document.createElement("div");
    colDiv.className="col";
    const title=document.createElement("div");
    title.className="colTitle";
    title.textContent=`Pino ${ci+1}`;
    colDiv.appendChild(title);

    const zone=document.createElement("div");
    zone.className="stackZone";

    // HIT-alue (ottaa aina tapit vastaan)
    const hit=document.createElement("div");
    hit.className="zoneHit";
    // jos valittu ja tÃ¤hÃ¤n voi siirtÃ¤Ã¤ -> korostus
    if(spider.selected && spCanPlace(spider.selected, ci) && ci!==spider.selected.col){
      hit.classList.add("hilight");
    }

    hit.addEventListener("click",(e)=>{
      // napauta tyhjÃ¤Ã¤ aluetta:
      if(!spider.selected){
        // ei valintaa => ei mitÃ¤Ã¤n
        return;
      }
      // jos valinta on samasta pinosta ja kÃ¤yttÃ¤jÃ¤ napauttaa taustaa => poista valinta
      if(spider.selected && spider.selected.col===ci){
        spider.selected=null;
        spRender();
        toast("âœ– Valinta poistettu.");
        return;
      }
      // muuten: yritÃ¤ siirtÃ¤Ã¤ valittu tÃ¤hÃ¤n pinoon
      spTryMove(spider.selected, ci);
    });

    zone.appendChild(hit);

    // kortit
    const col=spider.state.cols[ci];
    for(let i=0;i<col.length;i++){
      const c=col[i];
      const el=document.createElement("div");
      el.className="cardEl"+(c.face?"":" down");
      el.style.top=(i*off)+"px";
      if(c.face) el.textContent=`${rankToStr(c.r)} â™ `;

      if(spider.selected && spider.selected.col===ci && spider.selected.idx===i){
        el.classList.add("sel");
      }
      if(spider.selected && spCanPlace(spider.selected, ci) && ci!==spider.selected.col){
        el.classList.add("ok");
      }

      el.addEventListener("click",(ev)=>{
        ev.stopPropagation();

        // sama kortti uudelleen = poista valinta
        if(spider.selected && spider.selected.col===ci && spider.selected.idx===i){
          spider.selected=null;
          spRender();
          toast("âœ– Valinta poistettu.");
          return;
        }

        // jos valinta olemassa -> siirto kohteeksi tÃ¤mÃ¤ pino (ei pakota mihinkÃ¤Ã¤n muuhun)
        if(spider.selected){
          spTryMove(spider.selected, ci);
          return;
        }

        // valitse sarja
        const run=spSelectableRun(ci,i);
        if(!run){ toast("Valitse face-up kortti/sarja."); return; }
        spider.selected=run;

        // pikavihje: etsi ensimmÃ¤inen target
        let target=-1;
        for(let t=0;t<10;t++){
          if(t===ci) continue;
          if(spCanPlace(run,t)){ target=t; break; }
        }
        if(target>=0) toast(`ğŸ§  Vihje: siirrÃ¤ ${rankToStr(col[i].r)} â†’ Pino ${target+1}`);
        else toast("ğŸ§  Ei selkeÃ¤Ã¤ siirtoa. Kokeile vapauttaa tai Deal.");

        spRender();
      });

      zone.appendChild(el);
    }

    colDiv.appendChild(zone);
    root.appendChild(colDiv);
  }
}

$("spNew").onclick=()=>spInit((Math.random()*1e9)|0);
$("spRestart").onclick=()=>spInit(spider.seed);
$("spDeal").onclick=()=>spDeal();
$("spHint").onclick=()=>spHint();
$("spDeselect").onclick=()=>{ spider.selected=null; spRender(); toast("âœ– Valinta poistettu."); };
$("spUndo").onclick=()=>{
  if(!spider.undo.length){ toast("Ei undo."); return; }
  spider.redo.push(spClone(spider.state));
  spider.state=spider.undo.pop();
  spider.selected=null;
  spRender(); spUpdateUI();
};
$("spRedo").onclick=()=>{
  if(!spider.redo.length){ toast("Ei redo."); return; }
  spider.undo.push(spClone(spider.state));
  spider.state=spider.redo.pop();
  spider.selected=null;
  spRender(); spUpdateUI();
};

/* ================== SCORPION ================== */
const scorpion={state:null,undo:[],redo:[],selected:null,moves:0,done:0};
function scClone(st){ return { cols: st.cols.map(col=>col.map(c=>({...c}))) }; }
function scPushUndo(){ scorpion.undo.push(scClone(scorpion.state)); if(scorpion.undo.length>80) scorpion.undo.shift(); scorpion.redo=[]; }
function scUpdateUI(){ $("scMoves").textContent=scorpion.moves; $("scDone").textContent=scorpion.done; }
function scInit(seed){
  scorpion.undo=[]; scorpion.redo=[]; scorpion.selected=null; scorpion.moves=0; scorpion.done=0;
  const deck=shuffle(makeDeck(), seed);
  const cols=Array.from({length:7},()=>[]);
  for(let col=0;col<7;col++){
    for(let i=0;i<7;i++){
      const c=deck.pop();
      c.face = !(col<4 && i<3);
      cols[col].push(c);
    }
  }
  scorpion.state={cols};
  scRender(); scUpdateUI();
}
function scMovable(col, idx){
  const arr=scorpion.state.cols[col];
  if(!arr[idx] || !arr[idx].face) return null;
  return {col, idx};
}
function scCanPlace(run, tcol){
  const cols=scorpion.state.cols;
  const from=cols[run.col];
  const moving=from.slice(run.idx);
  const top=moving[0];
  const destCol=cols[tcol];
  if(destCol.length===0) return true;
  const dest=destCol[destCol.length-1];
  if(!dest.face) return false;
  return dest.s===top.s && dest.r===top.r+1;
}
function scTryMove(run, tcol){
  if(!scCanPlace(run,tcol)){ toast("ğŸš« Scorpion: sama maa + yksi isompi."); return false; }
  scPushUndo();
  const cols=scorpion.state.cols;
  const from=cols[run.col];
  const moving=from.splice(run.idx);
  cols[tcol].push(...moving);
  if(from.length>0 && !from[from.length-1].face) from[from.length-1].face=true;
  scorpion.moves++; scorpion.selected=null;
  scRender(); scUpdateUI();
  return true;
}
function scRender(){
  const root=$("scCols");
  root.innerHTML="";
  const off=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--stackOffset"))||14;

  for(let ci=0;ci<7;ci++){
    const colDiv=document.createElement("div");
    colDiv.className="col";
    colDiv.style.width="calc(var(--cardW) + 10px)";
    const title=document.createElement("div");
    title.className="colTitle";
    title.textContent=`Pino ${ci+1}`;
    colDiv.appendChild(title);

    const zone=document.createElement("div");
    zone.className="stackZone";

    const hit=document.createElement("div");
    hit.className="zoneHit";
    if(scorpion.selected && scCanPlace(scorpion.selected, ci) && ci!==scorpion.selected.col){
      hit.classList.add("hilight");
    }
    hit.addEventListener("click", ()=>{
      if(!scorpion.selected) return;
      if(scorpion.selected.col===ci){
        scorpion.selected=null; scRender(); toast("âœ– Valinta poistettu."); return;
      }
      scTryMove(scorpion.selected, ci);
    });
    zone.appendChild(hit);

    const col=scorpion.state.cols[ci];
    for(let i=0;i<col.length;i++){
      const c=col[i];
      const el=document.createElement("div");
      el.className="cardEl"+(c.face?"":" down");
      el.style.top=(i*off)+"px";
      if(c.face) el.textContent=`${rankToStr(c.r)} ${SUITS[c.s]}`;

      if(scorpion.selected && scorpion.selected.col===ci && scorpion.selected.idx===i) el.classList.add("sel");
      if(scorpion.selected && scCanPlace(scorpion.selected, ci) && ci!==scorpion.selected.col) el.classList.add("ok");

      el.addEventListener("click",(ev)=>{
        ev.stopPropagation();

        if(scorpion.selected && scorpion.selected.col===ci && scorpion.selected.idx===i){
          scorpion.selected=null; scRender(); toast("âœ– Valinta poistettu."); return;
        }
        if(scorpion.selected){
          scTryMove(scorpion.selected, ci);
          return;
        }
        const run=scMovable(ci,i);
        if(!run){ toast("Valitse face-up kortti."); return; }
        scorpion.selected=run;
        scRender();
      });

      zone.appendChild(el);
    }

    colDiv.appendChild(zone);
    root.appendChild(colDiv);
  }
}
$("scNew").onclick=()=>scInit((Math.random()*1e9)|0);
$("scUndo").onclick=()=>{
  if(!scorpion.undo.length){ toast("Ei undo."); return; }
  scorpion.redo.push(scClone(scorpion.state));
  scorpion.state=scorpion.undo.pop();
  scorpion.selected=null;
  scRender(); scUpdateUI();
};
$("scRedo").onclick=()=>{
  if(!scorpion.redo.length){ toast("Ei redo."); return; }
  scorpion.undo.push(scClone(scorpion.state));
  scorpion.state=scorpion.redo.pop();
  scorpion.selected=null;
  scRender(); scUpdateUI();
};
$("scHint").onclick=()=>toast("ğŸ§  Scorpion-vinkki: yritÃ¤ avata piilokortit ja rakentaa samaa maata Kâ†’A.");
$("scDeselect").onclick=()=>{ scorpion.selected=null; scRender(); toast("âœ– Valinta poistettu."); };

/* ================== GOLF ================== */
const golf={state:null,undo:[],redo:[],moves:0};
function gClone(st){ return { cols: st.cols.map(col=>col.map(c=>({...c}))), waste:{...st.waste}, stock: st.stock.map(c=>({...c})) }; }
function gPushUndo(){ golf.undo.push(gClone(golf.state)); if(golf.undo.length>80) golf.undo.shift(); golf.redo=[]; }
function isAdj(a,b){ const d=Math.abs(a-b); return d===1 || (a===1&&b===13) || (a===13&&b===1); }
function gUpdateUI(){
  $("gStock").textContent=golf.state.stock.length;
  $("gWaste").textContent=`${rankToStr(golf.state.waste.r)} ${SUITS[golf.state.waste.s]}`;
  $("gMoves").textContent=golf.moves;
}
function gInit(seed){
  golf.undo=[]; golf.redo=[]; golf.moves=0;
  const deck=shuffle(makeDeck(), seed);
  const cols=Array.from({length:7},()=>[]);
  for(let r=0;r<5;r++){
    for(let c=0;c<7;c++){
      const card=deck.pop(); card.face=true; cols[c].push(card);
    }
  }
  const waste=deck.pop(); waste.face=true;
  const stock=deck.map(c=>({...c,face:false}));
  golf.state={cols,waste,stock};
  gRender(); gUpdateUI();
}
function gCanMove(card){ return isAdj(card.r, golf.state.waste.r); }
function gMoveFrom(ci){
  const col=golf.state.cols[ci];
  if(!col.length){ toast("TyhjÃ¤."); return; }
  const card=col[col.length-1];
  if(!gCanMove(card)){ toast("ğŸš« Golf: Â±1 (A/K kiertÃ¤Ã¤)."); return; }
  gPushUndo();
  col.pop();
  golf.state.waste=card;
  golf.moves++;
  gRender(); gUpdateUI();
}
function gDraw(){
  if(!golf.state.stock.length){ toast("Stock loppu."); return; }
  gPushUndo();
  const c=golf.state.stock.pop(); c.face=true;
  golf.state.waste=c;
  golf.moves++;
  gRender(); gUpdateUI();
}
function gRender(){
  const root=$("gCols");
  root.innerHTML="";
  const off=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--stackOffset"))||14;

  const special=document.createElement("div");
  special.className="col";
  special.style.width="calc(var(--cardW) + 16px)";
  const title=document.createElement("div");
  title.className="colTitle";
  title.textContent="Waste / Stock";
  special.appendChild(title);

  const zone=document.createElement("div");
  zone.className="stackZone";

  const hit=document.createElement("div");
  hit.className="zoneHit";
  hit.addEventListener("click", ()=>{ gDraw(); });
  zone.appendChild(hit);

  const w=document.createElement("div");
  w.className="cardEl";
  w.style.top="0px";
  w.textContent=`${rankToStr(golf.state.waste.r)} ${SUITS[golf.state.waste.s]}`;
  zone.appendChild(w);

  const s=document.createElement("div");
  s.className="cardEl down";
  s.style.top=(off*3)+"px";
  zone.appendChild(s);

  special.appendChild(zone);
  root.appendChild(special);

  for(let ci=0;ci<7;ci++){
    const colDiv=document.createElement("div");
    colDiv.className="col";
    colDiv.style.width="calc(var(--cardW) + 16px)";
    const t=document.createElement("div");
    t.className="colTitle";
    t.textContent=`Pino ${ci+1}`;
    colDiv.appendChild(t);

    const z=document.createElement("div");
    z.className="stackZone";
    const h=document.createElement("div");
    h.className="zoneHit";
    z.appendChild(h);

    const col=golf.state.cols[ci];
    for(let i=0;i<col.length;i++){
      const c=col[i];
      const el=document.createElement("div");
      el.className="cardEl";
      el.style.top=(i*off)+"px";
      el.textContent=`${rankToStr(c.r)} ${SUITS[c.s]}`;
      if(i===col.length-1 && gCanMove(c)) el.classList.add("ok");
      if(i===col.length-1){
        el.addEventListener("click",(ev)=>{ ev.stopPropagation(); gMoveFrom(ci); });
      }
      z.appendChild(el);
    }

    colDiv.appendChild(z);
    root.appendChild(colDiv);
  }
}

$("gNew").onclick=()=>gInit((Math.random()*1e9)|0);
$("gUndo").onclick=()=>{
  if(!golf.undo.length){ toast("Ei undo."); return; }
  golf.redo.push(gClone(golf.state));
  golf.state=golf.undo.pop();
  gRender(); gUpdateUI();
};
$("gRedo").onclick=()=>{
  if(!golf.redo.length){ toast("Ei redo."); return; }
  golf.undo.push(gClone(golf.state));
  golf.state=golf.redo.pop();
  gRender(); gUpdateUI();
};
$("gDraw").onclick=()=>gDraw();
$("gHint").onclick=()=>toast("ğŸ§  Golf-vinkki: pidÃ¤ waste keskellÃ¤ (Ã¤lÃ¤ nosta turhaan), katso ketjut Â±1.");

/* Boot */
setActiveTab("Home");
spInit((Math.random()*1e9)|0);
scInit((Math.random()*1e9)|0);
gInit((Math.random()*1e9)|0);
</script>
</body>
</html>
