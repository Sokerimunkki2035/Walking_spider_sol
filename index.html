<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Walking Spider ‚Äì Index (taukoautomaatilla)</title>

  <style>
    :root{
      --bg:#0d4a3a;
      --panel:rgba(0,0,0,.16);
      --border:rgba(255,255,255,.16);
      --btn:rgba(255,255,255,.18);
      --btn2:rgba(120,255,200,.22);
      --txt:#fff;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:12px;}
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;
      margin-bottom:10px;
    }
    .btn{
      border:0;border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      background:var(--btn);
      color:#fff;
      white-space:nowrap;
    }
    .btn.primary{ background:var(--btn2); }
    .pill{
      padding:10px 14px;border-radius:999px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.15);
      font-weight:900;
      white-space:nowrap;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      margin:10px 0;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;}
    select{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.10);color:#fff;font-weight:900;
    }
    option{color:#000}
    #appFrame{
      width:100%;
      height: calc(100vh - 230px);
      border:0;
      border-radius:16px;
      background:rgba(255,255,255,.08);
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .small{opacity:.85;font-size:13px;line-height:1.35}

    /* --- BREAK OVERLAY --- */
    #breakOverlay{
      display:none;
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(0, 35, 30, .92);
      backdrop-filter: blur(4px);
      color:#fff;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .breakBox{
      max-width:680px;
      width:100%;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:16px;
      text-align:center;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .bigTimer{
      font-size:54px;
      font-weight:1000;
      letter-spacing:1px;
      margin:8px 0 6px;
    }
    .breakMeta{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin:6px 0 10px;
    }
    .progress{
      height:12px;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      margin:10px 0 14px;
    }
    #progBar{
      height:100%;
      width:0%;
      background:rgba(120,255,200,.75);
    }
    .qbox{
      text-align:left;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
      display:none;
    }
    .qbox h3{margin:0 0 8px;font-size:14px}
    .qrow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .qrow button{flex:1 1 140px}

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      background:rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      display:none;
      max-width:min(92vw,520px);
      text-align:center;
      z-index:99999;
    }

    /* --- Embed safety (jos index latautuu iframeen, ei piirret√§ valikkoa) --- */
    .embedWarn{
      max-width:720px;
      margin:40px auto;
      padding:16px;
      border-radius:16px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.18);
      text-align:center;
    }
  </style>

  <script>
    // ‚úÖ Estet√§√§n ‚Äú3x valikot‚Äù:
    // Jos index.html p√§√§tyy iframeen, EI piirret√§ normaalia UI:ta,
    // vaan pyydet√§√§n parenttia lataamaan peli takaisin.
    (function(){
      try{
        if(window.self !== window.top){
          window.parent.postMessage({type:"INDEX_LOADED_IN_IFRAME"}, "*");
          document.addEventListener("DOMContentLoaded", ()=>{
            document.body.innerHTML = `
              <div class="embedWarn">
                <div style="font-weight:1000;font-size:18px">‚Ü©Ô∏è Palautetaan peli‚Ä¶</div>
                <div style="opacity:.9;margin-top:6px">
                  (Index yritti avautua pelin sis√§√§n. T√§m√§ est√§√§ valikon monistumisen.)
                </div>
              </div>
            `;
          });
        }
      }catch(e){}
    })();
  </script>
</head>

<body>
  <div class="wrap">
    <div class="card" id="topCard">
      <div class="topbar">
        <button class="btn primary" onclick="loadPage('spider.html')">üï∑Ô∏è Spider (1 maa)</button>
        <button class="btn" onclick="loadPage('scorpio.html')">ü¶Ç Scorpion</button>
        <button class="btn" onclick="loadPage('golf.html')">‚õ≥ Golf</button>

        <button class="btn" onclick="forceBreak()">üö∂ Tauko nyt</button>
        <button class="btn" onclick="fitToScreen()">üß© Fit</button>

        <div class="pill">Aktiiviaika: <span id="activeClock">00:00</span></div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="pill">Tauko joka</div>
        <select id="everySel" title="Tauko joka X minuuttia">
          <option value="10">10 min</option>
          <option value="15">15 min</option>
          <option value="20">20 min</option>
          <option value="25" selected>25 min</option>
          <option value="30">30 min</option>
          <option value="45">45 min</option>
        </select>

        <div class="pill">Tauon pituus</div>
        <select id="lenSel" title="Tauon pituus">
          <option value="2">2 min</option>
          <option value="3" selected>3 min</option>
          <option value="5">5 min</option>
          <option value="7">7 min</option>
        </select>

        <button class="btn" onclick="resetActive()">Nollaa laskuri</button>
      </div>

      <div class="small" style="text-align:center;margin-top:8px">
        Pysy t√§ss√§ indexiss√§ ‚Üí pelit avautuvat ruudun sis√§√§n. Tauon aikana peli lukitaan (overlay).
      </div>
    </div>

    <iframe id="appFrame" src="spider.html" title="Walking Spider"></iframe>

    <div class="card" style="text-align:center">
      <span class="small">
        Tietosuoja: <a href="privacy.html" style="color:#eafff5;font-weight:1000;text-decoration:none">privacy.html</a>
      </span>
    </div>
  </div>

  <!-- BREAK OVERLAY -->
  <div id="breakOverlay">
    <div class="breakBox">
      <div style="font-size:18px;font-weight:1000">üö∂ K√§velytauko</div>
      <div class="small" id="breakHint">Nouse yl√∂s ja liiku hetki. Tauon aikana peli on lukittu.</div>

      <div class="bigTimer" id="breakTimer">03:00</div>

      <!-- ‚úÖ Tauon oma kello (kulunut + j√§ljell√§) -->
      <div class="breakMeta">
        <div class="pill">Kulunut: <span id="breakElapsed">00:00</span></div>
        <div class="pill">J√§ljell√§: <span id="breakLeft">03:00</span></div>
      </div>

      <div class="progress"><div id="progBar"></div></div>

      <div class="row">
        <button class="btn primary" id="doneBtn" disabled onclick="finishBreak()">Valmis ‚Äì jatka peli√§</button>
      </div>

      <div class="qbox" id="qbox">
        <h3>Lyhyt check-in</h3>

        <div class="small">1) Onko ollut hyv√§ p√§iv√§?</div>
        <div class="qrow">
          <button class="btn" onclick="pick('day','Juu')">Juu</button>
          <button class="btn" onclick="pick('day','Ei')">Ei</button>
        </div>

        <div class="small">2) Miten tauko meni?</div>
        <div class="qrow">
          <button class="btn" onclick="pick('break','Kivaa')">Kivaa</button>
          <button class="btn" onclick="pick('break','Ihan ok')">Ihan ok</button>
          <button class="btn" onclick="pick('break','Tyhm√§√§')">Tyhm√§√§</button>
        </div>

        <div class="small">3) Saitko jotain ajatuksia?</div>
        <div class="qrow">
          <button class="btn" onclick="pick('idea','Ajatukset rullasi')">Ajatukset rullasi</button>
          <button class="btn" onclick="pick('idea','Paras idea')">Paras idea</button>
          <button class="btn" onclick="pick('idea','Tarttee kelata')">Tarttee kelata</button>
        </div>

        <div class="small" id="qsum" style="margin-top:6px"></div>
      </div>

      <div class="small" style="margin-top:10px;opacity:.85">
        (Wake Lock yritet√§√§n pit√§√§ p√§√§ll√§ tauon ajan, jos selaimesi sallii.)
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* -----------------------
   NAV / iframe
------------------------ */
const frame = document.getElementById('appFrame');
let lastGoodPage = 'spider.html';

function loadPage(path){
  // varmistus: √§l√§ koskaan lataa indexi√§ iframeen
  if(/index\.html/i.test(path)){
    toast("Indexi√§ ei ladata peliruudun sis√§√§n.");
    return;
  }
  lastGoodPage = path;
  frame.src = path;
  toast(`Avattu: ${path}`);
}

function fitToScreen(){
  // best-effort: jos spideriss√§ on fitToScreen(), kutsutaan sit√§
  try{
    if(frame.contentWindow && typeof frame.contentWindow.fitToScreen === "function"){
      frame.contentWindow.fitToScreen();
      toast("Fit-to-screen (spider) ‚úÖ");
      return;
    }
  }catch(e){}
  // vaihtoehto: postMessage (voit halutessasi kuunnella spideriss√§)
  try{
    frame.contentWindow.postMessage({type:"FIT_TO_SCREEN"}, "*");
    toast("Fit-to-screen (viesti l√§hetetty)");
  }catch(e){
    toast("Fit-to-screen ei k√§ytett√§viss√§ t√§ss√§ peliss√§");
  }
}

/* -----------------------
   TAUKOMOOTTORI
------------------------ */
const LSKEY = "walking_break_settings_v2";

let activeSeconds = 0;
let everyMin = 25;
let breakMin = 3;

let tick = null;
let onBreak = false;

let breakLeft = 0;
let breakTotal = 0;
let breakElapsed = 0;
let breakTimerInterval = null;

let wakeLock = null;

const activeClock = document.getElementById('activeClock');
const everySel = document.getElementById('everySel');
const lenSel = document.getElementById('lenSel');

function loadSettings(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw){
      const s = JSON.parse(raw);
      if(s.everyMin) everyMin = Number(s.everyMin);
      if(s.breakMin) breakMin = Number(s.breakMin);
      if(s.activeSeconds) activeSeconds = Number(s.activeSeconds);
    }
  }catch(e){}
  everySel.value = String(everyMin);
  lenSel.value = String(breakMin);
  activeClock.textContent = formatMMSS(activeSeconds);
}
function saveSettings(){
  localStorage.setItem(LSKEY, JSON.stringify({everyMin, breakMin, activeSeconds}));
}

everySel.addEventListener('change', ()=>{
  everyMin = Number(everySel.value);
  saveSettings();
  toast(`Tauko joka ${everyMin} min`);
});
lenSel.addEventListener('change', ()=>{
  breakMin = Number(lenSel.value);
  saveSettings();
  toast(`Tauon pituus ${breakMin} min`);
});

function formatMMSS(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
}

function startEngine(){
  if(tick) clearInterval(tick);
  tick = setInterval(()=>{
    if(onBreak) return;
    if(document.visibilityState !== 'visible') return;

    activeSeconds++;
    activeClock.textContent = formatMMSS(activeSeconds);
    saveSettings();

    if(activeSeconds >= everyMin * 60){
      startBreak(breakMin * 60);
    }
  }, 1000);
}

function resetActive(){
  activeSeconds = 0;
  activeClock.textContent = formatMMSS(activeSeconds);
  saveSettings();
  toast("Aktiivilaskuri nollattu");
}

function forceBreak(){
  startBreak(breakMin * 60);
}

/* -----------------------
   BREAK OVERLAY
------------------------ */
const overlay = document.getElementById('breakOverlay');
const bt = document.getElementById('breakTimer');
const prog = document.getElementById('progBar');
const doneBtn = document.getElementById('doneBtn');
const qbox = document.getElementById('qbox');
const qsum = document.getElementById('qsum');
const elEl = document.getElementById('breakElapsed');
const leftEl = document.getElementById('breakLeft');

let answers = {day:null, break:null, idea:null};

function startBreak(seconds){
  if(onBreak) return;

  onBreak = true;
  breakTotal = seconds;
  breakLeft = seconds;
  breakElapsed = 0;

  doneBtn.disabled = true;
  qbox.style.display = "none";
  answers = {day:null, break:null, idea:null};
  qsum.textContent = "";

  overlay.style.display = "flex";
  updateBreakUI();

  requestWakeLock();

  if(breakTimerInterval) clearInterval(breakTimerInterval);
  breakTimerInterval = setInterval(()=>{
    breakLeft--;
    breakElapsed++;
    if(breakLeft <= 0){
      breakLeft = 0;
      clearInterval(breakTimerInterval);
      onBreakEnd();
    }
    updateBreakUI();
  }, 1000);

  toast("Tauko alkoi");
}

function updateBreakUI(){
  bt.textContent = formatMMSS(breakLeft);
  leftEl.textContent = formatMMSS(breakLeft);
  elEl.textContent = formatMMSS(breakElapsed);

  const done = (breakTotal - breakLeft);
  const pct = breakTotal ? (done / breakTotal) * 100 : 0;
  prog.style.width = Math.min(100, Math.max(0, pct)) + "%";
}

function onBreakEnd(){
  doneBtn.disabled = false;
  qbox.style.display = "block";
  toast("Tauko valmis ‚Äì paina Valmis");
  releaseWakeLock();
}

function finishBreak(){
  overlay.style.display = "none";
  onBreak = false;

  // Nollataan aktiivimittari uudelle kierrokselle
  activeSeconds = 0;
  activeClock.textContent = formatMMSS(activeSeconds);
  saveSettings();

  toast("Jatketaan peli√§");
}

function pick(key, val){
  answers[key] = val;
  const parts = [];
  if(answers.day) parts.push("P√§iv√§: " + answers.day);
  if(answers.break) parts.push("Tauko: " + answers.break);
  if(answers.idea) parts.push("Ajatus: " + answers.idea);
  qsum.textContent = parts.join(" ¬∑ ");
}

/* -----------------------
   Wake Lock
------------------------ */
async function requestWakeLock(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
    }
  }catch(e){}
}
function releaseWakeLock(){
  try{ if(wakeLock){ wakeLock.release(); wakeLock = null; } }catch(e){}
}

/* -----------------------
   Est√§ indexin monistuminen jos se lipsahtaa iframeen
------------------------ */
window.addEventListener("message", (ev)=>{
  if(!ev || !ev.data) return;
  if(ev.data.type === "INDEX_LOADED_IN_IFRAME"){
    // jos jostain syyst√§ index p√§√§tyy iframeen, palautetaan viimeiseen peliin
    toast("Palautetaan peli (index ei saa olla peliruudussa)");
    frame.src = lastGoodPage || 'spider.html';
  }
});

/* -----------------------
   Iframe load guard:
   jos iframe yritt√§√§ ladata index.html, vaihdetaan takaisin peliin
------------------------ */
frame.addEventListener('load', ()=>{
  try{
    const href = frame.contentWindow.location.href || "";
    if(/index\.html/i.test(href)){
      frame.src = lastGoodPage || "spider.html";
      toast("Estetty: index iframeen");
    }
  }catch(e){
    // jos joskus cross-origin, ei p√§√§se lukemaan -> ei haittaa
  }
});

/* -----------------------
   Toast
------------------------ */
function toast(msg, ms=1400){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display='block';
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.style.display='none', ms);
}

/* init */
loadSettings();
startEngine();
</script>
</body>
</html>
