<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Walking Spider Sol ‚Äì Spider / Scorpion / Golf</title>
  <!-- Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>
  <style>
    :root{
      --bg1:#0b3b35;
      --bg2:#08312c;
      --cardW: 52px;
      --cardH: 70px;
      --gap: 6px;
      --stack-gap: 14px;
      --face-down-gap: 3px; /* Piilokorteille tiiviimmin */
      --round: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(255,255,255,.08), transparent 55%),
                  linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#eaf4f2;
      min-height:100vh;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 12px 24px;
    }
    
    /* AdSense containers */
    .ad-top, .ad-bottom, .ad-game {
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 12px;
      margin: 10px 0;
      text-align: center;
      overflow: hidden;
    }
    .ad-top { min-height: 90px; }
    .ad-bottom { min-height: 250px; }
    .ad-game { min-height: 100px; margin: 12px 0; }
    .ad-label {
      font-size: 11px;
      opacity: 0.6;
      padding: 4px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 8px;
      z-index: 10;
      border:1px solid rgba(255,255,255,.08);
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight: 900;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .chips{display:flex;flex-wrap:wrap; gap:8px; justify-content:flex-end}
    .chip{
      padding:10px 12px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      font-weight:800;
      font-size: 13px;
      white-space:nowrap;
    }
    .nav{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 12px;
    }
    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.12);
      color:#eaf4f2;
      font-weight: 900;
      letter-spacing:.2px;
      transition: all 0.2s;
    }
    .btn:hover:not(:disabled) {
      background: rgba(255,255,255,.15);
      transform: translateY(-1px);
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.primary{ background: rgba(120,255,200,.18); }
    .btn.primary:hover:not(:disabled) { background: rgba(120,255,200,.25); }
    .btn.active{
      background: rgba(255,255,255,.16);
      outline: 2px solid rgba(140,255,210,.25);
    }
    .cardBox{
      margin-top: 12px;
      padding: 14px;
      border-radius: var(--round);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(8px);
    }
    .hintBox{
      margin-top: 12px;
      padding: 12px 14px;
      border-radius: var(--round);
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }
    .muted{opacity:.85}
    .small{font-size: 13px; line-height: 1.35}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
    .gameArea{
      margin-top: 12px;
      border-radius: var(--round);
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      padding: 12px;
      overflow: hidden;
    }

    /* --- P√ñYT√Ñ / SARAKKEET --- */
    .table{
      display:grid;
      grid-template-columns: repeat(10, minmax(0, 1fr));
      gap: var(--gap);
      align-items:start;
      width:100%;
    }
    .table.scorpion{ grid-template-columns: repeat(7, minmax(0, 1fr)); }
    .table.golf{ grid-template-columns: repeat(7, minmax(0, 1fr)); }

    .col{
      position:relative;
      border-radius: 16px;
      padding: 8px 6px 10px;
      background: rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.10);
      min-height: calc(var(--cardH) + 60px);
      overflow: hidden;
      cursor: pointer;
      transition: background 0.2s;
    }
    .col:hover {
      background: rgba(0,0,0,.15);
    }
    .colTitle{
      text-align:center;
      font-weight: 900;
      font-size: 12px;
      opacity:.9;
      margin-bottom: 6px;
      white-space:nowrap;
    }
    .topInfo{
      margin-top: 6px;
      text-align:center;
      font-size: 12px;
      font-weight: 900;
      color: rgba(255,255,255,.92);
      text-shadow: 0 2px 14px rgba(0,0,0,.25);
      white-space:nowrap;
    }

    /* --- Kortit --- */
    .stack{
      position:relative;
      width: 100%;
      height: 100%;
      padding-bottom: 8px;
      min-height: calc(var(--cardH) + 10px);
    }
    .k{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      width: var(--cardW);
      height: var(--cardH);
      border-radius: 12px;
      background: #f4f7f6;
      color:#0a0f0f;
      border: 2px solid rgba(0,0,0,.06);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding: 7px 8px;
      user-select:none;
      touch-action: manipulation;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .k:active {
      transform: translateX(-50%) scale(0.98);
    }
    .k.down{
      background: linear-gradient(135deg, rgba(40,120,100,.95), rgba(10,60,50,.95));
      color: rgba(255,255,255,.88);
      border: 2px solid rgba(255,255,255,.10);
    }
    .k.sel{
      outline: 3px solid rgba(255,215,120,.85);
      box-shadow: 0 16px 28px rgba(0,0,0,.35);
      z-index: 10;
    }
    .kr{
      font-weight: 1000;
      font-size: 18px;
      line-height:1;
    }
    .ks{
      font-size: 16px;
      opacity:.95;
      align-self:flex-end;
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      z-index: 999;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.85);
      border: 1px solid rgba(255,255,255,.12);
      color: #fff;
      font-weight: 900;
      max-width: min(92vw, 520px);
      text-align:center;
      box-shadow: 0 18px 44px rgba(0,0,0,.40);
      display:none;
      backdrop-filter: blur(10px);
    }

    .overlay{
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,.70);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      backdrop-filter: blur(5px);
    }
    .modal{
      width: min(520px, 96vw);
      border-radius: 22px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      padding: 16px;
    }
    .modal h2{margin:0 0 8px; font-size: 20px}
    .modal .q{margin:10px 0 8px; font-weight:900}
    .modal .ans{display:flex;flex-wrap:wrap;gap:8px}
    .modal .ans .btn{flex:1 1 auto}
    .footer{
      margin-top: 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      opacity:.9;
    }
    .copyBtn{
      width: 100%;
      padding: 14px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color:#eaf4f2;
      font-weight: 1000;
      cursor:pointer;
      transition: all 0.2s;
    }
    .copyBtn:hover {
      background: rgba(255,255,255,.15);
    }

    /* Deal-napit erikseen */
    .deal-btn {
      background: rgba(255,200,100,.2);
      border-color: rgba(255,200,100,.3);
    }
    .deal-btn:hover:not(:disabled) {
      background: rgba(255,200,100,.3);
    }

    /* Walk lock overlay */
    .walk-lock {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
      padding: 20px;
    }
    .walk-lock.active {
      display: flex;
    }
    .walk-lock h2 {
      font-size: 28px;
      margin-bottom: 20px;
    }
    .walk-lock .timer {
      font-size: 48px;
      font-weight: 900;
      margin: 20px 0;
      color: #b9ffda;
    }

    @media (max-width: 420px){
      :root{ --gap: 4px; --stack-gap: 12px; --face-down-gap: 2px; }
      .chip{font-size:12px}
      .table{ grid-template-columns: repeat(5, minmax(0, 1fr)); }
      .table.scorpion, .table.golf { grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (max-width: 320px){
      :root{ --cardW: 44px; --cardH: 60px; }
    }
  </style>
</head>
<body>
<!-- Walk Lock Overlay -->
<div class="walk-lock" id="walkLock">
  <h2>üö∂ K√§vely k√§ynniss√§</h2>
  <div class="timer" id="walkTimer">00:00</div>
  <p>Pelit lukittu k√§velyn ajaksi. K√§vele rauhassa!</p>
  <button class="btn primary" onclick="stopWalk()">Lopeta k√§vely</button>
</div>

<div class="wrap">

  <!-- AdSense Top -->
  <div class="ad-top">
    <div class="ad-label">Mainos</div>
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
         data-ad-slot="XXXXXXXXXX"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

  <div class="topbar">
    <div class="brand">üï∑Ô∏è Walking Spider Sol</div>
    <div class="chips">
      <div class="chip">üî• Striikki <span id="streak">0</span></div>
      <div class="chip">üéØ Tavoite <span id="goalMin">3</span> min</div>
      <div class="chip">‚úÖ T√§n√§√§n <span id="doneMin">0</span> min</div>
      <div class="chip">k√§vely <b id="walkOk">ei</b></div>
    </div>
  </div>

  <div class="nav">
    <button class="btn active" id="tabWalk">üè† K√§vely</button>
    <button class="btn" id="tabSpider">üï∑Ô∏è Spider</button>
    <button class="btn" id="tabScorpion">ü¶Ç Scorpion</button>
    <button class="btn" id="tabGolf">‚õ≥ Golf</button>
  </div>

  <div class="cardBox" id="walkPanel">
    <h1 style="margin:6px 0 6px;font-size:34px;letter-spacing:-.4px">P√§iv√§n k√§velyvelvoite</h1>
    <div class="muted" style="font-weight:900;margin-bottom:10px">
      Valitse tavoite (3/5/7 min). Kun t√§yt√§t, pelit aukeaa. T√§m√§ on velvoite, ei t√§ydellinen askelmittari.
    </div>
    <div class="controls">
      <button class="btn primary" onclick="setGoal(3)">3 min</button>
      <button class="btn primary" onclick="setGoal(5)">5 min</button>
      <button class="btn primary" onclick="setGoal(7)">7 min</button>
      <button class="btn" onclick="startWalk()" id="startWalkBtn">Aloita k√§vely-tila</button>
      <button class="btn" onclick="stopWalk()" id="stopWalkBtn" disabled>Lopeta</button>
    </div>
    <div class="hintBox small" style="margin-top:12px">
      <b>Vinkki:</b> jos anturit ei toimi (selain), ajastin silti laskee. K√§velytilassa pelit on lukittu.
      <div style="margin-top:8px"><b>Tilanne:</b> tavoite <span id="goalMin2">3</span> min, t√§n√§√§n <span id="doneMin2">0</span> min.</div>
    </div>

    <!-- AdSense in walk panel -->
    <div class="ad-game">
      <div class="ad-label">Mainos</div>
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
           data-ad-slot="XXXXXXXXXX"
           data-ad-format="auto"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>
  </div>

  <div class="cardBox" id="gamePanel" style="display:none">
    <div class="row">
      <div class="muted" style="font-weight:1000">
        Opettaja: <b>ennen siirtoa</b> n√§yt√§n lyhyen vinkin.
      </div>
      <div class="controls">
        <button class="btn primary" id="btnNew">New game</button>
        <button class="btn" id="btnRestart">Restart sama jako</button>
        <button class="btn" id="btnUndo">Undo</button>
        <button class="btn" id="btnRedo">Redo</button>
        <button class="btn deal-btn" id="btnDeal">Deal</button>
      </div>
    </div>

    <div class="hintBox small" id="rulesBox">
      <b>Ohje:</b> Napauta korttia ‚Üí valitset siirrett√§v√§n sarjan. Napauta kohdepinoa ‚Üí siirt√§√§ heti.
    </div>

    <!-- AdSense in game -->
    <div class="ad-game">
      <div class="ad-label">Mainos</div>
      <ins class="adsbygoogle"
           style="display:block"
           data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
           data-ad-slot="XXXXXXXXXX"
           data-ad-format="auto"></ins>
      <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>

    <div class="gameArea">
      <div id="metaRow" class="row small" style="margin-bottom:10px; font-weight:900">
        <div>Siirrot: <span id="moves">0</span></div>
        <div id="metaMid"></div>
        <div id="metaRight"></div>
      </div>

      <div id="table" class="table"></div>

      <div class="footer small">
        <div class="muted">Seed: <span id="seed">0</span></div>
        <div class="muted">Made with stubbornness + walking breaks üíö</div>
      </div>
    </div>

    <button class="copyBtn" id="copyAll">üìã Kopioi t√§m√§ (koko HTML)</button>
  </div>

  <!-- AdSense Bottom -->
  <div class="ad-bottom">
    <div class="ad-label">Mainos</div>
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
         data-ad-slot="XXXXXXXXXX"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
  </div>

</div>

<div class="toast" id="toast"></div>

<div class="overlay" id="overlay">
  <div class="modal">
    <h2>üß† Tauko-kysymykset</h2>
    <div class="small muted">Lyhyt check-in k√§velyn/tauon j√§lkeen. Valitse vain, ei tarvitse kirjoittaa.</div>

    <div class="q">1) Onko ollut hyv√§ p√§iv√§?</div>
    <div class="ans">
      <button class="btn primary" onclick="pickAns(1,'Juu')">Juu</button>
      <button class="btn" onclick="pickAns(1,'ei')">ei</button>
    </div>

    <div class="q">2) Miten tauko meni?</div>
    <div class="ans">
      <button class="btn primary" onclick="pickAns(2,'kivaa')">kivaa</button>
      <button class="btn" onclick="pickAns(2,'ihan ok')">ihan ok</button>
      <button class="btn" onclick="pickAns(2,'tyhm√§√§')">tyhm√§√§</button>
    </div>

    <div class="q">3) Saitko jotain ajatuksia mieleen?</div>
    <div class="ans">
      <button class="btn primary" onclick="pickAns(3,'paras idea')">paras idea</button>
      <button class="btn" onclick="pickAns(3,'ajatukset rullasi')">ajatukset rullasi</button>
      <button class="btn" onclick="pickAns(3,'tarttee kelata')">tarttee kelata</button>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
      <button class="btn" onclick="closeOverlay()">Sulje</button>
    </div>
  </div>
</div>

<script>
/* ==================== Utilities ==================== */
const $ = (id)=>document.getElementById(id);
const LS = {
  get(k, d){ try{ const v = localStorage.getItem(k); return v==null? d: JSON.parse(v);}catch(e){return d;} },
  set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
};

function nowDateISO(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function toast(msg, ms=1600){
  const t=$('toast');
  t.textContent=msg;
  t.style.display='block';
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.style.display='none', ms);
}

function rand32(seed){
  let a = seed >>> 0;
  return function(){
    a |= 0; a = a + 0x6D2B79F5 | 0;
    let t = Math.imul(a ^ a >>> 15, 1 | a);
    t ^= t + Math.imul(t ^ t >>> 7, 61 | t);
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}

function rankToStr(r){
  return r===1?'A':r===11?'J':r===12?'Q':r===13?'K':String(r);
}

function canAdj(a,b){
  if(a===1 && b===13) return true;
  if(a===13 && b===1) return true;
  return Math.abs(a-b)===1;
}

function formatTime(sec){
  const m = Math.floor(sec/60);
  const s = sec%60;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

/* ==================== Responsive cards ==================== */
function fitCards(){
  const table = $('table');
  const isScorpion = table.classList.contains('scorpion');
  const isGolf = table.classList.contains('golf');
  const cols = isScorpion || isGolf ? 7 : 10;

  const area = table.getBoundingClientRect().width;
  const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 6;
  const totalGaps = gap * (cols-1);
  let cw = Math.floor((area - totalGaps - 20) / cols);
  cw = Math.max(34, Math.min(62, cw));
  const ch = Math.round(cw * 1.36);

  document.documentElement.style.setProperty('--cardW', cw+'px');
  document.documentElement.style.setProperty('--cardH', ch+'px');
}
window.addEventListener('resize', ()=>{ fitCards(); render(); });

/* ==================== Walking System ==================== */
const walk = {
  date: '',
  goal: 3,
  doneSec: 0,
  running: false,
  timer: null,
};

function refreshDay(){
  const today = nowDateISO();
  if(walk.date !== today){
    walk.date = today;
    walk.doneSec = LS.get('walk.doneSec_'+today, 0);
    walk.running = false;
    if(walk.timer) clearInterval(walk.timer);
    walk.timer = null;
    LS.set('walk.date', today);
  }
}

function setGoal(m){
  walk.goal = m;
  LS.set('walk.goal', walk.goal);
  updateWalkUI();
  toast(`Tavoite asetettu: ${m} min`);
}

function startWalk(){
  refreshDay();
  if(walk.running) return;
  
  walk.running = true;
  walk.timer = setInterval(()=>{
    walk.doneSec++;
    LS.set('walk.doneSec_'+walk.date, walk.doneSec);
    updateWalkUI();
    
    if(walk.doneSec >= walk.goal*60){
      stopWalk(true);
    }
  }, 1000);
  
  updateWalkUI();
  toast("K√§vely-tila p√§√§ll√§ ‚úÖ");
}

function stopWalk(auto=false){
  if(walk.timer) clearInterval(walk.timer);
  walk.timer = null;
  walk.running = false;
  updateWalkUI();
  
  if(auto){
    toast("Tavoite t√§ynn√§! Pelit auki ‚úÖ", 2000);
    maybeUpdateStreak();
    openOverlay();
  } else {
    toast("K√§vely-tila pois");
  }
}

function walkOK(){
  refreshDay();
  return walk.doneSec >= walk.goal*60;
}

function updateWalkUI(){
  const doneMin = Math.floor(walk.doneSec/60);
  $('goalMin').textContent = walk.goal;
  $('goalMin2').textContent = walk.goal;
  $('doneMin').textContent = doneMin;
  $('doneMin2').textContent = doneMin;
  $('walkOk').textContent = walkOK() ? 'kyll√§' : 'ei';
  $('walkOk').style.color = walkOK() ? '#b9ffda' : '#ffd1a8';
  
  // Timer display
  $('walkTimer').textContent = formatTime(walk.doneSec);
  
  // Buttons
  $('startWalkBtn').disabled = walk.running;
  $('stopWalkBtn').disabled = !walk.running;
  
  // Lock overlay
  $('walkLock').classList.toggle('active', walk.running);
  
  // Streak
  const streak = LS.get('walk.streak', 0);
  $('streak').textContent = streak;
  
  // Gate check
  if(activeTab !== 'walk' && !walkOK()){
    setActiveTab('walk');
    toast("Tee k√§vely ensin (3/5/7 min), sitten pelit aukeaa.");
  }
}

function maybeUpdateStreak(){
  const today = nowDateISO();
  const doneDay = LS.get('walk.doneDay', '');
  if(walkOK() && doneDay !== today){
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
    const yISO = `${yesterday.getFullYear()}-${String(yesterday.getMonth()+1).padStart(2,'0')}-${String(yesterday.getDate()).padStart(2,'0')}`;
    const lastDone = LS.get('walk.lastDone', '');
    let streak = LS.get('walk.streak', 0);
    if(lastDone === yISO) streak++;
    else streak = 1;
    LS.set('walk.streak', streak);
    LS.set('walk.lastDone', today);
    LS.set('walk.doneDay', today);
    $('streak').textContent = streak;
  }
}

/* ==================== Overlay ==================== */
function openOverlay(){
  $('overlay').style.display='flex';
}
function closeOverlay(){
  $('overlay').style.display='none';
}
function pickAns(q, val){
  LS.set('break.q'+q, val);
  toast(`Tallennettu: ${val}`);
}

/* ==================== Tabs ==================== */
let activeTab = 'walk';
function setActiveTab(which){
  if(walk.running && which !== 'walk'){
    toast("Lopeta k√§vely ensin!");
    return;
  }
  
  activeTab = which;
  ['Walk','Spider','Scorpion','Golf'].forEach(t=>{
    $(`tab${t}`).classList.toggle('active', which===t.toLowerCase());
  });
  
  $('walkPanel').style.display = (which==='walk') ? 'block' : 'none';
  $('gamePanel').style.display = (which==='walk') ? 'none' : 'block';
  
  if(which !== 'walk'){
    ensureGame(which);
  }
  render();
}

$('tabWalk').onclick = ()=>setActiveTab('walk');
$('tabSpider').onclick = ()=>{ if(!walkOK()){ toast("Tee k√§vely ensin."); return; } setActiveTab('spider'); };
$('tabScorpion').onclick = ()=>{ if(!walkOK()){ toast("Tee k√§vely ensin."); return; } setActiveTab('scorpion'); };
$('tabGolf').onclick = ()=>{ if(!walkOK()){ toast("Tee k√§vely ensin."); return; } setActiveTab('golf'); };

/* ==================== History ==================== */
const hist = {
  undo: [],
  redo: [],
  push(state){
    // Deep clone state
    const clone = JSON.parse(JSON.stringify(state));
    this.undo.push(clone);
    if(this.undo.length>50) this.undo.shift();
    this.redo.length=0;
  },
  canUndo(){return this.undo.length>0},
  canRedo(){return this.redo.length>0},
  popUndo(){
    if(!this.canUndo()) return null;
    const current = getStateObj();
    if(current) this.redo.push(JSON.parse(JSON.stringify(current)));
    return this.undo.pop();
  },
  popRedo(){
    if(!this.canRedo()) return null;
    const current = getStateObj();
    if(current) this.undo.push(JSON.parse(JSON.stringify(current)));
    return this.redo.pop();
  }
};

/* ==================== Game State ==================== */
let seed = LS.get('seed', Math.floor(Math.random()*1e9));
function setSeed(s){
  seed = s>>>0;
  LS.set('seed', seed);
  $('seed').textContent = seed;
}
setSeed(seed);

let moves = 0;

/* ---------- Spider ---------- */
const spider = {
  state: null,
  sel: null,
  
  init(seedVal){
    const rnd = rand32(seedVal);
    let deck=[];
    for(let copy=0; copy<8; copy++){
      for(let r=1;r<=13;r++) deck.push({r, s:'‚ô†', face:false});
    }
    for(let i=deck.length-1;i>0;i--){
      const j = Math.floor(rnd()*(i+1));
      [deck[i],deck[j]]=[deck[j],deck[i]];
    }
    
    const cols = Array.from({length:10},()=>[]);
    for(let c=0;c<10;c++){
      const n = (c<4)?6:5;
      for(let k=0;k<n;k++){
        const card = deck.pop();
        card.face = (k===n-1);
        cols[c].push(card);
      }
    }
    
    this.state = {
      mode:'spider', 
      cols, 
      stock: deck, 
      foundations:0, 
      seed:seedVal, 
      moves:0
    };
    this.sel = null;
  },
  
  selectableSeq(col, idx){
    if(idx<0 || idx>=col.length) return false;
    if(!col[idx].face) return false;
    for(let i=idx;i<col.length-1;i++){
      if(!col[i+1].face) return false;
      if(col[i].r !== col[i+1].r+1) return false;
    }
    return true;
  },
  
  tryMove(fromC, fromIdx, toC){
    if(fromC===toC) return false;
    const from = this.state.cols[fromC];
    const to = this.state.cols[toC];
    
    if(!this.selectableSeq(from, fromIdx)) return false;
    const moving = from.slice(fromIdx);
    const topTo = to[to.length-1];
    
    if(topTo && topTo.r !== moving[0].r+1) return false;
    
    // Execute
    hist.push(this.state);
    this.state.cols[toC] = to.concat(moving);
    this.state.cols[fromC] = from.slice(0, fromIdx);
    
    const nf = this.state.cols[fromC];
    if(nf.length && !nf[nf.length-1].face){
      nf[nf.length-1].face = true;
    }
    
    this.state.moves++;
    moves = this.state.moves;
    this.sel = null;
    this.sweepFoundations();
    return true;
  },
  
  sweepFoundations(){
    let removed = 0;
    for(let c=0;c<10;c++){
      const col = this.state.cols[c];
      if(col.length<13) continue;
      const start = col.length-13;
      let ok=true;
      for(let i=0;i<13;i++){
        const card = col[start+i];
        if(!card.face || card.r !== 13-i){ ok=false; break; }
      }
      if(ok){
        col.splice(start,13);
        removed++;
        if(col.length && !col[col.length-1].face) col[col.length-1].face=true;
      }
    }
    if(removed){
      this.state.foundations += removed;
      toast(`üèÅ Valmis sarja poistettu! (+${removed})`);
    }
  },
  
  deal10(){
    if(this.state.stock.length<10){
      toast("Stock tyhj√§");
      return false;
    }
    hist.push(this.state);
    for(let c=0;c<10;c++){
      const card = this.state.stock.pop();
      card.face = true;
      this.state.cols[c].push(card);
    }
    this.state.moves++;
    moves = this.state.moves;
    this.sel = null;
    return true;
  }
};

/* ---------- Scorpion ---------- */
const scorpion = {
  state:null,
  sel:null,
  
  init(seedVal){
    const rnd = rand32(seedVal);
    let deck=[];
    const suits=['‚ô†','‚ô•','‚ô¶','‚ô£'];
    for(const s of suits){
      for(let r=1;r<=13;r++) deck.push({r,s,face:true});
    }
    for(let i=deck.length-1;i>0;i--){
      const j=Math.floor(rnd()*(i+1));
      [deck[i],deck[j]]=[deck[j],deck[i]];
    }
    
    const cols = Array.from({length:7},()=>[]);
    for(let c=0;c<7;c++){
      for(let k=0;k<7;k++){
        cols[c].push(deck.pop());
      }
    }
    for(let c=0;c<4;c++){
      for(let k=0;k<3;k++) cols[c][k].face=false;
    }
    
    this.state={mode:'scorpion', cols, stock: deck, moves:0, seed:seedVal};
    this.sel=null;
  },
  
  selectableSeq(col, idx){
    if(idx<0||idx>=col.length) return false;
    return col[idx].face;
  },
  
  tryMove(fromC, fromIdx, toC){
    if(fromC===toC) return false;
    const from=this.state.cols[fromC], to=this.state.cols[toC];
    if(!this.selectableSeq(from, fromIdx)) return false;
    
    const moving = from.slice(fromIdx);
    const topTo = to[to.length-1];
    
    if(topTo){
      if(topTo.s !== moving[0].s) return false;
      if(topTo.r !== moving[0].r + 1) return false;
    }
    
    hist.push(this.state);
    this.state.cols[toC]=to.concat(moving);
    this.state.cols[fromC]=from.slice(0,fromIdx);
    
    const nf=this.state.cols[fromC];
    if(nf.length && !nf[nf.length-1].face) nf[nf.length-1].face=true;
    
    this.state.moves++; moves=this.state.moves;
    this.sel=null;
    return true;
  },
  
  deal3(){
    if(this.state.stock.length<3){
      toast("Stock tyhj√§");
      return false;
    }
    hist.push(this.state);
    for(let c=0;c<3;c++){
      const card=this.state.stock.pop();
      card.face=true;
      this.state.cols[c].push(card);
    }
    this.state.moves++; moves=this.state.moves;
    this.sel=null;
    return true;
  }
};

/* ---------- Golf ---------- */
const golf = {
  state:null,
  
  init(seedVal){
    const rnd=rand32(seedVal);
    let deck=[];
    const suits=['‚ô†','‚ô•','‚ô¶','‚ô£'];
    for(const s of suits){
      for(let r=1;r<=13;r++) deck.push({r,s,face:true});
    }
    for(let i=deck.length-1;i>0;i--){
      const j=Math.floor(rnd()*(i+1));
      [deck[i],deck[j]]=[deck[j],deck[i]];
    }
    
    const cols=Array.from({length:7},()=>[]);
    for(let row=0;row<5;row++){
      for(let c=0;c<7;c++){
        cols[c].push(deck.pop());
      }
    }
    
    this.state={
      mode:'golf', 
      cols, 
      stock:deck, 
      waste:[deck.pop()], 
      moves:0, 
      seed:seedVal
    };
  },
  
  moveFromCol(c){
    const col=this.state.cols[c];
    if(!col.length) return false;
    const card=col[col.length-1];
    const top=this.state.waste[this.state.waste.length-1];
    
    if(!canAdj(top.r, card.r)) return false;
    
    hist.push(this.state);
    this.state.waste.push(col.pop());
    this.state.moves++; moves=this.state.moves;
    
    if(this.cleared()){
      setTimeout(()=>toast("üèÅ Golf: Voitit! Kaikki kortit poistettu!", 3000), 100);
    }
    return true;
  },
  
  draw(){
    if(!this.state.stock.length){
      toast("Stock tyhj√§");
      return false;
    }
    hist.push(this.state);
    this.state.waste.push(this.state.stock.pop());
    this.state.moves++; moves=this.state.moves;
    return true;
  },
  
  cleared(){
    return this.state.cols.every(c=>c.length===0);
  }
};

/* ==================== Rendering ==================== */
function getStateObj(){
  if(activeTab==='spider') return spider.state;
  if(activeTab==='scorpion') return scorpion.state;
  if(activeTab==='golf') return golf.state;
  return null;
}

function setStateObj(obj){
  if(!obj) return;
  if(obj.mode==='spider'){ spider.state=obj; spider.sel=null; }
  if(obj.mode==='scorpion'){ scorpion.state=obj; scorpion.sel=null; }
  if(obj.mode==='golf'){ golf.state=obj; }
  moves = obj.moves || 0;
}

function teacherHint(mode){
  if(mode==='spider') return "üß† Vihje: Rakenna laskevia sarjoja (K‚ÜíA). Tyhj√§√§n pinoon saa siirt√§√§!";
  if(mode==='scorpion') return "üß† Vihje: Sama maa + yksi isompi p√§√§lle. Klikkaa korttia, sitten kohdepinoa.";
  if(mode==='golf') return "üß† Vihje: Ota kortti jos se on ¬±1 j√§tteest√§ (A‚ÜîK sallittu).";
  return "";
}

function render(){
  refreshDay();
  updateWalkUI();
  
  if(activeTab==='walk') return;
  if(!walkOK()){
    setActiveTab('walk');
    return;
  }
  
  $('moves').textContent = moves;
  
  const table=$('table');
  table.innerHTML='';
  table.className = 'table ' + activeTab;
  
  fitCards();
  
  // Meta info
  const st = getStateObj();
  if(activeTab==='spider'){
    $('metaMid').textContent = `üèÅ Maat: ${spider.state.foundations}/8`;
    $('metaRight').textContent = `üì¶ Stock: ${spider.state.stock.length}`;
  }else if(activeTab==='scorpion'){
    $('metaMid').textContent = `üì¶ Stock: ${scorpion.state.stock.length}`;
    $('metaRight').textContent = `Siirr√§ sama maa +1`;
  }else if(activeTab==='golf'){
    $('metaMid').textContent = `üì¶ Stock: ${golf.state.stock.length}`;
    const top=golf.state.waste[golf.state.waste.length-1];
    $('metaRight').textContent = `üóëÔ∏è J√§te: ${rankToStr(top.r)}${top.s}`;
  }
  
  // Buttons
  $('btnUndo').disabled = !hist.canUndo();
  $('btnRedo').disabled = !hist.canRedo();
  
  // Deal button visibility
  const dealBtn = $('btnDeal');
  if(activeTab==='spider'){
    dealBtn.textContent = `Deal 10 (${spider.state?.stock?.length||0})`;
    dealBtn.onclick = ()=>{ if(spider.deal10()) render(); };
  }else if(activeTab==='scorpion'){
    dealBtn.textContent = `Deal 3 (${scorpion.state?.stock?.length||0})`;
    dealBtn.onclick = ()=>{ if(scorpion.deal3()) render(); };
  }else if(activeTab==='golf'){
    dealBtn.textContent = `Nosta (${golf.state?.stock?.length||0})`;
    dealBtn.onclick = ()=>{ if(golf.draw()) render(); };
  }
  
  // Rules
  if(activeTab==='spider'){
    $('rulesBox').innerHTML = `<b>Spider:</b> ${teacherHint('spider')}<br><span class="muted">Kortit p√§√§llekk√§in, yl√§reunat n√§kyviss√§.</span>`;
  }else if(activeTab==='scorpion'){
    $('rulesBox').innerHTML = `<b>Scorpion:</b> ${teacherHint('scorpion')}<br><span class="muted">Tyhj√§√§n pinoon saa siirt√§√§.</span>`;
  }else if(activeTab==='golf'){
    $('rulesBox').innerHTML = `<b>Golf:</b> ${teacherHint('golf')}<br><span class="muted">Vain pinon p√§√§llimm√§inen pelattavissa.</span>`;
  }
  
  // Render columns
  if(activeTab==='spider'){
    for(let c=0;c<10;c++) table.appendChild(renderColSpider(c));
  }else if(activeTab==='scorpion'){
    for(let c=0;c<7;c++) table.appendChild(renderColScorpion(c));
  }else if(activeTab==='golf'){
    for(let c=0;c<7;c++) table.appendChild(renderColGolf(c));
  }
  
  $('seed').textContent = seed;
}

function renderColSpider(ci){
  const st=spider.state;
  const col=st.cols[ci];
  const colDiv=document.createElement('div');
  colDiv.className='col';
  
  const title=document.createElement('div');
  title.className='colTitle';
  title.textContent=`${ci+1}`;
  colDiv.appendChild(title);
  
  const stack=document.createElement('div');
  stack.className='stack';
  
  // Calculate positions
  let faceDownCount = 0;
  let faceUpStart = 0;
  
  for(let i=0;i<col.length;i++){
    if(!col[i].face){
      faceDownCount++;
    }else{
      faceUpStart = i;
      break;
    }
  }
  
  for(let i=0;i<col.length;i++){
    const card=col[i];
    const el=document.createElement('div');
    el.className='k' + (card.face?'':' down');
    
    if(spider.sel && spider.sel.col===ci && i>=spider.sel.idx){
      el.classList.add('sel');
    }
    
    // Position: face-down cards closer together, face-up with normal gap
    let topPos;
    if(!card.face){
      topPos = i * parseFloat(getCSS('--face-down-gap'));
    }else{
      const fd = Math.min(i, faceUpStart);
      const fu = i - fd;
      topPos = fd * parseFloat(getCSS('--face-down-gap')) + fu * parseFloat(getCSS('--stack-gap'));
    }
    el.style.top = topPos + 'px';
    
    if(card.face){
      el.innerHTML = `<div class="kr">${rankToStr(card.r)}</div><div class="ks">${card.s}</div>`;
      el.onclick = (e)=>{
        e.stopPropagation();
        if(spider.sel && spider.sel.col===ci){
          spider.sel=null;
          toast("Valinta poistettu");
        }else if(spider.selectableSeq(col, i)){
          spider.sel={col:ci, idx:i};
          toast(teacherHint('spider'), 1500);
        }else{
          toast("Ei siirrett√§v√§ sarja");
        }
        render();
      };
    }else{
      el.onclick = (e)=>{ e.stopPropagation(); toast("Piilokortti"); };
    }
    stack.appendChild(el);
  }
  
  colDiv.onclick = ()=>{
    if(spider.sel && spider.sel.col!==ci){
      const ok = spider.tryMove(spider.sel.col, spider.sel.idx, ci);
      if(!ok) toast("Ei voi siirt√§√§ tuohon");
      render();
    }
  };
  
  colDiv.appendChild(stack);
  
  const top = col.filter(c=>c.face).pop();
  const info=document.createElement('div');
  info.className='topInfo';
  info.textContent = top ? `${rankToStr(top.r)}${top.s}` : '‚Äî';
  colDiv.appendChild(info);
  
  return colDiv;
}

function renderColScorpion(ci){
  const st=scorpion.state;
  const col=st.cols[ci];
  const colDiv=document.createElement('div');
  colDiv.className='col';
  
  const title=document.createElement('div');
  title.className='colTitle';
  title.textContent=`${ci+1}`;
  colDiv.appendChild(title);
  
  const stack=document.createElement('div');
  stack.className='stack';
  
  let faceDownCount = 0;
  for(let i=0;i<col.length;i++){
    if(!col[i].face) faceDownCount = i+1;
  }
  
  for(let i=0;i<col.length;i++){
    const card=col[i];
    const el=document.createElement('div');
    el.className='k' + (card.face?'':' down');
    
    if(scorpion.sel && scorpion.sel.col===ci && i>=scorpion.sel.idx){
      el.classList.add('sel');
    }
    
    let topPos;
    if(!card.face){
      topPos = i * parseFloat(getCSS('--face-down-gap'));
    }else{
      const fd = Math.min(i, faceDownCount);
      const fu = i - fd;
      topPos = fd * parseFloat(getCSS('--face-down-gap')) + fu * parseFloat(getCSS('--stack-gap'));
    }
    el.style.top = topPos + 'px';
    
    if(card.face){
      el.innerHTML = `<div class="kr">${rankToStr(card.r)}</div><div class="ks">${card.s}</div>`;
      el.onclick = (e)=>{
        e.stopPropagation();
        if(scorpion.sel && scorpion.sel.col===ci){
          scorpion.sel=null;
          toast("Valinta poistettu");
        }else{
          scorpion.sel={col:ci, idx:i};
          toast(teacherHint('scorpion'), 1500);
        }
        render();
      };
    }else{
      el.onclick = (e)=>{ e.stopPropagation(); toast("Piilokortti"); };
    }
    stack.appendChild(el);
  }
  
  colDiv.onclick = ()=>{
    if(scorpion.sel && scorpion.sel.col!==ci){
      const ok=scorpion.tryMove(scorpion.sel.col, scorpion.sel.idx, ci);
      if(!ok) toast("Ei voi siirt√§√§ tuohon");
      render();
    }
  };
  
  colDiv.appendChild(stack);
  
  const top = col.filter(c=>c.face).pop();
  const info=document.createElement('div');
  info.className='topInfo';
  info.textContent = top ? `${rankToStr(top.r)}${top.s}` : '‚Äî';
  colDiv.appendChild(info);
  
  return colDiv;
}

function renderColGolf(ci){
  const st=golf.state;
  const col=st.cols[ci];
  const colDiv=document.createElement('div');
  colDiv.className='col';
  
  const title=document.createElement('div');
  title.className='colTitle';
  title.textContent=`${ci+1}`;
  colDiv.appendChild(title);
  
  const stack=document.createElement('div');
  stack.className='stack';
  
  for(let i=0;i<col.length;i++){
    const card=col[i];
    const el=document.createElement('div');
    el.className='k';
    el.style.top = (i * parseFloat(getCSS('--stack-gap'))) + 'px';
    el.innerHTML = `<div class="kr">${rankToStr(card.r)}</div><div class="ks">${card.s}</div>`;
    
    if(i===col.length-1){
      el.onclick = (e)=>{
        e.stopPropagation();
        toast(teacherHint('golf'), 1200);
        const ok = golf.moveFromCol(ci);
        if(!ok) toast("Ei ole ¬±1 j√§tteest√§");
        render();
      };
      el.style.cursor = 'pointer';
    }else{
      el.style.opacity = '0.7';
    }
    stack.appendChild(el);
  }
  
  colDiv.appendChild(stack);
  
  const top = col[col.length-1];
  const info=document.createElement('div');
  info.className='topInfo';
  info.textContent = top ? `${rankToStr(top.r)}${top.s}` : '‚Äî';
  colDiv.appendChild(info);
  
  return colDiv;
}

function getCSS(name){
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '0';
}

/* ==================== Game Control ==================== */
function ensureGame(mode){
  if(mode==='spider' && !spider.state) startGame('spider', false);
  if(mode==='scorpion' && !scorpion.state) startGame('scorpion', false);
  if(mode==='golf' && !golf.state) startGame('golf', false);
}

function startGame(mode, newSeed){
  hist.undo.length=0;
  hist.redo.length=0;
  
  if(newSeed){
    setSeed(Math.floor(Math.random()*1e9));
  }
  
  if(mode==='spider'){
    spider.init(seed);
    moves = 0;
  }else if(mode==='scorpion'){
    scorpion.init(seed);
    moves = 0;
  }else if(mode==='golf'){
    golf.init(seed);
    moves = 0;
  }
  
  render();
}

$('btnNew').onclick = ()=>{
  startGame(activeTab, true);
};

$('btnRestart').onclick = ()=>{
  startGame(activeTab, false);
};

$('btnUndo').onclick = ()=>{
  const prev = hist.popUndo();
  if(prev){
    setStateObj(prev);
    render();
  }else{
    toast("Ei undo");
  }
};

$('btnRedo').onclick = ()=>{
  const nxt = hist.popRedo();
  if(nxt){
    setStateObj(nxt);
    render();
  }else{
    toast("Ei redo");
  }
};

$('copyAll').onclick = async ()=>{
  try{
    await navigator.clipboard.writeText(document.documentElement.outerHTML);
    toast("Koko HTML kopioitu ‚úÖ");
  }catch(e){
    toast("Kopiointi ep√§onnistui");
  }
};

/* ==================== Init ==================== */
refreshDay();
walk.goal = LS.get('walk.goal', 3);
updateWalkUI();

if(walkOK()){
  setActiveTab('spider');
  startGame('spider', false);
}else{
  setActiveTab('walk');
}
</script>
</body>
</html>
