<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Walking Spider Sol</title>

  <!-- AdSense (Auto Ads). Pid√§ client omana. -->
  <script async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7652525244986434"
    crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b5f52;
      --bg2:#074c42;
      --card:#ffffff;
      --txt:#10211e;
      --muted:#5b6f6b;
      --line:#dbe5e3;
      --btn:#0b5f52;
      --btn2:#1f8b63;
      --shadow:0 10px 26px rgba(0,0,0,.22);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg2),var(--bg));
      color:#fff;
    }
    .wrap{max-width:820px;margin:0 auto;padding:14px 14px 24px}
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom:10px;
    }
    .brand{font-weight:1000;letter-spacing:.2px;font-size:18px}
    .pillrow{display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;text-decoration:none;font-weight:900;
      backdrop-filter: blur(6px);
      user-select:none;
    }
    .pill:active{transform:scale(.98)}
    .card{
      background:var(--card); color:var(--txt);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px; margin:12px 0;
    }
    h1{margin:6px 0 8px;font-size:34px;letter-spacing:-.5px}
    h2{margin:0 0 10px;font-size:22px;letter-spacing:-.3px}
    p{margin:8px 0;line-height:1.6}
    .small{font-size:13px;color:var(--muted);line-height:1.45}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1;min-width:220px}
    .btn{
      width:100%;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:14px 14px;border-radius:16px;border:0;
      background:var(--btn);color:#fff;font-size:16px;font-weight:1000;
      cursor:pointer;
      user-select:none;
    }
    .btn.secondary{background:#2a6f62}
    .btn.green{background:var(--btn2)}
    .btn.ghost{
      background:transparent;color:var(--btn);
      border:2px solid var(--line);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:active{transform:scale(.99)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      background:#eafff5;border:1px solid #cbe9df;
      color:#0b5f52;
      padding:6px 10px;border-radius:999px;
      font-weight:1000;font-size:13px;
    }
    .kpi{
      display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between
    }
    .big{
      font-size:58px;font-weight:1100;line-height:1;margin:0;color:#0b5f52;
      letter-spacing:-1px;
    }
    .mono{font-variant-numeric:tabular-nums}
    .progress{
      height:12px;border-radius:999px;background:#e8f4f1;border:1px solid #d3ebe5;overflow:hidden;
      margin:10px 0 2px;
    }
    .bar{height:100%;width:0%;background:#38a169}
    .adbox{
      background:rgba(11,95,82,.08);
      border:2px dashed rgba(11,95,82,.25);
      color:rgba(11,95,82,.85);
      border-radius:16px;
      padding:14px;
      text-align:center;
      font-weight:1000;
    }

    /* Overlay: liike-tila */
    .overlay{
      position:fixed;inset:0;
      display:none;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index:9999;
      padding:14px;
    }
    .overlay.show{display:block}
    .ovcard{
      max-width:820px;margin:0 auto;
      background:rgba(20,20,20,.72);
      border:1px solid rgba(255,255,255,.15);
      border-radius:22px;
      padding:16px;
      color:#fff;
      box-shadow:0 18px 44px rgba(0,0,0,.35);
    }
    .ovtitle{font-size:30px;font-weight:1100;margin:0 0 6px}
    .ovmuted{opacity:.9;margin:0 0 14px}
    .timer{font-size:64px;font-weight:1100;letter-spacing:-1px;margin:0}
    .ovgrid{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .hintbox{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:12px;
      margin-top:12px;
    }
    .longpress{
      display:inline-flex;align-items:center;justify-content:center;
      width:100%;
      padding:14px 14px;
      border-radius:16px;border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.08);
      color:#fff;font-size:16px;font-weight:1100;
      user-select:none;
    }
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.78);color:#fff;
      padding:10px 12px;border-radius:999px;
      font-weight:1000;font-size:13px;
      display:none;z-index:10000;
      border:1px solid rgba(255,255,255,.14)
    }
    .toast.show{display:block}

    /* Modal: tietosuoja */
    .modal{
      position:fixed; inset:0;
      display:none; z-index:10001;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      padding:14px;
    }
    .modal.show{display:block}
    .modalCard{
      max-width:820px;margin:0 auto;
      background:#fff;color:var(--txt);
      border-radius:22px;
      box-shadow:0 18px 44px rgba(0,0,0,.35);
      padding:16px;
    }
    .modalTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .xbtn{
      border:0;background:#0b5f52;color:#fff;font-weight:1100;
      padding:10px 12px;border-radius:999px;cursor:pointer
    }
    .xbtn:active{transform:scale(.99)}
    ul{padding-left:18px}
    li{margin:6px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">Walking Spider Sol</div>
      <div class="pillrow">
        <!-- BLOGI-NAPPI POIS. Tietosuoja aukeaa modaalina, ei vie etusivulle. -->
        <div class="pill" id="openPrivacy">Tietosuoja</div>
      </div>
    </div>

    <!-- Mainospaikka A (etusivu) -->
    <div class="card" id="adA">
      <div class="adbox">Auto Ads ‚Äì paikka A (etusivu)</div>
    </div>

    <div class="card">
      <h1>üëü P√§iv√§n tavoite</h1>
      <p style="margin-top:0">Tavoite mitataan <b>minuutteina</b>. Kun tavoite t√§yttyy, Spider aukeaa.</p>

      <div class="row">
        <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:0">
          <h2 style="margin-top:0">Valitse tavoite</h2>
          <div class="row" style="margin-top:8px">
            <button class="btn secondary" id="goal3">3 min</button>
            <button class="btn secondary" id="goal5">5 min</button>
            <button class="btn secondary" id="goal7">7 min</button>
          </div>
          <p class="small" id="goalText" style="margin-top:10px"></p>
        </div>

        <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:0">
          <div class="kpi">
            <div>
              <div class="small">P√§iv√§</div>
              <div class="tag mono" id="todayTag">‚Äî</div>
            </div>
            <div style="text-align:right">
              <div class="small">Striikki</div>
              <div class="tag">üî• <span class="mono" id="streak">0</span></div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="kpi">
            <div>
              <div class="small">T√§n√§√§n tehty</div>
              <div class="big mono"><span id="doneMin">0</span> min</div>
            </div>
            <div style="text-align:right">
              <div class="small">Tavoite</div>
              <div class="tag mono"><span id="goalMin">5</span> min</div>
            </div>
          </div>

          <div class="progress">
            <div class="bar" id="bar"></div>
          </div>
          <div class="small" id="statusLine">‚Äî</div>

          <div style="height:12px"></div>
          <button class="btn" id="startMove">Aloita liike-tila</button>
          <div style="height:10px"></div>
          <button class="btn green" id="openSpider" disabled>üï∑Ô∏è Avaa Spider (uusi v√§lilehti)</button>
          <p class="small" style="margin-top:10px">Vinkki: tee p√§iv√§n liike ensin. Sitten avaa Spider.</p>
        </div>
      </div>
    </div>

    <!-- OPETUS (n√§kyy selke√§sti omana osiona) -->
    <div class="card" id="lessonCard">
      <h2>üéß Opetus</h2>
      <p class="small" style="margin-top:-2px">
        T√§ss√§ on <b>5 miniopetusta</b> Spideriin. Ne aukeavat kun p√§iv√§n liike on tehty (reilu palkinto).
      </p>
      <button class="btn green" id="playLesson" disabled>Kuuntele minioppi (1/5)</button>
      <div style="height:10px"></div>
      <button class="btn secondary" id="nextTip" disabled>N√§yt√§ ‚Äúseuraava tavoite‚Äù</button>

      <div class="card" id="lessonBox" style="display:none;box-shadow:none;border:1px solid var(--line);margin:12px 0 0">
        <div class="tag" id="lessonTitle">Minioppi</div>
        <p id="lessonText" style="font-weight:1000;margin:10px 0 0;line-height:1.65"></p>
        <p class="small" id="lessonGoal" style="margin-top:10px"></p>
      </div>
    </div>

    <!-- Kierros valmis -->
    <div class="card">
      <h2>üèÅ Kierros valmis</h2>
      <p class="small" style="margin-top:-2px">
        Kun olet pelannut kierroksen, paina t√§st√§. Saat ‚Äúmit√§ opittiin‚Äù + halutessa kuuntelet miniopin.
      </p>
      <div class="row">
        <button class="btn green" id="finishWin" disabled>üëë Voitin kierroksen</button>
        <button class="btn secondary" id="finishLoss" disabled>üí™ H√§visin / keskeytin</button>
      </div>
      <p class="small" id="finishHint" style="margin-top:10px"></p>
    </div>

    <!-- Mainospaikka B (piilossa liike-tilassa, n√§kyy etusivulla muuten) -->
    <div class="card" id="adB">
      <div class="adbox">Auto Ads ‚Äì paikka B (ennen/j√§lkeen oppihetken)</div>
    </div>

    <div class="card" id="postGame" style="display:none">
      <h2 id="pgTitle" style="margin-top:0">Kierros valmis</h2>

      <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:12px 0 10px">
        <div style="font-weight:1100;margin-bottom:8px">üß† Mit√§ opittiin t√§ll√§ kierroksella</div>
        <div style="line-height:1.7">
          <div id="pgLine1">‚Äî</div>
          <div id="pgLine2">‚Äî</div>
        </div>
      </div>

      <div class="row">
        <button class="btn green" id="pgListen" disabled>üéß Kuuntele minioppi</button>
        <button class="btn secondary" id="pgClose">Sulje</button>
      </div>

      <p class="small" style="margin-top:10px">
        Mainokset n√§kyv√§t t√§ss√§ vaiheessa ‚Äì eiv√§t kesken pelin.
      </p>
    </div>

  </div>

  <!-- Liike-tila overlay -->
  <div class="overlay" id="moveOverlay" aria-hidden="true">
    <div class="ovcard">
      <div class="ovgrid">
        <div>
          <div class="ovtitle">Liike-tila k√§ynniss√§</div>
          <p class="ovmuted">Kosketus on lukossa, jotta et vahingossa n√§pp√§ile. Liiku vapaasti.</p>
        </div>
        <div style="text-align:right">
          <div class="small" style="color:rgba(255,255,255,.85)">T√§n√§√§n tehty</div>
          <div class="tag" style="background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.18);color:#fff">
            ‚úÖ <span class="mono" id="ovDone">0</span> / <span class="mono" id="ovGoal">5</span> min
          </div>
        </div>
      </div>

      <div class="hintbox">
        <div class="small" style="color:rgba(255,255,255,.88)">Aikaa j√§ljell√§</div>
        <p class="timer mono" id="ovTime">‚Äî</p>
        <div class="progress" style="background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.16)">
          <div class="bar" id="ovBar"></div>
        </div>
        <p class="small" id="ovSense" style="color:rgba(255,255,255,.88);margin-top:10px">Liikehavainto: ‚Äî</p>
        <p class="small" style="color:rgba(255,255,255,.88)">
          Liike-tilassa mainospaikat piilotetaan ja palautetaan automaattisesti.
        </p>
      </div>

      <div style="height:12px"></div>
      <div class="longpress" id="stopMove">Lopeta (pid√§ pohjassa 2 s)</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Tietosuojamodaali (varmasti EI vie etusivulle) -->
  <div class="modal" id="privacyModal" aria-hidden="true">
    <div class="modalCard">
      <div class="modalTop">
        <h2 style="margin:0">Tietosuoja</h2>
        <button class="xbtn" id="closePrivacy">Sulje</button>
      </div>
      <p class="small" style="margin-top:6px">
        T√§m√§ on kevyt ‚Äúselke√§ ja reilu‚Äù tietosuoja. Sivusto toimii ilman kirjautumista.
      </p>
      <ul>
        <li><b>Paikallinen tallennus:</b> Tallennetaan vain laitteellesi p√§iv√§n tavoite, p√§iv√§n tehdyt minuutit ja striikki (localStorage).</li>
        <li><b>Ei k√§ytt√§j√§tili√§:</b> Emme ker√§√§ nime√§, s√§hk√∂postia tai kirjautumista.</li>
        <li><b>Mainokset:</b> AdSense voi asettaa ev√§steit√§ ja ker√§t√§ tietoa mainosten n√§ytt√§miseksi. T√§m√§ riippuu selaimesi asetuksista ja suostumuksista.</li>
        <li><b>√Ñ√§ni:</b> Miniopit k√§ytt√§v√§t selaimen puhesynteesi√§ (text-to-speech) vain laitteessasi.</li>
      </ul>
      <p class="small">
        Jos haluat ‚Äút√§ysin ilman seurantaa‚Äù -tilan: k√§yt√§ selaimen yksityist√§ tilaa tai est√§ ev√§steet.
      </p>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const LS = {
    goal: "ws_goal_min",
    done: "ws_done_min_today",
    day:  "ws_day",
    streak: "ws_streak",
    lastDoneDay: "ws_last_done_day",
    lesson: "ws_lesson_idx"
  };

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function setText(id, v){ $(id).textContent = String(v); }
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  }
  function speakFi(text){
    try{
      if(!("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "fi-FI";
      u.rate = 1.02;
      u.pitch = 1.0;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  }

  // ----- Lessons (5 kpl) -----
  const lessons = [
    {
      title: "Minioppi 1 ‚Äî Tyhj√§ sarake on moottori",
      text: "Spiderissa tyhj√§ sarake on supervoima. Kun saat yhden sarakkeen tyhj√§ksi, pystyt siirt√§m√§√§n pitki√§ ketjuja ja j√§rjest√§m√§√§n p√∂yt√§√§. Tavoite: tee yksi sarake tyhj√§ksi ja pid√§ se ty√∂kaluna.",
      goal: "üéØ Seuraava tavoite: tee 1 sarake tyhj√§ksi ja k√§yt√§ sit√§ siirtelyyn."
    },
    {
      title: "Minioppi 2 ‚Äî √Ñl√§ jaa liian aikaisin",
      text: "Uusi jako tuntuu helpolta, mutta usein se sotkee p√∂yd√§n. S√§√§nt√∂: ennen jakoa tee ainakin kolme siirtoa, vaikka ne olisivat pieni√§. Se parantaa loppupeli√§.",
      goal: "üéØ Seuraava tavoite: ennen jokaista jakoa tee v√§hint√§√§n 3 siirtoa."
    },
    {
      title: "Minioppi 3 ‚Äî Rakenna samaa maata kohti",
      text: "Vaikka voit siirt√§√§ pinoa ilman samaa maata, saman maan pinot ovat kultaa. Ne purkautuvat sarjoiksi helpommin. Hidas rakentaminen kannattaa.",
      goal: "üéØ Seuraava tavoite: rakenna yksi pitk√§ pino samaa maata kohti."
    },
    {
      title: "Minioppi 4 ‚Äî V√§lt√§ lukkoja",
      text: "Siirto voi n√§ytt√§√§ hyv√§lt√§, mutta sulkea vaihtoehdot. Jos menet√§t ainoan tyhj√§n sarakkeen tai kaksi saraketta j√§m√§ht√§√§, pys√§hdy ja mieti: j√§√§k√∂ mulle seuraavaksi mit√§√§n j√§rkev√§√§ siirtoa?",
      goal: "üéØ Seuraava tavoite: √§l√§ kuluta viimeist√§ tyhj√§√§ saraketta turhaan."
    },
    {
      title: "Minioppi 5 ‚Äî Pienet siirrot ovat siivousta",
      text: "Pienet siirrot eiv√§t ole turhia. Ne ovat siivousta: paljastat kortteja ja vapautat sarakkeita. Etsi yksi pieni siirto, joka avaa uuden kortin ‚Äî se k√§√§nt√§√§ usein koko pelin.",
      goal: "üéØ Seuraava tavoite: tee yksi pieni siirto, joka paljastaa uuden kortin."
    },
  ];

  // ----- State -----
  const state = {
    day: todayISO(),
    goalMin: Number(localStorage.getItem(LS.goal) || 5),
    doneMin: 0,
    streak: Number(localStorage.getItem(LS.streak) || 0),
    lessonIdx: Number(localStorage.getItem(LS.lesson) || 0),
    move: { running:false, secondsLeft:0, totalSeconds:0, tick:null, motionCount:0, motionLast:0 }
  };

  function rolloverDayIfNeeded(){
    const storedDay = localStorage.getItem(LS.day);
    if(storedDay !== state.day){
      localStorage.setItem(LS.day, state.day);
      localStorage.setItem(LS.done, "0");
    }
  }
  function loadToday(){
    rolloverDayIfNeeded();
    state.doneMin = Number(localStorage.getItem(LS.done) || 0);
    state.doneMin = clamp(state.doneMin, 0, 999);
  }
  function saveToday(){
    localStorage.setItem(LS.goal, String(state.goalMin));
    localStorage.setItem(LS.done, String(state.doneMin));
    localStorage.setItem(LS.day, state.day);
    localStorage.setItem(LS.streak, String(state.streak));
    localStorage.setItem(LS.lesson, String(state.lessonIdx));
  }
  function pct(){
    return clamp((state.doneMin / state.goalMin) * 100, 0, 100);
  }
  function unlocked(){
    return state.doneMin >= state.goalMin;
  }

  function refreshUI(){
    setText("todayTag", state.day);
    setText("goalMin", state.goalMin);
    setText("doneMin", state.doneMin);
    setText("streak", state.streak);

    $("bar").style.width = pct() + "%";

    const left = Math.max(0, state.goalMin - state.doneMin);

    $("statusLine").innerHTML = unlocked()
      ? "P√§iv√§ tehty ‚úÖ Spider on auki. Hyv√§ ty√∂."
      : `Viel√§ <b>${left} min</b> j√§ljell√§.`;

    $("openSpider").disabled = !unlocked();
    $("finishWin").disabled = !unlocked();
    $("finishLoss").disabled = !unlocked();

    // Opetus (lukitus)
    const canTeach = unlocked();
    $("playLesson").disabled = !canTeach;
    $("nextTip").disabled = !canTeach;
    $("pgListen").disabled = !canTeach;

    $("finishHint").textContent = unlocked()
      ? "Pelaa kierros ja paina Voitin / H√§visin. Saat pelinj√§lkeisen yhteenvedon + miniopin."
      : "Tee ensin p√§iv√§n liike, niin Spider ja opetus aukeaa.";

    $("goalText").textContent = `Nykyinen tavoite: ${state.goalMin} min. (Voit vaihtaa koska vaan.)`;

    // P√§ivit√§ nappiteksti (1/5, 2/5...)
    const li = state.lessonIdx % lessons.length;
    $("playLesson").textContent = `Kuuntele minioppi (${li+1}/5)`;
  }

  // ----- Motion sensing (nice-to-have) -----
  async function tryEnableMotion(){
    try{
      if(typeof DeviceMotionEvent === "undefined") return false;
      if(typeof DeviceMotionEvent.requestPermission === "function"){
        const res = await DeviceMotionEvent.requestPermission();
        return res === "granted";
      }
      return true;
    }catch(e){ return false; }
  }
  function onMotion(e){
    try{
      const a = e.accelerationIncludingGravity;
      if(!a) return;
      const x = a.x || 0, y = a.y || 0, z = a.z || 0;
      const mag = Math.sqrt(x*x + y*y + z*z);
      const now = Date.now();
      const delta = Math.abs(mag - (state.move.motionLast || mag));
      state.move.motionLast = mag;
      if(delta > 0.9 && (now - (state.move.motionTs || 0)) > 250){
        state.move.motionCount++;
        state.move.motionTs = now;
      }
    }catch(e){}
  }
  function motionStatusText(){
    const c = state.move.motionCount;
    return `Liike OK (${String(90000 + (c % 9999)).padStart(5,'0')})`;
  }

  // ----- Move overlay -----
  function openOverlay(seconds){
    state.move.running = true;
    state.move.totalSeconds = seconds;
    state.move.secondsLeft = seconds;
    state.move.motionCount = 0;
    state.move.motionLast = 0;

    // Piilota mainospaikat liike-tilassa
    $("adA").style.display = "none";
    $("adB").style.display = "none";

    $("moveOverlay").classList.add("show");
    $("moveOverlay").setAttribute("aria-hidden","false");

    setText("ovDone", state.doneMin);
    setText("ovGoal", state.goalMin);

    tickOverlay();
    state.move.tick = setInterval(tickOverlay, 250);

    speakFi("Liike-tila k√§ynniss√§. Liiku rauhassa.");
  }

  function closeOverlay(){
    state.move.running = false;
    if(state.move.tick) clearInterval(state.move.tick);
    state.move.tick = null;

    $("moveOverlay").classList.remove("show");
    $("moveOverlay").setAttribute("aria-hidden","true");

    // Palauta mainospaikat
    $("adA").style.display = "";
    $("adB").style.display = "";

    refreshUI();
  }

  function tickOverlay(){
    if(!state.move.running) return;

    state.move.secondsLeft = Math.max(0, state.move.secondsLeft - 0.25);

    const s = Math.ceil(state.move.secondsLeft);
    $("ovTime").textContent = s + " s";
    $("ovSense").textContent = "Liikehavainto: " + motionStatusText();

    const p = clamp(((state.move.totalSeconds - state.move.secondsLeft) / state.move.totalSeconds) * 100, 0, 100);
    $("ovBar").style.width = p + "%";

    if(state.move.secondsLeft <= 0){
      const addMin = Math.round(state.move.totalSeconds / 60);
      state.doneMin = clamp(state.doneMin + addMin, 0, 999);

      // Striikki p√§ivittyy vain kerran/p√§iv√§ kun tavoite t√§yttyy
      if(unlocked()){
        const lastDone = localStorage.getItem(LS.lastDoneDay);
        if(lastDone !== state.day){
          localStorage.setItem(LS.lastDoneDay, state.day);
          state.streak = clamp(state.streak + 1, 0, 9999);
        }
      }

      saveToday();
      speakFi("Valmis. P√§iv√§n liike kirjattu.");
      toast("‚úÖ Liike kirjattu (" + addMin + " min)");
      closeOverlay();
    }
  }

  // Long press stop (2s)
  let lpTimer = null;
  function startLongPress(){
    if(!state.move.running) return;
    lpTimer = setTimeout(() => {
      speakFi("Liike-tila lopetettu.");
      toast("Liike-tila lopetettu");
      closeOverlay();
    }, 2000);
  }
  function endLongPress(){
    if(lpTimer) clearTimeout(lpTimer);
    lpTimer = null;
  }
  $("stopMove").addEventListener("touchstart", startLongPress, {passive:true});
  $("stopMove").addEventListener("touchend", endLongPress, {passive:true});
  $("stopMove").addEventListener("mousedown", startLongPress);
  window.addEventListener("mouseup", endLongPress);

  // ----- Teaching / Postgame -----
  function showLessonBox(){
    const li = state.lessonIdx % lessons.length;
    const L = lessons[li];
    $("lessonTitle").textContent = L.title;
    $("lessonText").textContent = L.text;
    $("lessonGoal").textContent = L.goal;
    $("lessonBox").style.display = "block";
  }

  function playLesson(){
    if(!unlocked()){
      toast("Tee p√§iv√§n liike ensin üôÇ");
      return;
    }
    showLessonBox();
    const li = state.lessonIdx % lessons.length;
    speakFi(lessons[li].text);
    toast("üéß " + lessons[li].title);

    // Etene seuraavaan (1/5 -> 2/5...)
    state.lessonIdx = (state.lessonIdx + 1) % lessons.length;
    saveToday();
    refreshUI();
  }

  function postGame(won){
    $("postGame").style.display = "block";
    $("pgTitle").textContent = won ? "üëë Hyv√§! Kierros valmis." : "üí™ Hyv√§ yritys. Kierros valmis.";

    $("pgLine1").textContent = won
      ? "‚úÖ Rytmi oli hyv√§ ‚Äì sait kierroksen maaliin."
      : "‚úÖ T√§m√§kin treenaa p√§√§t√∂ksi√§ ja k√§rsiv√§llisyytt√§.";

    $("pgLine2").textContent = won
      ? "üîé Seuraavaksi: ennen uutta jakoa tee viel√§ pari siirtoa, jos mahdollista."
      : "üîé Seuraavaksi: etsi yksi tyhj√§ sarake ja pid√§ se ‚Äòty√∂kaluna‚Äô pidemp√§√§n.";

    $("pgListen").disabled = !unlocked();
    $("pgListen").onclick = playLesson;
    speakFi("Kierros valmis.");
    toast("Kierros kirjattu");
  }

  // ----- Buttons -----
  function setGoal(min){
    state.goalMin = min;
    saveToday();
    refreshUI();
    toast("Tavoite: " + min + " min");
  }
  $("goal3").onclick = () => setGoal(3);
  $("goal5").onclick = () => setGoal(5);
  $("goal7").onclick = () => setGoal(7);

  $("startMove").onclick = async () => {
    const left = Math.max(0, state.goalMin - state.doneMin);
    const pick = left <= 0 ? 3 : clamp(left, 1, 7);
    const seconds = pick * 60;

    const ok = await tryEnableMotion();
    if(ok && !state._motionOn){
      window.addEventListener("devicemotion", onMotion, {passive:true});
      state._motionOn = true;
    }

    openOverlay(seconds);
  };

  $("openSpider").onclick = () => {
    window.open("https://solitaire.com/spider-solitaire", "_blank", "noopener,noreferrer");
    toast("Avattu Spider uuteen v√§lilehteen");
  };

  $("finishWin").onclick = () => postGame(true);
  $("finishLoss").onclick = () => postGame(false);
  $("pgClose").onclick = () => { $("postGame").style.display = "none"; };

  $("playLesson").onclick = playLesson;
  $("nextTip").onclick = () => {
    if(!unlocked()){ toast("Tee p√§iv√§n liike ensin üôÇ"); return; }
    showLessonBox();
    speakFi("Seuraava tavoite n√§kyy. Ota yksi pieni tavoite kerrallaan.");
  };

  // ----- Privacy modal -----
  $("openPrivacy").onclick = () => {
    $("privacyModal").classList.add("show");
    $("privacyModal").setAttribute("aria-hidden","false");
  };
  $("closePrivacy").onclick = () => {
    $("privacyModal").classList.remove("show");
    $("privacyModal").setAttribute("aria-hidden","true");
  };
  $("privacyModal").addEventListener("click", (e) => {
    if(e.target === $("privacyModal")){
      $("privacyModal").classList.remove("show");
      $("privacyModal").setAttribute("aria-hidden","true");
    }
  });

  // ----- Init -----
  loadToday();
  refreshUI();
})();
</script>
</body>
</html>
