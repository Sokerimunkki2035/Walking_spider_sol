<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="utf-8">
  <title>Spider Solitaire</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0d4a3a;
      color: white;
      padding: 10px;
      margin: 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      background: #2a8b6f;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:hover { background: #3aa382; }
    #info {
      margin: 10px 0;
      padding: 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 5px;
    }
    #table {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 5px;
    }
    @media (max-width: 800px) {
      #table { grid-template-columns: repeat(5, 1fr); }
    }
    .column {
      background: rgba(0,0,0,0.2);
      border-radius: 5px;
      padding: 5px;
      min-height: 300px;
    }
    .col-num {
      text-align: center;
      font-size: 12px;
      margin-bottom: 5px;
      color: #aaa;
    }
    .card {
      background: white;
      color: black;
      border: 1px solid #666;
      border-radius: 3px;
      padding: 5px;
      margin-bottom: -35px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      position: relative;
      height: 50px;
    }
    .card:last-child { margin-bottom: 0; }
    .card.face-down {
      background: #1a5f4a;
      color: transparent;
    }
    .card.selected {
      outline: 3px solid yellow;
      box-shadow: 0 0 10px yellow;
      z-index: 100;
    }
  </style>
</head>
<body>

<h2>Spider Solitaire</h2>
<button onclick="newGame()">Uusi peli</button>
<button onclick="undoMove()">Undo</button>

<div id="info">Ladataan...</div>
<div id="table"></div>

<script>
// Pelin tila
let columns = [];
let stockPile = [];
let selectedCol = -1;
let selectedIdx = -1;
let moveHistory = [];

// Alusta peli
function newGame() {
  // Luo 104 korttia (8 pakkaa, kaikki pataa)
  let deck = [];
  for (let p = 0; p < 8; p++) {
    for (let r = 1; r <= 13; r++) {
      deck.push({rank: r, faceUp: false});
    }
  }
  
  // Sekoita
  for (let i = deck.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [deck[i], deck[j]] = [deck[j], deck[i]];
  }
  
  // Jaa 10 sarakkeeseen
  columns = [];
  for (let c = 0; c < 10; c++) {
    let count = c < 4 ? 6 : 5;
    let col = [];
    for (let i = 0; i < count; i++) {
      col.push(deck.pop());
    }
    col[col.length - 1].faceUp = true;
    columns.push(col);
  }
  
  stockPile = deck;
  selectedCol = -1;
  selectedIdx = -1;
  moveHistory = [];
  
  drawTable();
  updateInfo("Peli aloitettu. Klikkaa korttia, sitten kohdesaraketta.");
}

// Piirrä pöytä
function drawTable() {
  let table = document.getElementById("table");
  table.innerHTML = "";
  
  for (let c = 0; c < 10; c++) {
    let colDiv = document.createElement("div");
    colDiv.className = "column";
    colDiv.onclick = function() { columnClicked(c); };
    
    // Sarakenumero
    let num = document.createElement("div");
    num.className = "col-num";
    num.innerText = (c + 1) + " (" + columns[c].length + ")";
    colDiv.appendChild(num);
    
    // Kortit
    for (let i = 0; i < columns[c].length; i++) {
      let card = columns[c][i];
      let cardDiv = document.createElement("div");
      cardDiv.className = "card";
      
      if (card.faceUp) {
        cardDiv.innerText = getRankName(card.rank) + "♠";
        cardDiv.onclick = function(e) {
          e.stopPropagation();
          cardClicked(c, i);
        };
        
        // Korosta valittu
        if (c === selectedCol && i === selectedIdx) {
          cardDiv.classList.add("selected");
        }
      } else {
        cardDiv.classList.add("face-down");
      }
      
      colDiv.appendChild(cardDiv);
    }
    
    table.appendChild(colDiv);
  }
}

// Korttia klikattu
function cardClicked(col, idx) {
  // Tarkista että kortti on ylös
  if (!columns[col][idx].faceUp) {
    updateInfo("Kortti on piilossa!");
    return;
  }
  
  // Jos sama jo valittu, poista valinta
  if (selectedCol === col && selectedIdx === idx) {
    selectedCol = -1;
    selectedIdx = -1;
    drawTable();
    updateInfo("Valinta poistettu");
    return;
  }
  
  // Tarkista että valittava sarja on laskeva (K-Q-J-10...)
  for (let i = idx; i < columns[col].length - 1; i++) {
    if (columns[col][i].rank !== columns[col][i+1].rank + 1) {
      updateInfo("Valitse laskeva sarja (esim. K-Q-J)");
      return;
    }
  }
  
  selectedCol = col;
  selectedIdx = idx;
  drawTable();
  updateInfo("Valittu sarake " + (col+1) + ". Klikkaa kohdesaraketta.");
}

// Saraketta klikattu (kohde)
function columnClicked(targetCol) {
  // Ei valintaa
  if (selectedCol === -1) {
    updateInfo("Valitse ensin kortti!");
    return;
  }
  
  // Sama sarake
  if (selectedCol === targetCol) {
    updateInfo("Valitse eri sarake!");
    return;
  }
  
  // Tarkista voiko siirtää
  if (!canMove(selectedCol, selectedIdx, targetCol)) {
    updateInfo("Ei voi siirtää tuohon!");
    selectedCol = -1;
    selectedIdx = -1;
    drawTable();
    return;
  }
  
  // Tee siirto
  doMove(selectedCol, selectedIdx, targetCol);
}

// Tarkista säännöt
function canMove(fromCol, fromIdx, toCol) {
  let fromCard = columns[fromCol][fromIdx];
  let toColData = columns[toCol];
  
  // Tyhjään saa aina
  if (toColData.length === 0) return true;
  
  // Kohde oltava yhtä suurempi (5 -> 6)
  let topCard = toColData[toColData.length - 1];
  return topCard.rank === fromCard.rank + 1;
}

// Tee siirto
function doMove(fromCol, fromIdx, toCol) {
  // Tallenna historia
  moveHistory.push(JSON.parse(JSON.stringify(columns)));
  if (moveHistory.length > 10) moveHistory.shift();
  
  // Siirrä kortit
  let movingCards = columns[fromCol].splice(fromIdx);
  columns[toCol] = columns[toCol].concat(movingCards);
  
  // Käännä uusi päällimmäinen
  if (columns[fromCol].length > 0) {
    columns[fromCol][columns[fromCol].length - 1].faceUp = true;
  }
  
  // Tarkista valmis sarja (K-Q-J-10-9-8-7-6-5-4-3-2-A)
  checkComplete(toCol);
  
  // Nollaa valinta
  selectedCol = -1;
  selectedIdx = -1;
  
  drawTable();
  updateInfo("Siirretty! Stock: " + stockPile.length);
}

// Tarkista valmis sarja
function checkComplete(col) {
  if (columns[col].length < 13) return;
  
  let start = columns[col].length - 13;
  for (let i = 0; i < 13; i++) {
    let card = columns[col][start + i];
    if (!card.faceUp || card.rank !== 13 - i) return;
  }
  
  // Poista sarja
  columns[col].splice(start, 13);
  if (columns[col].length > 0) {
    columns[col][columns[col].length - 1].faceUp = true;
  }
  
  updateInfo("KOKO SARJA VALMIS! (K-A)");
}

// Undo
function undoMove() {
  if (moveHistory.length === 0) {
    updateInfo("Ei peruttavaa!");
    return;
  }
  
  columns = moveHistory.pop();
  selectedCol = -1;
  selectedIdx = -1;
  drawTable();
  updateInfo("Peruttu");
}

// Apufunktiot
function getRankName(r) {
  if (r === 1) return "A";
  if (r === 11) return "J";
  if (r === 12) return "Q";
  if (r === 13) return "K";
  return r;
}

function updateInfo(msg) {
  document.getElementById("info").innerText = msg;
}

// Aloita
newGame();
</script>

</body>
</html>
