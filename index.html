<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Walking Spider Sol ‚Äì k√§velyvelvoite</title>

  <!-- AdSense (valinnainen) -->
  <script async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7652525244986434"
    crossorigin="anonymous"></script>

  <style>
    :root{
      --bg1:#063b34; --bg2:#0b5f52;
      --card:#ffffff; --txt:#0f1f1c; --muted:#5a6f6a;
      --btn:#0b5f52; --btn2:#1f8b63;
      --shadow:0 12px 28px rgba(0,0,0,.22);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#fff;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:860px;margin:0 auto;padding:14px 12px 24px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .brand{font-weight:1100;letter-spacing:-.2px;font-size:18px}
    .pill{
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      font-weight:1000;
      display:flex;gap:10px;align-items:center;
    }
    .card{
      margin-top:12px;background:var(--card);color:var(--txt);
      border-radius:var(--r);box-shadow:var(--shadow);
      padding:14px;
    }
    .h1{font-size:34px;margin:0 0 6px;font-weight:1200;letter-spacing:-.6px}
    .sub{color:var(--muted);font-weight:700;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{
      border:0;border-radius:16px;padding:14px 16px;
      background:var(--btn);color:#fff;font-weight:1100;
      cursor:pointer;user-select:none;flex:1 1 140px;
    }
    .btn.green{background:var(--btn2)}
    .btn.ghost{
      background:transparent;color:var(--txt);
      border:2px solid rgba(0,0,0,.10);
    }
    .btn:active{transform:scale(.99)}
    .small{font-size:13px;color:#3d5450;opacity:.9;line-height:1.45}
    .adbox{
      margin-top:12px;
      background:rgba(255,255,255,.08);
      border:2px dashed rgba(255,255,255,.22);
      color:rgba(255,255,255,.90);
      border-radius:18px;
      padding:14px;
      text-align:center;
      font-weight:1100;
    }

    /* WALK OVERLAY */
    .overlay{
      position:fixed;inset:0;z-index:9999;
      display:none;
      background:rgba(0,0,0,.68);
      backdrop-filter: blur(6px);
      padding:16px;
    }
    .overlay.show{display:block}
    .ovcard{
      max-width:860px;margin:0 auto;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      border-radius:22px;
      padding:14px;
      box-shadow:0 18px 44px rgba(0,0,0,.35);
    }
    .ovtitle{font-size:28px;font-weight:1200;margin:6px 0 2px}
    .ovsub{opacity:.92;font-weight:800;line-height:1.35}
    .bigtime{
      font-size:64px;font-weight:1300;
      margin:12px 0 8px;
      font-variant-numeric: tabular-nums;
    }
    .bar{
      height:14px;border-radius:999px;background:rgba(255,255,255,.16);
      overflow:hidden;border:1px solid rgba(255,255,255,.16);
    }
    .bar > div{height:100%;width:0%;background:rgba(56,161,105,.95)}
    .status{
      margin-top:10px;display:flex;gap:10px;flex-wrap:wrap
    }
    .tag{
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      font-weight:1100;
    }
    .locknote{
      margin-top:10px;
      padding:10px 12px;border-radius:16px;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      font-weight:900;opacity:.95
    }
    .ovbtnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .ovbtn{
      border:0;border-radius:16px;padding:14px 16px;
      background:rgba(255,255,255,.14);
      color:#fff;font-weight:1100;cursor:pointer;
      flex:1 1 160px;user-select:none
    }
    .ovbtn.danger{background:rgba(255,99,99,.22)}
    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(0,0,0,.78);color:#fff;
      padding:10px 12px;border-radius:999px;
      font-weight:1100;font-size:13px;
      display:none;z-index:10000;
      border:1px solid rgba(255,255,255,.14)
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">üï∑Ô∏è Walking Spider Sol</div>
      <div class="pill">üî• Striikki <span id="streak">0</span> ‚Ä¢ ‚úÖ P√§iv√§ tehty <span id="done">ei</span></div>
    </div>

    <div id="adArea" class="adbox">Auto Ads ‚Äì paikka (etusivu)</div>

    <div class="card">
      <div class="h1">P√§iv√§n k√§velyvelvoite</div>
      <div class="sub">
        Valitse tavoite (3/5/7 min). Kun t√§yt√§t, peli aukeaa.  
        K√§velytilassa kosketus on lukossa, jotta et ‚Äúvahingossa j√§√§‚Äù puhelimeen.
      </div>

      <div class="row">
        <button class="btn" data-min="3">3 min</button>
        <button class="btn" data-min="5">5 min</button>
        <button class="btn" data-min="7">7 min</button>
      </div>

      <div class="row">
        <button class="btn green" id="btnWalk">Aloita k√§vely-tila</button>
        <button class="btn ghost" id="btnOpenGame">Avaa Spider / peli</button>
      </div>

      <div class="small" style="margin-top:10px">
        Nykyinen tavoite: <b id="goalLabel">5 min</b> ‚Ä¢ T√§n√§√§n tehty: <b id="todayDone">0 min</b>
      </div>
      <div class="small" style="margin-top:6px">
        Vinkki: jos anturit eiv√§t toimi (iOS/Selain), ajastin silti lasketaan.  
        Tarkoitus on k√§vely-<b>velvoite</b>, ei t√§ydellinen askelmittari.
      </div>
    </div>

    <div class="card">
      <div style="font-weight:1100">Tietosuoja</div>
      <div class="small">T√§m√§ sivu ei l√§het√§ anturidataa minnek√§√§n. Kaikki pysyy laitteessa.</div>
      <div class="row">
        <button class="btn ghost" id="btnCopy">üìã Kopioi t√§m√§ (koko HTML)</button>
      </div>
    </div>
  </div>

  <!-- WALK OVERLAY -->
  <div id="ov" class="overlay">
    <div class="ovcard" id="ovCard">
      <div class="ovtitle">Liike-tila k√§ynniss√§</div>
      <div class="ovsub">Kosketus on lukossa. Liiku vapaasti. Kun aika t√§yttyy, peli aukeaa. üí™</div>

      <div class="bigtime"><span id="secLeft">0</span>s</div>
      <div class="bar"><div id="barFill"></div></div>

      <div class="status">
        <div class="tag">üéØ Tavoite: <span id="goalMinTag">5</span> min</div>
        <div class="tag">üìà Liike: <span id="motionTag">odottaa</span></div>
        <div class="tag">üîä Puhe: <span id="speechTag">off</span></div>
      </div>

      <div class="locknote">
        ‚õî Kosketuslukko on p√§√§ll√§.  
        Lopetus onnistuu pit√§m√§ll√§ ‚ÄúLopeta‚Äù pohjassa 2 sekuntia.
      </div>

      <div class="ovbtnrow">
        <button class="ovbtn" id="btnSpeak">Ota kehu-√§√§ni k√§ytt√∂√∂n</button>
        <button class="ovbtn danger" id="btnStopHold">Lopeta (pid√§ pohjassa 2 s)</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const LS = {
    goal:"ws_walk_goal_min_v1",
    doneDate:"ws_walk_done_date_v1",
    doneMin:"ws_walk_done_min_v1",
    streak:"ws_walk_streak_v1"
  };

  const $ = (id)=>document.getElementById(id);

  const btns = document.querySelectorAll('button[data-min]');
  const btnWalk = $("btnWalk");
  const btnOpenGame = $("btnOpenGame");
  const btnCopy = $("btnCopy");

  const goalLabel = $("goalLabel");
  const todayDone = $("todayDone");
  const streakEl = $("streak");
  const doneEl = $("done");

  const ov = $("ov");
  const adArea = $("adArea");

  const secLeftEl = $("secLeft");
  const barFill = $("barFill");
  const goalMinTag = $("goalMinTag");
  const motionTag = $("motionTag");
  const speechTag = $("speechTag");
  const btnSpeak = $("btnSpeak");
  const btnStopHold = $("btnStopHold");

  const toastEl = $("toast");

  let goalMin = Number(localStorage.getItem(LS.goal) || 5);
  let timer = null;
  let totalSec = 0;
  let leftSec = 0;

  let speakOn = false;
  let motionOk = false;
  let motionScore = 0;
  let lastMotionAt = 0;

  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(()=>toastEl.classList.remove("show"), 1200);
  }

  function setGoal(min){
    goalMin = min;
    localStorage.setItem(LS.goal, String(min));
    goalLabel.textContent = `${min} min`;
    goalMinTag.textContent = String(min);
    toast(`Tavoite ${min} min`);
    renderTop();
  }

  function getDone(){
    const d = localStorage.getItem(LS.doneDate) || "";
    const min = Number(localStorage.getItem(LS.doneMin) || 0);
    if(d !== todayISO()) return 0;
    return min;
  }

  function getStreak(){
    return Number(localStorage.getItem(LS.streak) || 0);
  }

  function renderTop(){
    const doneMin = getDone();
    todayDone.textContent = `${doneMin} min`;
    streakEl.textContent = String(getStreak());
    const ok = doneMin >= goalMin;
    doneEl.textContent = ok ? "kyll√§" : "ei";
  }

  // ==== Speech ====
  function speak(text){
    if(!speakOn) return;
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "fi-FI";
      u.rate = 1.02;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  }

  btnSpeak.addEventListener("click", ()=>{
    speakOn = !speakOn;
    speechTag.textContent = speakOn ? "on" : "off";
    btnSpeak.textContent = speakOn ? "Kehu-√§√§ni p√§√§ll√§ ‚úÖ" : "Ota kehu-√§√§ni k√§ytt√∂√∂n";
    if(speakOn) speak("Hyv√§! L√§hdet√§√§n liikkeelle.");
  });

  // ==== Motion detection (very light heuristic) ====
  // Works on many Android browsers with user gesture.
  let motionListenerOn = false;
  async function enableMotion(){
    try{
      if(typeof DeviceMotionEvent !== "undefined" && typeof DeviceMotionEvent.requestPermission === "function"){
        const p = await DeviceMotionEvent.requestPermission();
        if(p !== "granted") throw new Error("no permission");
      }
      if(!motionListenerOn){
        window.addEventListener("devicemotion", onMotion, {passive:true});
        motionListenerOn = true;
      }
      motionOk = true;
      motionTag.textContent = "p√§√§ll√§";
    }catch(e){
      motionOk = false;
      motionTag.textContent = "ei saatavilla";
    }
  }

  function onMotion(ev){
    const a = ev.accelerationIncludingGravity;
    if(!a) return;
    const ax = a.x || 0, ay = a.y || 0, az = a.z || 0;
    const mag = Math.sqrt(ax*ax + ay*ay + az*az);
    // crude: count spikes above threshold as "movement events"
    if(mag > 14.2){
      motionScore++;
      lastMotionAt = Date.now();
    }
  }

  function motionStatusTick(){
    if(!motionOk){
      motionTag.textContent = "ajastin riitt√§√§";
      return;
    }
    const ago = Date.now() - lastMotionAt;
    if(ago < 2500) motionTag.textContent = `liikett√§ ‚úÖ (${motionScore})`;
    else motionTag.textContent = `hiljaa‚Ä¶ (${motionScore})`;
  }

  // ==== Walk overlay ====
  function showWalk(){
    ov.classList.add("show");
    // hide ads in walk mode (and they will return automatically)
    adArea.style.display = "none";
  }
  function hideWalk(){
    ov.classList.remove("show");
    adArea.style.display = "";
  }

  function startWalk(){
    // must be called from click => enables motion permission on iOS too
    enableMotion();

    totalSec = goalMin * 60;
    leftSec = totalSec;
    secLeftEl.textContent = String(leftSec);
    barFill.style.width = "0%";
    motionScore = 0;
    lastMotionAt = 0;
    motionStatusTick();

    showWalk();
    speak("Hyv√§. Nyt k√§vell√§√§n.");

    if(timer) clearInterval(timer);
    timer = setInterval(()=>{
      leftSec--;
      if(leftSec < 0) leftSec = 0;

      secLeftEl.textContent = String(leftSec);
      const prog = 100 * (1 - leftSec/totalSec);
      barFill.style.width = `${prog.toFixed(1)}%`;

      motionStatusTick();

      // little cheers
      if(speakOn && leftSec % 30 === 0 && leftSec !== 0){
        speak("Hyv√§. Jatka.");
      }

      if(leftSec === 0){
        clearInterval(timer);
        timer = null;
        finishWalk();
      }
    }, 1000);
  }

  function finishWalk(){
    // mark done for today
    const t = todayISO();
    const prevDate = localStorage.getItem(LS.doneDate) || "";
    let prevDone = 0;
    if(prevDate === t) prevDone = Number(localStorage.getItem(LS.doneMin) || 0);

    localStorage.setItem(LS.doneDate, t);
    localStorage.setItem(LS.doneMin, String(Math.max(prevDone, goalMin)));

    // streak update
    // If yesterday was done and today becomes done => streak++ else streak=1
    const d = new Date();
    const yest = new Date(d.getFullYear(), d.getMonth(), d.getDate()-1);
    const yISO = `${yest.getFullYear()}-${String(yest.getMonth()+1).padStart(2,"0")}-${String(yest.getDate()).padStart(2,"0")}`;
    const hadYesterday = (prevDate === yISO) || false; // simplistic; you can store separate history later
    let streak = getStreak();
    // If streak is 0 => start
    if(streak === 0) streak = 1;
    else streak = hadYesterday ? (streak + 1) : 1;
    localStorage.setItem(LS.streak, String(streak));

    renderTop();

    speak("Loistavaa. K√§vely tehty. Nyt peli aukeaa.");
    toast("K√§vely tehty ‚úÖ");

    // auto-exit overlay after short moment
    setTimeout(()=>hideWalk(), 600);
  }

  // STOP HOLD 2s
  let holdT = null;
  btnStopHold.addEventListener("touchstart", ()=>{
    holdT = setTimeout(()=>{
      if(timer) clearInterval(timer);
      timer = null;
      hideWalk();
      toast("K√§velytila lopetettu.");
      speak("Okei. Lopetetaan.");
    }, 2000);
  }, {passive:true});
  btnStopHold.addEventListener("touchend", ()=>{ if(holdT){clearTimeout(holdT); holdT=null;} }, {passive:true});
  btnStopHold.addEventListener("mousedown", ()=>{
    holdT = setTimeout(()=>{
      if(timer) clearInterval(timer);
      timer = null;
      hideWalk();
      toast("K√§velytila lopetettu.");
      speak("Okei. Lopetetaan.");
    }, 2000);
  });
  btnStopHold.addEventListener("mouseup", ()=>{ if(holdT){clearTimeout(holdT); holdT=null;} });

  // goal buttons
  btns.forEach(b=>{
    b.addEventListener("click", ()=> setGoal(Number(b.dataset.min)));
  });

  btnWalk.addEventListener("click", startWalk);

  // Link your game here (edit this URL)
  const GAME_URL = "./index.html"; // <-- vaihda t√§h√§n sun spider/scorpion pelin url, esim "./spider.html"
  btnOpenGame.addEventListener("click", ()=>{
    const doneMin = getDone();
    if(doneMin < goalMin){
      toast("Ensin k√§velyvelvoite üôÇ");
      speak("Ensin k√§vely. Sitten peli.");
      startWalk();
      return;
    }
    window.open(GAME_URL, "_blank", "noopener");
  });

  // Copy whole HTML (quick dev helper)
  async function copyText(text){
    try{ await navigator.clipboard.writeText(text); return true; }
    catch(_){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); document.body.removeChild(ta); return true; }
      catch(e){ document.body.removeChild(ta); return false; }
    }
  }
  btnCopy.addEventListener("click", async ()=>{
    const ok = await copyText(document.documentElement.outerHTML);
    toast(ok ? "Kopioitu!" : "Kopiointi ep√§onnistui.");
  });

  // init
  setGoal(goalMin);
  renderTop();
})();
</script>
</body>
</html>
