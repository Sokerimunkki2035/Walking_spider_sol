<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Scorpion Solitaire (MVP)</title>

  <!-- AdSense (valinnainen) -->
  <script async
    src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7652525244986434"
    crossorigin="anonymous"></script>

  <style>
    :root{
      --bg1:#063b34; --bg2:#0b5f52;
      --txt:#10211e; --muted:#5b6f6b;
      --shadow:0 12px 28px rgba(0,0,0,.22);
      --r:18px;

      --pileW: 110px;
      --cardH: 72px;
      --offset: 22px;

      --btn:#0b5f52;
      --btn2:#1f8b63;
      --sel:#ffe08a;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:#fff;
      -webkit-tap-highlight-color: transparent;
      overflow-x:hidden;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:12px 12px 22px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .brand{font-weight:1100;letter-spacing:-.2px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:9px 12px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      font-weight:1000;user-select:none;
    }
    .chip b{font-variant-numeric:tabular-nums}

    .card{
      margin-top:10px;
      background:#fff; color:var(--txt);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin:0 0 10px}
    .btn{
      border:0;border-radius:14px;
      padding:12px 14px;
      background:var(--btn);
      color:#fff;font-weight:1100;
      cursor:pointer;
      user-select:none;
    }
    .btn.secondary{background:#2a6f62}
    .btn.green{background:var(--btn2)}
    .btn.ghost{background:transparent;border:2px solid rgba(0,0,0,.10); color:var(--txt)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:active{transform:scale(.99)}
    .small{font-size:13px;color:#3d5450;opacity:.9;line-height:1.45}

    .hint{
      margin-top:8px;
      padding:10px 12px;border-radius:14px;
      border:1px solid #dbe5e3;
      background:#fbfffe;
      color:#1a2c29;
    }

    .boardOuter{
      margin-top:12px;
      border-radius:22px;
      padding:12px;
      background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.05));
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.10);
      overflow:hidden;
    }
    .boardScaleWrap{transform-origin: top left; will-change: transform;}
    .piles{
      display:flex;
      gap:10px;
      align-items:flex-start;
      width:max-content;
      min-width:max-content;
    }
    .pile{
      position:relative;
      width:var(--pileW);
      min-height:520px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      padding:8px 6px 10px;
      overflow:hidden;
      cursor:pointer;
      user-select:none;
      flex:0 0 auto;
    }
    .pile.empty::after{
      content:"";
      position:absolute;inset:10px 8px auto 8px;
      height:60px;border-radius:12px;
      border:2px dashed rgba(255,255,255,.26);
      opacity:.8;
    }
    .cards{position:relative;height:100%;min-height:520px}

    .cardEl{
      position:absolute;left:0;right:0;
      height:var(--cardH);
      border-radius:14px;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:0 10px 18px rgba(0,0,0,.16);
      background:#fff;
      display:flex;align-items:flex-start;justify-content:space-between;
      padding:8px 10px;
      color:#10211e;
      font-weight:1100;
      transform: translateZ(0);
    }
    .cardEl .rank{font-size:18px;line-height:1}
    .cardEl .suit{font-size:18px;line-height:1}
    .cardEl .mini{font-size:12px;opacity:.75;font-weight:900;line-height:1.1}
    .cardEl.selected{
      outline:3px solid var(--sel);
      box-shadow:0 16px 26px rgba(255,224,138,.28);
      z-index:999;
    }
    .cardEl.selTail{outline:3px solid rgba(255,224,138,.55)}

    /* face-down look */
    .cardEl.down{
      background:linear-gradient(135deg,#0f4b40,#0b5f52);
      color:rgba(255,255,255,.55);
      border-color:rgba(255,255,255,.12);
    }
    .cardEl.down .rank, .cardEl.down .suit{opacity:.0}
    .cardEl.down::after{
      content:"";
      position:absolute;inset:10px;
      border-radius:12px;
      border:2px dashed rgba(255,255,255,.18);
    }

    .pile.targetOK{box-shadow: inset 0 0 0 3px rgba(56,161,105,.55)}
    .pile.targetNO{box-shadow: inset 0 0 0 3px rgba(214,69,69,.55)}
    @keyframes flashRed {
      0% { box-shadow: inset 0 0 0 0 rgba(214,69,69,0); }
      40% { box-shadow: inset 0 0 0 4px rgba(214,69,69,.85); }
      100% { box-shadow: inset 0 0 0 0 rgba(214,69,69,0); }
    }
    .pile.flashBad{ animation: flashRed .35s ease; }

    .adbox{
      margin-top:10px;
      background:rgba(255,255,255,.08);
      border:2px dashed rgba(255,255,255,.22);
      color:rgba(255,255,255,.88);
      border-radius:16px;
      padding:12px;
      text-align:center;
      font-weight:1100;
    }
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.78);color:#fff;
      padding:10px 12px;border-radius:999px;
      font-weight:1100;font-size:13px;
      display:none;z-index:10000;
      border:1px solid rgba(255,255,255,.14)
    }
    .toast.show{display:block}

    @media (max-width: 520px){
      :root{ --pileW: 96px; --cardH: 66px; --offset: 20px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">ü¶Ç Scorpion Solitaire (MVP)</div>
      <div class="chips">
        <div class="chip">üßÆ Siirrot <b id="moves">0</b></div>
        <div class="chip">üß± Stock <b id="stock">3</b></div>
        <div class="chip">‚úÖ Valmiit <b id="done">0</b></div>
      </div>
    </div>

    <div class="card">
      <div class="btnrow">
        <button class="btn green" id="btnNew">New game</button>
        <button class="btn secondary" id="btnRestart">Restart sama jako</button>
        <button class="btn secondary" id="btnUndo">Undo</button>
        <button class="btn secondary" id="btnRedo">Redo</button>
        <button class="btn" id="btnDeal">Deal stock (3)</button>
        <button class="btn ghost" id="btnFit">Sovita ruutuun: <span id="fitState">ON</span></button>
      </div>

      <div class="hint">
        <b>Scorpion-s√§√§nt√∂:</b> Siirr√§ mik√§ tahansa <b>face-up</b> kortti + sen p√§√§ll√§ olevat kortit
        toiseen pinoon, jos kohdep√§√§llimm√§inen on <b>samaa maata</b> ja <b>yhden isompi</b> (esim 9‚ô† ‚Üí 8‚ô†‚Ä¶).
        Tyhj√§ pino hyv√§ksyy mink√§ tahansa siirrett√§v√§n sarjan.
        <div class="small" style="margin-top:6px">
          Napauta korttia ‚Üí valitset sarjan. Napauta kohdepinoa ‚Üí siirt√§√§.
        </div>
      </div>

      <div class="small" style="margin-top:10px;opacity:.85">
        <a href="./privacy.html" style="color:#0b5f52;font-weight:1100;text-decoration:none">Tietosuoja</a>
      </div>
    </div>

    <div class="boardOuter" id="boardOuter">
      <div class="boardScaleWrap" id="boardScaleWrap">
        <div class="piles" id="piles"></div>
        <div class="adbox">Mainosalue (Auto Ads / bannerit)</div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
        <div>
          <div style="font-weight:1100">Ty√∂kalut</div>
          <div class="small">Kopioi / tuo tallennus (JSON).</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn ghost" id="btnCopy">üìã Kopioi t√§m√§</button>
          <button class="btn ghost" id="btnImport">‚¨áÔ∏è Tuo tallennus</button>
          <button class="btn ghost" id="btnClear">üßπ Poista tallennus</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);

  const LS = {
    save:"ws_scorpion_save_v1",
    seed:"ws_scorpion_seed_v1",
    fit:"ws_scorpion_fit_v1"
  };

  const CFG = {
    PILES: 7,
    STOCK_CARDS: 3
  };

  // ==== RNG ====
  function mulberry32(a){
    return function() {
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
  }
  function randomSeed(){
    return (Math.floor(Math.random()*1e9) ^ Date.now()) >>> 0;
  }

  let fitOn = (localStorage.getItem(LS.fit) ?? "1") === "1";
  $("fitState").textContent = fitOn ? "ON" : "OFF";

  // Cards: {r:1..13, s:0..3, f:true/false, uid:number}
  // s: 0‚ô† 1‚ô• 2‚ô¶ 3‚ô£
  const SUITS = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
  const RMAP = {1:"A",11:"J",12:"Q",13:"K"};

  let state = {
    seed:0, rng:null,
    piles:[],
    stock:[],
    moves:0,
    done:0,
    selected:null,
    history:[],
    future:[]
  };

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1100);
  }

  function cardLabel(r){ return RMAP[r] || String(r); }

  function snapshot(){
    return JSON.stringify({
      seed: state.seed,
      piles: state.piles,
      stock: state.stock,
      moves: state.moves,
      done: state.done
    });
  }

  function restoreFromSnap(json){
    const s = JSON.parse(json);
    state.seed = (s.seed >>> 0);
    state.rng = mulberry32(state.seed);
    state.piles = s.piles;
    state.stock = s.stock;
    state.moves = s.moves;
    state.done = s.done;
    state.selected = null;
    state.history = [json];
    state.future = [];
  }

  function pushHistory(){
    state.history.push(snapshot());
    if(state.history.length > 200) state.history.shift();
    state.future = [];
  }

  function shuffle(deck, rng){
    for(let i=deck.length-1;i>0;i--){
      const j = Math.floor(rng()*(i+1));
      [deck[i],deck[j]]=[deck[j],deck[i]];
    }
  }

  function buildDeck(){
    const deck=[];
    let uid=1;
    for(let s=0;s<4;s++){
      for(let r=1;r<=13;r++){
        deck.push({r,s,f:true,uid:uid++});
      }
    }
    return deck;
  }

  function saveGame(){
    localStorage.setItem(LS.save, snapshot());
    localStorage.setItem(LS.seed, String(state.seed));
  }

  function loadGame(){
    const s = localStorage.getItem(LS.save);
    if(!s) return false;
    restoreFromSnap(s);
    renderAll();
    return true;
  }

  // ==== Scorpion setup ====
  // 7 columns of 7 cards each (49) and stock 3 cards
  // First 4 columns: first 3 face-down, rest face-up
  // Last 3 columns: all face-up
  function newGame(seed){
    state.seed = seed>>>0;
    state.rng = mulberry32(state.seed);
    state.piles = Array.from({length:CFG.PILES}, ()=>[]);
    state.stock = [];
    state.moves = 0;
    state.done = 0;
    state.selected = null;
    state.history = [];
    state.future = [];

    const deck = buildDeck();
    shuffle(deck, state.rng);

    // Deal 7x7 = 49 to tableau
    for(let col=0; col<CFG.PILES; col++){
      for(let i=0;i<7;i++){
        const c = deck.pop();
        // face-down rules
        if(col < 4 && i < 3) c.f = false;
        else c.f = true;
        state.piles[col].push(c);
      }
    }

    // Remaining 3 in stock
    state.stock = deck.map(c => ({...c, f:true}));

    pushHistory();
    renderAll();
    saveGame();
    toast("Uusi Scorpion.");
  }

  function restartSame(){
    newGame(state.seed);
  }

  // Deal stock: In many Scorpion rules, deal 1 card to each of the first 3 columns
  // We'll deal to the first 3 columns to consume 3 cards.
  function canDeal(){
    return state.stock.length === 3;
  }

  function dealStock(){
    if(!canDeal()){
      toast("Stock jo jaettu.");
      return;
    }
    pushHistory();
    for(let i=0;i<3;i++){
      const c = state.stock.pop();
      c.f = true;
      state.piles[i].push(c);
    }
    state.moves += 1;
    state.selected = null;
    flipExposed();
    countCompleted();
    renderAll();
    saveGame();
  }

  // Flip exposed: if a pile's top card is face-down and becomes exposed, flip it.
  function flipExposed(){
    for(const p of state.piles){
      if(p.length===0) continue;
      const top = p[p.length-1];
      if(top && top.f===false) top.f=true;
    }
  }

  // In Scorpion, "completed" is usually four foundations K->A in-suit.
  // MVP: just count completed sequences on tableau tails (K..A same suit) and remove them.
  function isCompleteTail(pile){
    if(pile.length < 13) return false;
    const tail = pile.slice(pile.length-13);
    const suit = tail[0].s;
    for(let i=0;i<13;i++){
      const want = 13 - i;
      const c = tail[i];
      if(!c.f) return false;
      if(c.s !== suit) return false;
      if(c.r !== want) return false;
    }
    return true;
  }
  function countCompleted(){
    let removed=0;
    for(let i=0;i<CFG.PILES;i++){
      if(isCompleteTail(state.piles[i])){
        state.piles[i] = state.piles[i].slice(0, state.piles[i].length-13);
        removed++;
      }
    }
    if(removed){
      state.done += removed;
      toast("Valmis maa! +" + removed);
    }
  }

  // ==== Moving rules ====
  // Select: any face-up card, along with all cards above it.
  // Place: onto top card if same suit and targetRank == selectedRank+1 (descending)
  function canPlace(runTop, targetPile){
    if(targetPile.length===0) return true;
    const t = targetPile[targetPile.length-1];
    if(!t.f) return false;
    return (t.s === runTop.s) && (t.r === runTop.r + 1);
  }

  function flashBad(pileIndex){
    const el = document.querySelector(`.pile[data-pile="${pileIndex}"]`);
    if(!el) return;
    el.classList.remove("flashBad");
    void el.offsetWidth;
    el.classList.add("flashBad");
  }

  function moveRun(fromPileIdx, fromIndex, toPileIdx){
    const from = state.piles[fromPileIdx];
    const to = state.piles[toPileIdx];
    const run = from.slice(fromIndex);
    const runTop = run[0];

    if(!runTop || !runTop.f){
      flashBad(fromPileIdx);
      return false;
    }
    if(!canPlace(runTop, to)){
      flashBad(toPileIdx);
      return false;
    }

    pushHistory();
    state.piles[toPileIdx] = to.concat(run);
    state.piles[fromPileIdx] = from.slice(0, fromIndex);

    state.moves += 1;
    state.selected = null;

    flipExposed();
    countCompleted();
    renderAll();
    saveGame();
    return true;
  }

  // ==== Undo/Redo ====
  function undo(){
    if(state.history.length<=1) return;
    const cur = state.history.pop();
    state.future.push(cur);
    const prev = state.history[state.history.length-1];
    restoreFromSnap(prev);
    renderAll();
    saveGame();
  }
  function redo(){
    if(state.future.length===0) return;
    const next = state.future.pop();
    state.history.push(next);
    restoreFromSnap(next);
    renderAll();
    saveGame();
  }

  // ==== Render ====
  function renderAll(){
    $("moves").textContent = state.moves;
    $("stock").textContent = state.stock.length;
    $("done").textContent = state.done;

    $("btnDeal").disabled = !canDeal();

    renderPiles();
    applyFit();
  }

  function clearTargetClasses(){
    document.querySelectorAll(".pile").forEach(p => p.classList.remove("targetOK","targetNO"));
  }
  function paintTargets(){
    clearTargetClasses();
    if(!state.selected) return;

    const fromPile = state.piles[state.selected.pileIndex];
    const runTop = fromPile[state.selected.fromIndex];
    document.querySelectorAll(".pile").forEach(p => {
      const idx = Number(p.dataset.pile);
      if(idx === state.selected.pileIndex) return;
      const ok = canPlace(runTop, state.piles[idx]);
      p.classList.add(ok ? "targetOK" : "targetNO");
    });
  }

  function renderPiles(){
    const pilesEl = $("piles");
    pilesEl.innerHTML = "";

    const offset = parseInt(getComputedStyle(document.documentElement).getPropertyValue("--offset")) || 22;

    for(let i=0;i<CFG.PILES;i++){
      const pile = state.piles[i];

      const pileWrap = document.createElement("div");
      pileWrap.className = "pile" + (pile.length===0 ? " empty" : "");
      pileWrap.dataset.pile = String(i);

      const cardsWrap = document.createElement("div");
      cardsWrap.className = "cards";

      const sel = state.selected && state.selected.pileIndex===i ? state.selected : null;

      for(let c=0;c<pile.length;c++){
        const card = pile[c];
        const el = document.createElement("div");
        el.className = "cardEl" + (card.f ? "" : " down");
        el.style.top = (c*offset) + "px";
        el.dataset.pile = String(i);
        el.dataset.index = String(c);

        const rank = document.createElement("div");
        rank.className = "rank";
        rank.textContent = cardLabel(card.r);

        const mini = document.createElement("div");
        mini.className = "mini";
        mini.textContent = "";

        const suit = document.createElement("div");
        suit.className = "suit";
        suit.textContent = SUITS[card.s];

        el.appendChild(rank);
        el.appendChild(mini);
        el.appendChild(suit);

        if(sel && c === sel.fromIndex) el.classList.add("selected");
        if(sel && c > sel.fromIndex) el.classList.add("selTail");

        el.addEventListener("click",(e)=>{
          e.stopPropagation();

          // if selecting while another pile selected => move directly
          if(state.selected && state.selected.pileIndex !== i){
            moveRun(state.selected.pileIndex, state.selected.fromIndex, i);
            return;
          }

          // toggle selection
          if(state.selected && state.selected.pileIndex===i && state.selected.fromIndex===c){
            state.selected=null;
            renderPiles(); applyFit();
            return;
          }

          // cannot select face-down
          if(!card.f){
            flashBad(i);
            return;
          }

          state.selected = {pileIndex:i, fromIndex:c};
          renderPiles(); applyFit();
        });

        cardsWrap.appendChild(el);
      }

      pileWrap.addEventListener("click", ()=>{
        if(!state.selected) return;

        if(state.selected.pileIndex===i){
          state.selected=null;
          renderPiles(); applyFit();
          return;
        }
        moveRun(state.selected.pileIndex, state.selected.fromIndex, i);
      });

      pileWrap.appendChild(cardsWrap);
      pilesEl.appendChild(pileWrap);
    }

    paintTargets();
  }

  function applyFit(){
    const wrap = $("boardScaleWrap");
    if(!wrap) return;

    if(!fitOn){
      wrap.style.transform="scale(1)";
      return;
    }
    const outer = $("boardOuter");
    const outerStyle = getComputedStyle(outer);
    const padL = parseFloat(outerStyle.paddingLeft) || 0;
    const padR = parseFloat(outerStyle.paddingRight) || 0;
    const available = outer.clientWidth - padL - padR;

    const pilesEl = $("piles");
    const contentWidth = pilesEl.scrollWidth;
    const scale = Math.min(1, available / contentWidth);

    wrap.style.transform = `scale(${scale})`;
  }
  window.addEventListener("resize", applyFit);

  // ==== Tools: copy/import ====
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(_){
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); document.body.removeChild(ta); return true; }
      catch(e){ document.body.removeChild(ta); return false; }
    }
  }

  $("btnCopy").addEventListener("click", async ()=>{
    const ok = await copyText(localStorage.getItem(LS.save) || snapshot());
    toast(ok ? "Kopioitu!" : "Kopiointi ep√§onnistui.");
  });

  $("btnImport").addEventListener("click", ()=>{
    const txt = prompt("Liit√§ tallennus (JSON) t√§h√§n:");
    if(!txt) return;
    try{
      restoreFromSnap(txt);
      saveGame();
      renderAll();
      toast("Tallennus tuotu!");
    }catch(e){
      toast("Virhe tallennuksessa.");
    }
  });

  $("btnClear").addEventListener("click", ()=>{
    localStorage.removeItem(LS.save);
    toast("Tallennus poistettu.");
  });

  // ==== Buttons ====
  $("btnNew").addEventListener("click", ()=>{
    const seed = randomSeed();
    localStorage.setItem(LS.seed, String(seed));
    newGame(seed);
  });
  $("btnRestart").addEventListener("click", restartSame);
  $("btnUndo").addEventListener("click", undo);
  $("btnRedo").addEventListener("click", redo);
  $("btnDeal").addEventListener("click", dealStock);

  $("btnFit").addEventListener("click", ()=>{
    fitOn = !fitOn;
    localStorage.setItem(LS.fit, fitOn ? "1" : "0");
    $("fitState").textContent = fitOn ? "ON" : "OFF";
    applyFit();
  });

  // ==== Init ====
  const loaded = loadGame();
  if(!loaded){
    const s = Number(localStorage.getItem(LS.seed) || 0);
    const seed = s ? (s>>>0) : randomSeed();
    localStorage.setItem(LS.seed, String(seed));
    newGame(seed);
  } else {
    toast("Tallennus ladattu.");
  }
})();
</script>
</body>
</html>
