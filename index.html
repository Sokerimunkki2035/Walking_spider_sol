<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Walking Spider ‚Äì Index (taukoautomaatilla)</title>
  <style>
    :root{
      --bg:#0d4a3a;
      --panel:rgba(0,0,0,.16);
      --panel2:rgba(255,255,255,.10);
      --border:rgba(255,255,255,.16);
      --btn:rgba(255,255,255,.18);
      --btn2:rgba(120,255,200,.22);
      --txt:#fff;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:12px;}
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;
      margin-bottom:10px;
    }
    .btn{
      border:0;border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      background:var(--btn);
      color:#fff;
      white-space:nowrap;
    }
    .btn.primary{ background:var(--btn2); }
    .pill{
      padding:10px 14px;border-radius:999px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.15);
      font-weight:900;
      white-space:nowrap;
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      margin:10px 0;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center;}
    select{
      padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.2);
      background:rgba(255,255,255,.10);color:#fff;font-weight:900;
    }
    option{color:#000}
    #appFrame{
      width:100%;
      height: calc(100vh - 210px);
      border:0;
      border-radius:16px;
      background:rgba(255,255,255,.08);
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    .small{opacity:.85;font-size:13px;line-height:1.35}

    /* --- BREAK OVERLAY --- */
    #breakOverlay{
      display:none;
      position:fixed;
      inset:0;
      z-index:9999;
      background:rgba(0, 35, 30, .92);
      backdrop-filter: blur(4px);
      color:#fff;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .breakBox{
      max-width:640px;
      width:100%;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:16px;
      text-align:center;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .bigTimer{
      font-size:56px;
      font-weight:1000;
      letter-spacing:1px;
      margin:10px 0 6px;
    }
    .progress{
      height:12px;
      border-radius:999px;
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      margin:10px 0 14px;
    }
    #progBar{
      height:100%;
      width:0%;
      background:rgba(120,255,200,.75);
    }
    .qbox{
      text-align:left;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
      display:none;
    }
    .qbox h3{margin:0 0 8px;font-size:14px}
    .qrow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .qrow button{flex:1 1 140px}
    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      background:rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      display:none;
      max-width:min(92vw,520px);
      text-align:center;
      z-index:99999;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <button class="btn primary" onclick="loadPage('spider.html')">üï∑Ô∏è Spider (1 maa)</button>
        <button class="btn" onclick="loadPage('scorpion.html')">ü¶Ç Scorpion</button>
        <button class="btn" onclick="loadPage('golf.html')">‚õ≥ Golf</button>

        <button class="btn" onclick="forceBreak()">üö∂ Tauko nyt</button>
        <div class="pill">Aktiiviaika: <span id="activeClock">00:00</span></div>
      </div>

      <div class="row" style="margin-top:8px">
        <div class="pill">Tauko joka</div>
        <select id="everySel" title="Tauko joka X minuuttia">
          <option value="15">15 min</option>
          <option value="20">20 min</option>
          <option value="25" selected>25 min</option>
          <option value="30">30 min</option>
          <option value="45">45 min</option>
        </select>

        <div class="pill">Tauon pituus</div>
        <select id="lenSel" title="Tauon pituus">
          <option value="3" selected>3 min</option>
          <option value="5">5 min</option>
          <option value="7">7 min</option>
        </select>

        <button class="btn" onclick="resetActive()">Nollaa laskuri</button>
      </div>

      <div class="small" style="text-align:center;margin-top:8px">
        T√§m√§ toimii ‚Äúautomaattina‚Äù koska pysyt t√§ss√§ indexiss√§ ja pelit avautuvat ruudun sis√§√§n.
        Tauon aikana peli lukitaan eik√§ kosketus mene l√§pi.
      </div>
    </div>

    <iframe id="appFrame" src="spider.html" title="Walking Spider"></iframe>

    <div class="card" style="text-align:center">
      <span class="small">
        Tietosuoja: <a href="privacy.html" style="color:#eafff5;font-weight:1000;text-decoration:none">privacy.html</a>
      </span>
    </div>
  </div>

  <!-- BREAK OVERLAY -->
  <div id="breakOverlay">
    <div class="breakBox">
      <div style="font-size:18px;font-weight:1000">üö∂ K√§velytauko</div>
      <div class="small" id="breakHint">Nouse yl√∂s ja liiku hetki. Tauon aikana peli on lukittu.</div>
      <div class="bigTimer" id="breakTimer">03:00</div>

      <div class="progress"><div id="progBar"></div></div>

      <div class="row">
        <button class="btn primary" id="doneBtn" disabled onclick="finishBreak()">Valmis ‚Äì jatka peli√§</button>
      </div>

      <div class="qbox" id="qbox">
        <h3>Lyhyt check-in</h3>

        <div class="small">1) Onko ollut hyv√§ p√§iv√§?</div>
        <div class="qrow">
          <button class="btn" onclick="pick('day','Juu')">Juu</button>
          <button class="btn" onclick="pick('day','Ei')">Ei</button>
        </div>

        <div class="small">2) Miten tauko meni?</div>
        <div class="qrow">
          <button class="btn" onclick="pick('break','Kivaa')">Kivaa</button>
          <button class="btn" onclick="pick('break','Ihan ok')">Ihan ok</button>
          <button class="btn" onclick="pick('break','Tyhm√§√§')">Tyhm√§√§</button>
        </div>

        <div class="small">3) Saitko jotain ajatuksia?</div>
        <div class="qrow">
          <button class="btn" onclick="pick('idea','Ajatukset rullasi')">Ajatukset rullasi</button>
          <button class="btn" onclick="pick('idea','Paras idea')">Paras idea</button>
          <button class="btn" onclick="pick('idea','Tarttee kelata')">Tarttee kelata</button>
        </div>

        <div class="small" id="qsum" style="margin-top:6px"></div>
      </div>

      <div class="small" style="margin-top:10px;opacity:.85">
        (Wake Lock yritet√§√§n pit√§√§ p√§√§ll√§ tauon ajan, jos selaimesi sallii.)
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* -----------------------
   NAV / iframe
------------------------ */
const frame = document.getElementById('appFrame');

function loadPage(path){
  frame.src = path;
  toast(`Avattu: ${path}`);
  hookFrameActivitySoon();
}

function goStartInFrame(){
  // jos haluat my√∂hemmin: frame.contentWindow.location.hash = '#top' tms
}

/* -----------------------
   TAUKOMOOTTORI (globaalisti indexiss√§)
------------------------ */
const LSKEY = "walking_break_settings_v1";

let activeSeconds = 0;
let everyMin = 25;
let breakMin = 3;

let tick = null;
let onBreak = false;

let breakLeft = 0;
let breakTotal = 0;
let breakTimerInterval = null;

let wakeLock = null;

const activeClock = document.getElementById('activeClock');
const everySel = document.getElementById('everySel');
const lenSel = document.getElementById('lenSel');

function loadSettings(){
  try{
    const raw = localStorage.getItem(LSKEY);
    if(raw){
      const s = JSON.parse(raw);
      if(s.everyMin) everyMin = Number(s.everyMin);
      if(s.breakMin) breakMin = Number(s.breakMin);
    }
  }catch(e){}
  everySel.value = String(everyMin);
  lenSel.value = String(breakMin);
}

function saveSettings(){
  localStorage.setItem(LSKEY, JSON.stringify({everyMin, breakMin}));
}

everySel.addEventListener('change', ()=>{
  everyMin = Number(everySel.value);
  saveSettings();
  toast(`Tauko joka ${everyMin} min`);
});
lenSel.addEventListener('change', ()=>{
  breakMin = Number(lenSel.value);
  saveSettings();
  toast(`Tauon pituus ${breakMin} min`);
});

function formatMMSS(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
}

function startEngine(){
  if(tick) clearInterval(tick);
  tick = setInterval(()=>{
    if(onBreak) return;
    if(document.visibilityState !== 'visible') return;

    activeSeconds++;
    activeClock.textContent = formatMMSS(activeSeconds);

    if(activeSeconds >= everyMin * 60){
      startBreak(breakMin * 60);
    }
  }, 1000);

  activeClock.textContent = formatMMSS(activeSeconds);
}

function resetActive(){
  activeSeconds = 0;
  activeClock.textContent = formatMMSS(activeSeconds);
  toast("Aktiivilaskuri nollattu");
}

function forceBreak(){
  startBreak(breakMin * 60);
}

/* -----------------------
   BREAK OVERLAY
------------------------ */
const overlay = document.getElementById('breakOverlay');
const bt = document.getElementById('breakTimer');
const prog = document.getElementById('progBar');
const doneBtn = document.getElementById('doneBtn');
const qbox = document.getElementById('qbox');
const qsum = document.getElementById('qsum');

let answers = {day:null, break:null, idea:null};

function startBreak(seconds){
  if(onBreak) return;

  onBreak = true;
  breakTotal = seconds;
  breakLeft = seconds;

  doneBtn.disabled = true;
  qbox.style.display = "none";
  answers = {day:null, break:null, idea:null};
  qsum.textContent = "";

  overlay.style.display = "flex";
  updateBreakUI();

  // Wake Lock (best effort)
  requestWakeLock();

  if(breakTimerInterval) clearInterval(breakTimerInterval);
  breakTimerInterval = setInterval(()=>{
    breakLeft--;
    if(breakLeft <= 0){
      breakLeft = 0;
      clearInterval(breakTimerInterval);
      onBreakEnd();
    }
    updateBreakUI();
  }, 1000);

  toast("Tauko alkoi");
}

function updateBreakUI(){
  bt.textContent = formatMMSS(breakLeft);
  const done = (breakTotal - breakLeft);
  const pct = breakTotal ? (done / breakTotal) * 100 : 0;
  prog.style.width = Math.min(100, Math.max(0, pct)) + "%";
}

function onBreakEnd(){
  doneBtn.disabled = false;
  qbox.style.display = "block";
  toast("Tauko valmis ‚Äì paina Valmis");
  releaseWakeLock();
}

function finishBreak(){
  overlay.style.display = "none";
  onBreak = false;
  activeSeconds = 0;
  activeClock.textContent = formatMMSS(activeSeconds);
  toast("Jatketaan peli√§");
}

function pick(key, val){
  answers[key] = val;
  const parts = [];
  if(answers.day) parts.push("P√§iv√§: " + answers.day);
  if(answers.break) parts.push("Tauko: " + answers.break);
  if(answers.idea) parts.push("Ajatus: " + answers.idea);
  qsum.textContent = parts.join(" ¬∑ ");
}

/* -----------------------
   ACTIVITY DETECTION (my√∂s iframe)
   - Pidet√§√§n moottori k√§ynniss√§ joka tapauksessa,
     mutta t√§ll√§ voidaan laajentaa my√∂hemmin (esim. vain aktiivisesta k√§yt√∂st√§ laskeminen).
------------------------ */
["pointerdown","touchstart","keydown","wheel","scroll"].forEach(ev=>{
  window.addEventListener(ev, ()=>{/* paikka tuleville parannuksille */},{passive:true});
});

function hookFrameActivitySoon(){
  // yritet√§√§n lis√§t√§ eventit iframeen (toimii jos sama origin)
  setTimeout(hookFrameActivity, 300);
}
function hookFrameActivity(){
  try{
    const w = frame.contentWindow;
    const d = w.document;
    ["pointerdown","touchstart","keydown","wheel","scroll","click"].forEach(ev=>{
      d.addEventListener(ev, ()=>{/* paikka tuleville parannuksille */},{passive:true});
    });
  }catch(e){
    // jos joskus cross-origin, ei p√§√§st√§ k√§siksi -> ei haittaa
  }
}
frame.addEventListener('load', hookFrameActivitySoon);

/* -----------------------
   Wake Lock
------------------------ */
async function requestWakeLock(){
  try{
    if('wakeLock' in navigator){
      wakeLock = await navigator.wakeLock.request('screen');
      wakeLock.addEventListener('release', ()=>{});
    }
  }catch(e){}
}
function releaseWakeLock(){
  try{ if(wakeLock){ wakeLock.release(); wakeLock = null; } }catch(e){}
}

function toast(msg, ms=1400){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display='block';
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.style.display='none', ms);
}

/* init */
loadSettings();
startEngine();
hookFrameActivitySoon();
</script>
</body>
</html> 
