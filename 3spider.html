<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spider Solitaire (3–4 maata) – korjattu</title>

  <style>
    body{
      font-family: Arial, sans-serif;
      background:#006633;
      color:#fff;
      margin:0;
      padding:14px;
    }
    h1{ text-align:center; margin:8px 0 10px; }

    .toprow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin-bottom:12px;
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      background:rgba(255,255,255,.18);
      color:#fff;
    }
    .btn.primary{ background:rgba(120,255,200,.22); }
    .pill{
      padding:10px 14px;
      border-radius:999px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.15);
      font-weight:800;
    }

    /* ⭐ TÄMÄ KORJAA “vain 2 kolumnia”:
       Ei wrap -> kaikki 10 saraketta samassa rivissä, vaaka-scroll */
    #game-board{
      display:flex;
      flex-wrap:nowrap;
      gap:10px;
      overflow-x:auto;
      padding:10px 8px 14px;
      border-radius:16px;
      background:rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.14);
      -webkit-overflow-scrolling: touch;
    }

    .column{
      flex:0 0 auto;               /* ei kutistu -> vaaka-scroll */
      width:78px;
      position:relative;
      height:420px;
      border-radius:14px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding-top:24px;
    }
    .coltitle{
      position:absolute;
      top:6px; left:0; right:0;
      text-align:center;
      font-size:12px;
      font-weight:900;
      opacity:.95;
      pointer-events:none;
    }

    /* Kortit pinossa: absolute + top-offset => yläreunat näkyy */
    .card{
      width:72px;
      height:104px;
      background:#fff;
      color:#000;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.20);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:8px 8px;
      user-select:none;
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      box-shadow:0 10px 18px rgba(0,0,0,.35);
      cursor:grab;
      touch-action: manipulation;
    }
    .card.red{ color:#c51818; }
    .card.dragging{ opacity:.7; cursor:grabbing; }
    .rank{ font-weight:900; font-size:18px; line-height:1; }
    .suit{ font-size:16px; align-self:flex-end; }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      background:rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      display:none;
      max-width:min(92vw,520px);
      text-align:center;
      z-index:999;
    }

    .note{
      max-width:900px;
      margin:10px auto 0;
      opacity:.95;
      font-size:13px;
      line-height:1.35;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:14px;
    }
  </style>
</head>

<body>
  <h1>Spider Solitaire (3–4 maata) – korjattu</h1>

  <div class="toprow">
    <button class="btn primary" onclick="initGame(4)">Uusi peli (4 maata)</button>
    <button class="btn" onclick="initGame(3)">Uusi peli (3 maata)</button>
    <div class="pill">Siirrot: <span id="moves">0</span></div>
  </div>

  <div id="game-board" aria-label="Pöytä"></div>

  <div class="note">
    ✅ Korjaukset: 10 saraketta aina yhdessä rivissä (vaaka-scroll), pakka 104 korttia (Spiderin 2 pakkaa),
    kortit eivät katoa, ja siirrot eivät sotke indeksejä (malli + render).
    <br>⚠️ Tämä on MVP: siirtää yhden kortin kerrallaan (ei vielä “sarjan siirtoa”).
  </div>

  <div class="toast" id="toast"></div>

<script>
  const suitsAll = ['♠','♥','♣','♦'];
  const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

  const STACK_GAP = 22; // näkyvän yläreunan määrä (px)

  let columns = [];              // mallidata: 10 saraketta, jokainen array kortti-olioita
  let dragged = null;            // {fromCol, fromIndex}
  let moves = 0;

  function toast(msg, ms=1200){
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.display='block';
    clearTimeout(toast._tm);
    toast._tm = setTimeout(()=>t.style.display='none', ms);
  }

  function buildDeck(suitsCount){
    // Spider tarvitsee 104 korttia (2x 52).
    // 4 maata: 2 täyttä pakkaa.
    // 3 maata: tehdään 104 korttia 3 maasta (tasataan toistolla).
    const used = suitsAll.slice(0, Math.max(1, Math.min(4, suitsCount)));
    const deck = [];
    while(deck.length < 104){
      for(const s of used){
        for(const r of ranks){
          deck.push({ rank:r, suit:s });
          if(deck.length >= 104) break;
        }
        if(deck.length >= 104) break;
      }
    }
    return deck;
  }

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
  }

  function dealSpider(deck){
    // Standard: 10 saraketta, 54 korttia pöytään:
    // 4 saraketta 6 korttia, 6 saraketta 5 korttia.
    const cols = Array.from({length:10}, ()=>[]);
    for(let c=0;c<10;c++){
      const n = (c<4)?6:5;
      for(let k=0;k<n;k++){
        const card = deck.pop();
        cols[c].push(card);
      }
    }
    return cols;
  }

  function initGame(suitsCount=4){
    moves = 0;
    document.getElementById('moves').textContent = moves;

    const deck = buildDeck(suitsCount);
    shuffle(deck);
    columns = dealSpider(deck);

    render();
    toast(`Uusi peli: ${suitsCount} maata (104 korttia)`);
  }

  function rankValue(rank){
    if(rank==='A') return 1;
    if(rank==='J') return 11;
    if(rank==='Q') return 12;
    if(rank==='K') return 13;
    return parseInt(rank,10);
  }

  function canMoveOne(card, targetTop){
    // MVP-sääntö: saa siirtää jos sama maa ja laskeva (esim 7 -> 8 päälle)
    if(!targetTop) return true; // tyhjään saa
    return card.suit === targetTop.suit &&
           rankValue(card.rank) === rankValue(targetTop.rank) - 1;
  }

  function render(){
    const board = document.getElementById('game-board');
    board.innerHTML = '';

    columns.forEach((col, colIndex)=>{
      const colEl = document.createElement('div');
      colEl.className='column';
      colEl.dataset.col = colIndex;

      const title = document.createElement('div');
      title.className='coltitle';
      title.textContent = `Pino ${colIndex+1}`;
      colEl.appendChild(title);

      colEl.addEventListener('dragover', (e)=>e.preventDefault());
      colEl.addEventListener('drop', (e)=>{
        e.preventDefault();
        if(!dragged) return;

        const fromCol = dragged.fromCol;
        const fromIndex = dragged.fromIndex;
        const movingCard = columns[fromCol][fromIndex];

        const targetCol = colIndex;
        const targetTop = columns[targetCol].length ? columns[targetCol][columns[targetCol].length-1] : null;

        if(fromCol === targetCol){
          dragged = null;
          return;
        }

        if(!canMoveOne(movingCard, targetTop)){
          toast("Ei voi siirtää tuohon (maa / järjestys)");
          dragged = null;
          return;
        }

        // siirrä mallissa
        columns[fromCol].splice(fromIndex, 1);
        columns[targetCol].push(movingCard);

        moves++;
        document.getElementById('moves').textContent = moves;

        dragged = null;
        render();
      });

      // kortit
      col.forEach((card, i)=>{
        const cardEl = document.createElement('div');
        const isRed = (card.suit==='♥' || card.suit==='♦');
        cardEl.className = 'card' + (isRed ? ' red' : '');
        cardEl.style.top = (i * STACK_GAP) + 'px';
        cardEl.draggable = true;

        cardEl.innerHTML = `
          <div class="rank">${card.rank}</div>
          <div class="suit">${card.suit}</div>
        `;

        cardEl.addEventListener('dragstart', (e)=>{
          dragged = { fromCol: colIndex, fromIndex: i };
          cardEl.classList.add('dragging');
          e.dataTransfer.setData('text/plain', `${colIndex}:${i}`);
        });
        cardEl.addEventListener('dragend', ()=>{
          cardEl.classList.remove('dragging');
        });

        colEl.appendChild(cardEl);
      });

      board.appendChild(colEl);
    });
  }

  // start
  window.onload = ()=> initGame(4);
</script>
</body>
</html>
