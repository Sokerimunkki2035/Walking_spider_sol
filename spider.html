<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Walking Spider ‚Äì 1 maa (Stock + Undo + Tilastot)</title>

  <style>
    :root{
      --bg:#0d4a3a;
      --panel:rgba(0,0,0,.14);
      --panel2:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.14);
      --btn:rgba(255,255,255,.18);
      --btn2:rgba(120,255,200,.22);

      /* Zoom = skaalataan vain mittoja (ei "ruutua") */
      --z: 1;

      --colW: calc(78px * var(--z));
      --colH: calc(520px * var(--z));
      --padTop: calc(26px * var(--z));

      --cardW: calc(72px * var(--z));
      --cardH: calc(104px * var(--z));
      --cardPad: calc(8px * var(--z));
      --rankFs: calc(18px * var(--z));
      --suitFs: calc(16px * var(--z));
      --gap: calc(22px * var(--z));
      --radius: calc(14px * var(--z));
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background:var(--bg);
      color:#fff;
      margin:0;
      padding:14px;
      user-select:none;
    }

    h1{ text-align:center; margin:8px 0 10px; font-size:18px; }

    .toprow, .subrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin-bottom:10px;
    }

    .btn{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      background:var(--btn);
      color:#fff;
      white-space:nowrap;
    }
    .btn.primary{ background:var(--btn2); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .pill{
      padding:10px 14px;
      border-radius:999px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.15);
      font-weight:900;
      white-space:nowrap;
    }

    #game-board{
      display:flex;
      flex-wrap:nowrap;
      gap:10px;
      overflow-x:auto;
      padding:10px 8px 14px;
      border-radius:16px;
      background:var(--panel);
      border:1px solid var(--border);
      -webkit-overflow-scrolling: touch;
    }

    .column{
      flex:0 0 auto;
      width:var(--colW);
      height:var(--colH);
      position:relative;
      border-radius:var(--radius);
      background:var(--panel2);
      border:1px solid rgba(255,255,255,.12);
      padding-top:var(--padTop);
    }

    .coltitle{
      position:absolute;
      top:calc(7px * var(--z));
      left:0; right:0;
      text-align:center;
      font-size:calc(12px * var(--z));
      font-weight:900;
      opacity:.95;
      pointer-events:none;
    }

    .card{
      width:var(--cardW);
      height:var(--cardH);
      background:#fff;
      color:#000;
      border-radius:calc(10px * var(--z));
      border:1px solid rgba(0,0,0,.20);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      padding:var(--cardPad);
      user-select:none;
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      box-shadow:0 10px 18px rgba(0,0,0,.35);
      cursor:pointer;
      touch-action: manipulation;
    }

    .card.face-down{
      background:linear-gradient(135deg, rgba(255,255,255,.16), rgba(0,0,0,.05));
      color:transparent;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:none;
      cursor:default;
    }

    .card.sel{
      outline:calc(3px * var(--z)) solid rgba(255,215,120,.95);
      box-shadow:0 16px 28px rgba(0,0,0,.45);
      z-index:50;
    }
    .card.locked{ opacity:.90; filter:saturate(.9); }

    .rank{ font-weight:1000; font-size:var(--rankFs); line-height:1; }
    .suit{ font-size:var(--suitFs); align-self:flex-end; }

    .toast{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      bottom:14px;
      background:rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.15);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      display:none;
      max-width:min(92vw,560px);
      text-align:center;
      z-index:999;
    }

    .note{
      max-width:980px;
      margin:10px auto 0;
      opacity:.95;
      font-size:13px;
      line-height:1.35;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;
      border-radius:14px;
    }

    .stats{
      max-width:980px;
      margin:10px auto 0;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:stretch;
    }
    .statcard{
      flex:1 1 240px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      padding:12px;
      min-width:240px;
    }
    .statcard h3{
      margin:0 0 8px;
      font-size:14px;
      opacity:.95;
    }
    .statline{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-weight:900;
      margin:6px 0;
    }
    .muted{ opacity:.85; font-weight:800; }
  </style>
</head>

<body>
  <h1>Spider Solitaire (1 maa) ‚Äì Stock + Undo + Tilastot</h1>

  <div class="toprow">
    <button class="btn" onclick="goMenu()">‚Üê Valikkoon</button>
    <button class="btn" onclick="goStart()">‚ü≤ Palaa alkuun</button>
    <button class="btn primary" onclick="newGame(true)">Uusi peli</button>

    <button class="btn" onclick="undoMove()">‚Ü© Undo</button>

    <button class="btn" onclick="zoomOut()">‚ûñ Zoom</button>
    <div class="pill" id="zoomLabel">100%</div>
    <button class="btn" onclick="zoomIn()">‚ûï Zoom</button>

    <div class="pill">Siirrot: <span id="moves">0</span></div>
  </div>

  <div class="subrow">
    <button class="btn primary" id="dealBtn" onclick="dealFromStock()">üÉè Jaa 10 korttia</button>
    <div class="pill">Stock: <span id="stockCount">0</span></div>
    <div class="pill">Maalit: <span id="goals">0</span>/8</div>
    <div class="pill">Aika: <span id="time">00:00</span></div>
  </div>

  <div id="game-board" aria-label="P√∂yt√§"></div>

  <div class="stats">
    <div class="statcard">
      <h3>üìä Omat tilastot</h3>
      <div class="statline"><span class="muted">Pelatut</span><span id="stPlayed">0</span></div>
      <div class="statline"><span class="muted">Keskeytetyt</span><span id="stAbandoned">0</span></div>
      <div class="statline"><span class="muted">Voitetut</span><span id="stWon">0</span></div>
    </div>
    <div class="statcard">
      <h3>‚è±Ô∏è Ajat (voittopeleist√§)</h3>
      <div class="statline"><span class="muted">Keskiarvo</span><span id="stAvg">‚Äì</span></div>
      <div class="statline"><span class="muted">Enn√§tys</span><span id="stBest">‚Äì</span></div>
      <div class="statline"><span class="muted">Viimeisin voitto</span><span id="stLast">‚Äì</span></div>
      <div style="height:6px"></div>
      <button class="btn" onclick="resetStats()">Nollaa tilastot</button>
    </div>
  </div>

  <div class="note">
    K√§ytt√∂: <b>napauta</b> korttia (valitse) ‚Üí <b>napauta</b> kohdepinoa (tai kohdepinoon kuuluvaa korttia).<br>
    Sarjasiirto: voit siirt√§√§ sarjan vain jos se on <b>kaikki auki</b> ja <b>laskeva 1 askel</b>. (1-maassa ei tarvitse tarkistaa maata.)<br>
    Valmis sarja <b>K‚ÜíA</b> poistuu automaattisesti ja lis√§√§ <b>maaleihin</b>. Voitto: <b>8/8</b>.
  </div>

  <div class="toast" id="toast"></div>

<script>
/* -----------------------------
   PELI: 1 maa (‚ô†), faceDown + stock
------------------------------ */

const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];

let columns = [];
let stock = [];
let moves = 0;
let goals = 0;

let selected = null;   // {fromCol, startIndex, count}
let undoStack = [];    // {columns, stock, moves, goals, timer}
let zoom = 1;

// timer
let gameStartedAt = 0; // ms epoch
let timerTick = null;
let gameActive = false;
let gameWon = false;

// stats (localStorage)
const STKEY = "walking_spider_stats_v1";
let stats = loadStats();

/* -----------------------------
   UI helpers
------------------------------ */
function toast(msg, ms=1400){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display='block';
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.style.display='none', ms);
}

function rankValue(rank){
  if(rank==='A') return 1;
  if(rank==='J') return 11;
  if(rank==='Q') return 12;
  if(rank==='K') return 13;
  return parseInt(rank,10);
}

function formatTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const mm = String(Math.floor(sec/60)).padStart(2,'0');
  const ss = String(sec%60).padStart(2,'0');
  return `${mm}:${ss}`;
}

function elapsedSeconds(){
  if(!gameStartedAt) return 0;
  return (Date.now() - gameStartedAt) / 1000;
}

function updateTopUI(){
  document.getElementById('moves').textContent = moves;
  document.getElementById('stockCount').textContent = stock.length;
  document.getElementById('goals').textContent = goals;
  document.getElementById('zoomLabel').textContent = Math.round(zoom*100) + "%";

  const dealBtn = document.getElementById('dealBtn');
  const canDeal = stock.length >= 10 && !columns.some(c => c.length === 0) && !gameWon;
  dealBtn.disabled = !canDeal;
}

function updateTimerUI(){
  document.getElementById('time').textContent = formatTime(elapsedSeconds());
}

function refreshStatsUI(){
  document.getElementById('stPlayed').textContent = stats.played;
  document.getElementById('stAbandoned').textContent = stats.abandoned;
  document.getElementById('stWon').textContent = stats.won;

  document.getElementById('stAvg').textContent = stats.wonTimes.length
    ? formatTime(average(stats.wonTimes))
    : "‚Äì";

  document.getElementById('stBest').textContent = (stats.bestTimeSec != null)
    ? formatTime(stats.bestTimeSec)
    : "‚Äì";

  document.getElementById('stLast').textContent = (stats.lastWinTimeSec != null)
    ? formatTime(stats.lastWinTimeSec)
    : "‚Äì";
}

function average(arr){
  if(!arr.length) return 0;
  return arr.reduce((a,b)=>a+b,0) / arr.length;
}

/* -----------------------------
   Stats persistence
------------------------------ */
function loadStats(){
  try{
    const raw = localStorage.getItem(STKEY);
    if(raw){
      const obj = JSON.parse(raw);
      // minimal migrations / defaults
      return {
        played: obj.played ?? 0,
        abandoned: obj.abandoned ?? 0,
        won: obj.won ?? 0,
        wonTimes: Array.isArray(obj.wonTimes) ? obj.wonTimes : [],
        bestTimeSec: (typeof obj.bestTimeSec === "number") ? obj.bestTimeSec : null,
        lastWinTimeSec: (typeof obj.lastWinTimeSec === "number") ? obj.lastWinTimeSec : null
      };
    }
  }catch(e){}
  return { played:0, abandoned:0, won:0, wonTimes:[], bestTimeSec:null, lastWinTimeSec:null };
}

function saveStats(){
  localStorage.setItem(STKEY, JSON.stringify(stats));
}

function resetStats(){
  if(!confirm("Nollataanko tilastot?")) return;
  stats = { played:0, abandoned:0, won:0, wonTimes:[], bestTimeSec:null, lastWinTimeSec:null };
  saveStats();
  refreshStatsUI();
  toast("Tilastot nollattu");
}

/* -----------------------------
   Deck / deal
------------------------------ */
function buildDeck(){
  // 104 korttia (1 maa): 8 * 13
  const deck = [];
  for(let p=0;p<8;p++){
    for(const r of ranks){
      deck.push({ rank:r, faceUp:false });
    }
  }
  // shuffle
  for(let i=deck.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [deck[i],deck[j]]=[deck[j],deck[i]];
  }
  return deck;
}

function dealInitial(deck){
  const cols = Array.from({length:10}, ()=>[]);
  for(let c=0;c<10;c++){
    const n = (c<4)?6:5; // 54 korttia p√∂yt√§√§n
    for(let k=0;k<n;k++){
      cols[c].push(deck.pop());
    }
    // vain p√§√§llimm√§inen auki
    cols[c][cols[c].length-1].faceUp = true;
  }
  return cols;
}

/* -----------------------------
   Move rules
------------------------------ */
// 1-maassa sarja siirrett√§v√§ jos: kaikki faceUp ja laskeva 1 askel
function movableCount(col, startIndex){
  const last = col.length - 1;
  if(startIndex < 0 || startIndex > last) return 0;

  const first = col[startIndex];
  if(!first.faceUp) return 0;

  if(startIndex === last) return 1;

  for(let i=startIndex;i<last;i++){
    const a = col[i];
    const b = col[i+1];
    if(!a.faceUp || !b.faceUp) return 0;
    if(rankValue(a.rank) !== rankValue(b.rank) + 1) return 0;
  }
  return col.length - startIndex;
}

function canPlace(movingTop, targetTop){
  if(!targetTop) return true;
  return rankValue(movingTop.rank) === rankValue(targetTop.rank) - 1;
}

/* -----------------------------
   Undo state
------------------------------ */
function saveUndo(){
  undoStack.push({
    columns: JSON.parse(JSON.stringify(columns)),
    stock: JSON.parse(JSON.stringify(stock)),
    moves, goals,
    gameStartedAt,
    gameActive,
    gameWon
  });
  if(undoStack.length > 60) undoStack.shift();
}

function undoMove(){
  if(undoStack.length === 0){
    toast("Ei peruttavaa");
    return;
  }
  const prev = undoStack.pop();
  columns = prev.columns;
  stock = prev.stock;
  moves = prev.moves;
  goals = prev.goals;
  gameStartedAt = prev.gameStartedAt;
  gameActive = prev.gameActive;
  gameWon = prev.gameWon;
  selected = null;
  render();
  toast("Peruttu");
}

/* -----------------------------
   Win / goals (K‚ÜíA removal)
------------------------------ */
function checkAndRemoveCompletedRuns(){
  // Etsit√§√§n jokaisesta pinosta mik√§ tahansa 13 sarjan K..A faceUp, ja poistetaan.
  // Tehd√§√§n loop, koska yhden poiston j√§lkeen voi synty√§ uusi heti.
  let removedAny = false;

  for(let c=0;c<10;c++){
    const col = columns[c];
    if(col.length < 13) continue;

    // tarkistetaan kaikki mahdolliset ikkunat (klassisesti yleens√§ pohjasta)
    for(let start = col.length - 13; start >= 0; start--){
      const slice = col.slice(start, start+13);
      // pit√§√§ olla kaikki auki ja K..A
      let ok = true;
      for(let i=0;i<13;i++){
        const card = slice[i];
        const expected = 13 - i;
        if(!card.faceUp) { ok=false; break; }
        if(rankValue(card.rank) !== expected){ ok=false; break; }
      }
      if(ok){
        // Save undo for this effect? Ei erikseen: t√§m√§ ajetaan siirron/jakon j√§lkeen,
        // ja undo-tila on jo tallennettu ennen siirtoa/jakoa.
        col.splice(start, 13);
        goals++;
        removedAny = true;

        // k√§√§nn√§ uusi ylin auki
        if(col.length){
          col[col.length-1].faceUp = true;
        }

        toast("üèÅ Valmis sarja K‚ÜíA! Maali +1");
        break; // yksi poisto per pino per kierros
      }
    }
  }

  if(removedAny){
    // voitto?
    if(goals >= 8 && !gameWon){
      onWin();
    }
  }
}

function onWin(){
  gameWon = true;
  gameActive = false;

  stopTimer();

  const t = Math.floor(elapsedSeconds());
  stats.won++;
  stats.lastWinTimeSec = t;
  stats.wonTimes.push(t);

  let record = false;
  if(stats.bestTimeSec == null || t < stats.bestTimeSec){
    stats.bestTimeSec = t;
    record = true;
  }

  saveStats();
  refreshStatsUI();

  toast(record ? `üéâ UUSI ENN√ÑTYS! ${formatTime(t)} (voitto)` : `‚úÖ Voitto! Aika ${formatTime(t)}`);
}

/* -----------------------------
   Game lifecycle + timer
------------------------------ */
function startTimer(){
  stopTimer();
  gameStartedAt = Date.now();
  timerTick = setInterval(updateTimerUI, 1000);
  updateTimerUI();
}

function stopTimer(){
  if(timerTick) clearInterval(timerTick);
  timerTick = null;
  updateTimerUI();
}

function markAbandonedIfNeeded(){
  // Keskeytys = peli oli k√§ynniss√§ eik√§ voitettu
  if(gameActive && !gameWon){
    stats.abandoned++;
    saveStats();
    refreshStatsUI();
  }
}

function newGame(userInitiated){
  // jos aloitetaan uusi peli kesken vanhan -> keskeytys
  if(userInitiated) markAbandonedIfNeeded();

  const deck = buildDeck();
  columns = dealInitial(deck);
  stock = deck; // loput 50 korttia
  moves = 0;
  goals = 0;
  undoStack = [];
  selected = null;

  gameActive = true;
  gameWon = false;

  stats.played++;
  saveStats();
  refreshStatsUI();

  // zoom restore
  const saved = parseFloat(localStorage.getItem("spider_zoom") || "1");
  if(!isNaN(saved)) zoom = saved;
  applyZoom(false);

  startTimer();
  render();
  toast("Uusi peli aloitettu");
}

/* -----------------------------
   Actions: select / move / deal
------------------------------ */
function select(fromCol, startIndex){
  const col = columns[fromCol];
  const cnt = movableCount(col, startIndex);
  if(cnt === 0){
    toast("Valitse laskeva, auki oleva sarja (tai p√§√§llimm√§inen)");
    return;
  }
  if(selected && selected.fromCol===fromCol && selected.startIndex===startIndex){
    selected = null;
  }else{
    selected = {fromCol, startIndex, count: cnt};
    toast(cnt>1 ? `Valittu sarja (${cnt})` : "Valittu 1 kortti");
  }
  render();
}

function tryMove(toCol){
  if(!selected || gameWon) return;

  const {fromCol, startIndex, count} = selected;
  if(fromCol === toCol){
    selected = null;
    render();
    return;
  }

  const from = columns[fromCol];
  const to = columns[toCol];
  const moving = from.slice(startIndex, startIndex + count);
  if(moving.length !== count){
    selected = null;
    render();
    return;
  }

  const movingTop = moving[0];
  const targetTop = to.length ? to[to.length-1] : null;

  if(!canPlace(movingTop, targetTop)){
    toast("Ei voi siirt√§√§ tuohon");
    selected = null;
    render();
    return;
  }

  saveUndo();

  from.splice(startIndex, count);
  to.push(...moving);

  // k√§√§nn√§ l√§hdepino: uusi ylin auki
  if(from.length){
    from[from.length-1].faceUp = true;
  }

  moves++;
  selected = null;

  // tarkista maali
  checkAndRemoveCompletedRuns();

  render();
}

function dealFromStock(){
  if(gameWon) return;
  if(stock.length < 10){
    toast("Stock tyhj√§");
    return;
  }
  if(columns.some(c => c.length === 0)){
    toast("Et voi jakaa, jos jokin sarake on tyhj√§.");
    return;
  }

  saveUndo();

  for(let c=0;c<10;c++){
    const card = stock.pop();
    card.faceUp = true;
    columns[c].push(card);
  }

  // jaon j√§lkeen voi valmistua sarja
  checkAndRemoveCompletedRuns();

  render();
  toast("Jako suoritettu");
}

/* -----------------------------
   Rendering
------------------------------ */
function render(){
  const board = document.getElementById('game-board');
  board.innerHTML = '';

  const gapPx = 22 * zoom;

  columns.forEach((col, colIndex)=>{
    const colEl = document.createElement('div');
    colEl.className = 'column';

    const title = document.createElement('div');
    title.className = 'coltitle';
    title.textContent = `Pino ${colIndex+1} (${col.length})`;
    colEl.appendChild(title);

    // klik tyhj√§√§n = kohdepino
    colEl.addEventListener('click', (e)=>{
      if(e.target.classList && e.target.classList.contains('card')) return;
      tryMove(colIndex);
    });

    col.forEach((card, i)=>{
      const cardEl = document.createElement('div');
      cardEl.className = 'card';
      cardEl.style.top = (i * gapPx) + 'px';

      if(!card.faceUp){
        cardEl.classList.add('face-down');
        colEl.appendChild(cardEl);
        return;
      }

      const cnt = movableCount(col, i);
      if(cnt === 0) cardEl.classList.add('locked');

      if(selected && selected.fromCol === colIndex){
        if(i >= selected.startIndex && i < selected.startIndex + selected.count){
          cardEl.classList.add('sel');
        }
      }

      cardEl.innerHTML = `
        <div class="rank">${card.rank}</div>
        <div class="suit">‚ô†</div>
      `;

      // kriittinen: jos valinta on toisessa pinossa -> kortin klikkaus = kohdepino
      cardEl.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(selected && selected.fromCol !== colIndex){
          tryMove(colIndex);
          return;
        }
        select(colIndex, i);
      });

      colEl.appendChild(cardEl);
    });

    board.appendChild(colEl);
  });

  updateTopUI();
  updateTimerUI();
}

/* -----------------------------
   Zoom
------------------------------ */
function applyZoom(renderAfter=true){
  zoom = Math.max(0.75, Math.min(1.25, zoom));
  document.documentElement.style.setProperty('--z', zoom.toFixed(2));
  localStorage.setItem('spider_zoom', String(zoom));
  updateTopUI();
  if(renderAfter) render();
}
function zoomIn(){ zoom += 0.05; applyZoom(true); }
function zoomOut(){ zoom -= 0.05; applyZoom(true); }

/* -----------------------------
   Navigation buttons
------------------------------ */
function goMenu(){
  markAbandonedIfNeeded();
  location.href = 'index.html';
}
function goStart(){
  selected = null;
  const board = document.getElementById('game-board');
  board.scrollLeft = 0;
  toast("Alkuun");
  render();
}

/* -----------------------------
   Page lifecycle: count abandon if leaving mid-game
------------------------------ */
window.addEventListener("beforeunload", () => {
  // jos poistutaan kesken -> keskeytys
  markAbandonedIfNeeded();
});

/* -----------------------------
   Init
------------------------------ */
refreshStatsUI();
newGame(false);
</script>
</body>
</html>
