<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Spider - Scroll & Zoom Fix</title>
    <style>
        :root { --bg: #0d4a3a; --card-w: 80px; }
        
        /* Sallitaan skrollaus pystysuunnassa */
        body { 
            background-color: var(--bg); 
            color: white; 
            margin: 0; 
            font-family: sans-serif; 
            overflow-y: auto; 
            overflow-x: hidden;
            touch-action: pan-y pinch-zoom; 
        }
        
        .controls { 
            display: flex; 
            gap: 8px; 
            padding: 10px; 
            background: rgba(0,0,0,0.8); 
            justify-content: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
        }
        
        button { padding: 10px; border-radius: 8px; border: 1px solid #666; background: #333; color: white; font-weight: bold; }
        
        #board { 
            display: flex; 
            justify-content: center; 
            gap: 4px; 
            padding: 20px 2px; 
            min-height: 120vh; /* Lis√§√§ tilaa alareunaan skrollausta varten */
        }

        .column { 
            width: var(--card-w); 
            min-height: 400px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            display: flex; 
            flex-direction: column; 
            align-items: center;
        }

        .card { 
            width: var(--card-w); 
            height: calc(var(--card-w) * 1.3); 
            background: white; 
            color: black; 
            border-radius: 5px; 
            border: 1px solid #000; 
            margin-bottom: -78px; /* Tiivistetty, jotta mahtuu enemm√§n */
            position: relative; 
            display: flex; 
            flex-direction: column; 
            padding: 4px; 
            box-sizing: border-box; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.3); 
        }

        .card-top { font-weight: 900; font-size: 18px; line-height: 1; }

        .card.back { background: #1a4a8a; border: 1.5px solid #fff; }
        .card.back::after { content: "üï∑Ô∏è"; display: flex; justify-content: center; align-items: center; height: 100%; font-size: 20px; }
        .card.back * { display: none; }

        .card.selected { 
            outline: 4px solid #ffff00; 
            z-index: 5000 !important; 
            transform: translateY(-15px); 
        }

        #stock-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
        #stock { width: 65px; height: 90px; background: #1a4a8a; border: 2px solid #fff; border-radius: 6px; display: flex; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 4px 10px #000; }
    </style>
</head>
<body>

<div class="controls">
    <button onclick="undo()">‚Ü©Ô∏è Peru</button>
    <button onclick="initGame()">üÜï Uusi</button>
    <button onclick="location.reload()">üîÑ Refresh</button>
</div>

<div id="board">
    <div class="column" onclick="handleEmptyClick(0)"></div>
    <div class="column" onclick="handleEmptyClick(1)"></div>
    <div class="column" onclick="handleEmptyClick(2)"></div>
    <div class="column" onclick="handleEmptyClick(3)"></div>
    <div class="column" onclick="handleEmptyClick(4)"></div>
    <div class="column" onclick="handleEmptyClick(5)"></div>
    <div class="column" onclick="handleEmptyClick(6)"></div>
    <div class="column" onclick="handleEmptyClick(7)"></div>
    <div class="column" onclick="handleEmptyClick(8)"></div>
    <div class="column" onclick="handleEmptyClick(9)"></div>
</div>

<div id="stock-container">
    <div id="stock" onclick="dealStock()">JAA</div>
    <div id="stock-count" style="text-align:center; background:black; border-radius:10px; margin-top:4px">50</div>
</div>

<script>
    // Sama toiminnallisuus kuin aiemmassa, mutta render√∂inti optimoitu
    let deck = [], columns = [], history = [], selected = null;

    function initGame() {
        const values = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        deck = [];
        for (let i = 0; i < 8; i++) values.forEach(v => deck.push({v, f:false}));
        for(let i = deck.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i+1)); [deck[i], deck[j]] = [deck[j], deck[i]]; }
        columns = Array.from({length:10}, () => []);
        for (let i = 0; i < 54; i++) { let c = deck.pop(); if (i >= 44) c.f = true; columns[i % 10].push(c); }
        history = []; saveHistory(); render();
    }

    function saveHistory() { history.push(JSON.stringify({ c: columns, d: deck })); if(history.length > 30) history.shift(); }
    function undo() { if (history.length > 1) { history.pop(); const prev = JSON.parse(history[history.length - 1]); columns = prev.c; deck = prev.d; selected = null; render(); } }

    function render() {
        document.querySelectorAll('.column').forEach((el, ci) => {
            el.innerHTML = '';
            columns[ci].forEach((card, ri) => {
                const div = document.createElement('div');
                const isSel = selected && selected.ci === ci && ri >= selected.ri;
                div.className = `card ${card.f ? '' : 'back'} ${isSel ? 'selected' : ''}`;
                div.style.zIndex = ri;
                div.innerHTML = `<div class="card-top">${card.v}‚ô†</div>`;
                div.onclick = (e) => { e.stopPropagation(); handleTap(ci, ri); };
                el.appendChild(div);
            });
        });
        document.getElementById('stock-count').innerText = deck.length;
    }

    function handleTap(ci, ri) {
        if (selected) {
            if (canMove(selected.ci, selected.ri, ci)) { 
                const cards = columns[selected.ci].splice(selected.ri);
                columns[ci].push(...cards);
                if (columns[selected.ci].length > 0) columns[selected.ci][columns[selected.ci].length-1].f = true;
                saveHistory(); checkWin(ci); selected = null;
            } else { selectCard(ci, ri); }
        } else { selectCard(ci, ri); }
        render();
    }

    function handleEmptyClick(ci) { if (selected && columns[ci].length === 0) { const cards = columns[selected.ci].splice(selected.ri); columns[ci].push(...cards); if (columns[selected.ci].length > 0) columns[selected.ci][columns[selected.ci].length-1].f = true; saveHistory(); selected = null; render(); } }
    function selectCard(ci, ri) { if (columns[ci][ri] && columns[ci][ri].f && isLegalStack(ci, ri)) selected = {ci, ri}; else selected = null; }
    function isLegalStack(ci, ri) { const s = columns[ci].slice(ri); for (let i = 0; i < s.length - 1; i++) { if (val(s[i].v) !== val(s[i+1].v) + 1) return false; } return true; }
    function canMove(fci, fri, tci) { if (fci === tci) return false; if (columns[tci].length === 0) return true; return val(columns[tci][columns[tci].length-1].v) === val(columns[fci][fri].v) + 1; }
    function dealStock() { if (deck.length < 10 || columns.some(c => c.length === 0)) return; for (let i = 0; i < 10; i++) { let c = deck.pop(); c.f = true; columns[i].push(c); } saveHistory(); render(); }
    function val(v) { return {'A':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13}[v]; }
    function checkWin(ci) {
        const col = columns[ci];
        if (col.length < 13) return;
        for (let i = 0; i <= col.length - 13; i++) {
            let stack = col.slice(i, i + 13);
            if (stack[0].v === 'K' && stack[12].v === 'A' && isLegalStack(ci, i)) {
                col.splice(i, 13); if (col.length > 0) col[col.length-1].f = true;
                alert("Sarja valmis!"); saveHistory(); return;
            }
        }
    }
    initGame();
</script>
</body>
</html>
