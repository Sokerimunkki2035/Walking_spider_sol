<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spider - Fixed Deck Logic</title>
    <style>
        :root { --bg: #0d4a3a; --card-w: 82px; --zoom: 1.0; }
        body { background-color: var(--bg); color: white; margin: 0; font-family: sans-serif; overflow-x: hidden; touch-action: manipulation; }
        .controls { display: flex; gap: 8px; padding: 10px; background: rgba(0,0,0,0.4); flex-wrap: wrap; justify-content: center; position: sticky; top: 0; z-index: 1000; }
        button { padding: 8px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2); background: #2a2a2a; color: white; cursor: pointer; font-weight: bold; }
        .stats-bar { font-size: 12px; text-align: center; padding: 5px; background: rgba(0,0,0,0.2); }
        #board { display: grid; grid-template-columns: repeat(10, var(--card-w)); justify-content: center; gap: 8px; padding: 20px 5px; transform-origin: top center; transform: scale(var(--zoom)); }
        .column { width: var(--card-w); min-height: 650px; background: rgba(255,255,255,0.03); border-radius: 4px; position: relative; }
        .card { width: var(--card-w); height: calc(var(--card-w) * 1.35); background: white; color: black; border-radius: 6px; border: 1px solid #000; margin-bottom: -100px; position: relative; display: flex; flex-direction: column; padding: 5px; box-sizing: border-box; box-shadow: 0 2px 4px rgba(0,0,0,0.4); cursor: pointer; z-index: 1; }
        .card-top { display: flex; justify-content: space-between; font-weight: 900; font-size: 18px; }
        .card.back { background: #1a4a8a; border: 2px solid #fff; }
        .card.back::after { content: "üï∑Ô∏è"; display: flex; justify-content: center; align-items: center; height: 100%; font-size: 24px; }
        .card.back * { display: none; }
        .card.selected { outline: 4px solid #ffff00; z-index: 999 !important; box-shadow: 0 0 20px #ff0; transform: translateY(-5px); }
        #stock-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; align-items: center; gap: 5px; z-index: 2000; }
        #stock { width: var(--card-w); height: calc(var(--card-w) * 1.35); background: #1a4a8a; border: 2px solid #fff; border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 11px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div class="controls">
    <button onclick="zoom(0.1)">‚ûï Isompi</button>
    <button onclick="zoom(-0.1)">‚ûñ Pienempi</button>
    <button onclick="undo()">‚Ü©Ô∏è Undo</button>
    <button onclick="newGame()">üÜï Uusi peli</button>
    <button onclick="window.parent.location.reload()">üè† Valikko</button>
</div>

<div class="stats-bar" id="stats-text">Ladataan...</div>

<div id="board">
    <div class="column" onclick="handleEmptyClick(0)" data-idx="0"></div>
    <div class="column" onclick="handleEmptyClick(1)" data-idx="1"></div>
    <div class="column" onclick="handleEmptyClick(2)" data-idx="2"></div>
    <div class="column" onclick="handleEmptyClick(3)" data-idx="3"></div>
    <div class="column" onclick="handleEmptyClick(4)" data-idx="4"></div>
    <div class="column" onclick="handleEmptyClick(5)" data-idx="5"></div>
    <div class="column" onclick="handleEmptyClick(6)" data-idx="6"></div>
    <div class="column" onclick="handleEmptyClick(7)" data-idx="7"></div>
    <div class="column" onclick="handleEmptyClick(8)" data-idx="8"></div>
    <div class="column" onclick="handleEmptyClick(9)" data-idx="9"></div>
</div>

<div id="stock-container">
    <div id="stock" onclick="dealStock()">JAA 10 KORTTIA</div>
    <span id="stock-count" style="background:black; padding:2px 8px; border-radius:10px">0</span>
</div>

<script>
    let deck = [], columns = [], history = [];
    let startTime = null, selected = null, currentZoom = 1.0;
    let stats = JSON.parse(localStorage.getItem('spider_stats')) || { played: 0, finished: 0, interrupted: 0, bestTime: null };

    function saveStats() { localStorage.setItem('spider_stats', JSON.stringify(stats)); updateStatsUI(); }
    function updateStatsUI() {
        const best = stats.bestTime ? ` | Enn√§tys: ${formatTime(stats.bestTime)}` : "";
        document.getElementById('stats-text').innerText = `Pelattu: ${stats.played} | Valmis: ${stats.finished} | Keskeytetty: ${stats.interrupted}${best}`;
    }

    function zoom(v) { currentZoom += v; document.documentElement.style.setProperty('--zoom', currentZoom); }

    function newGame() {
        if (startTime && !columns.every(c => c.length === 0)) stats.interrupted++;
        stats.played++; saveStats(); initGame();
    }

    function initGame() {
        const cardValues = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
        deck = [];
        for (let i = 0; i < 8; i++) cardValues.forEach(v => deck.push({v, f:false}));
        
        shuffle(deck);
        columns = Array.from({length:10}, () => []);
        
        for (let i = 0; i < 54; i++) {
            let c = deck.pop();
            if (i >= 44) c.f = true;
            columns[i % 10].push(c);
        }
        
        history = [];
        saveHistory(); 
        startTime = Date.now();
        selected = null;
        render();
    }

    function shuffle(a) { for(let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } }

    function saveHistory() {
        // Syv√§kopioidaan koko pelin tila, jotta Undo ei sekoita viittauksia
        const state = JSON.stringify({
            cols: columns,
            dk: deck
        });
        history.push(state);
        if(history.length > 50) history.shift();
    }
    
    function undo() {
        if (history.length > 1) {
            history.pop(); // Poistetaan nykyinen tila
            const prevState = JSON.parse(history[history.length - 1]);
            columns = prevState.cols;
            deck = prevState.dk;
            selected = null;
            render();
        }
    }

    function dealStock() {
        if (deck.length < 10) return;
        if (columns.some(c => c.length === 0)) {
            alert("T√§yt√§ tyhj√§t sarakkeet ennen uutta jakoa!");
            return;
        }
        for (let i = 0; i < 10; i++) {
            let c = deck.pop(); c.f = true; columns[i].push(c);
        }
        saveHistory(); // Tallennetaan vasta jaon J√ÑLKEEN
        render();
    }

    function render() {
        document.querySelectorAll('.column').forEach((el, ci) => {
            el.innerHTML = '';
            columns[ci].forEach((card, ri) => {
                const div = document.createElement('div');
                const isSelected = selected && selected.ci === ci && ri >= selected.ri;
                div.className = `card ${card.f ? '' : 'back'} ${isSelected ? 'selected' : ''}`;
                div.style.zIndex = ri;
                div.innerHTML = `<div class="card-top"><span>${card.v}</span><span>‚ô†</span></div>`;
                div.onclick = (e) => { e.stopPropagation(); handleTap(ci, ri); };
                el.appendChild(div);
            });
        });
        document.getElementById('stock-count').innerText = deck.length;
        updateStatsUI();
    }

    function handleTap(ci, ri) {
        if (selected) {
            if (canMove(selected.ci, selected.ri, ci)) {
                doMove(selected.ci, selected.ri, ci);
            } else {
                selectCard(ci, ri);
            }
        } else {
            selectCard(ci, ri);
        }
        render();
    }

    function handleEmptyClick(ci) {
        if (selected && columns[ci].length === 0) {
            doMove(selected.ci, selected.ri, ci);
            render();
        }
    }

    function selectCard(ci, ri) {
        if (ri !== -1 && columns[ci][ri].f) {
            if (isLegalStack(ci, ri)) {
                selected = {ci, ri};
            } else {
                selected = null;
            }
        } else {
            selected = null;
        }
    }

    function isLegalStack(ci, ri) {
        const stack = columns[ci].slice(ri);
        for (let i = 0; i < stack.length - 1; i++) {
            if (val(stack[i].v) !== val(stack[i+1].v) + 1) return false;
        }
        return true;
    }

    function canMove(fci, fri, tci) {
        if (fci === tci) return false;
        const movingCard = columns[fci][fri];
        if (columns[tci].length === 0) return true;
        const targetCard = columns[tci][columns[tci].length - 1];
        return val(targetCard.v) === val(movingCard.v) + 1;
    }

    function doMove(fci, fri, tci) {
        const cards = columns[fci].splice(fri);
        columns[tci].push(...cards);
        if (columns[fci].length > 0) columns[fci][columns[fci].length-1].f = true;
        saveHistory(); // Tallennetaan tila siirron j√§lkeen
        checkWin(tci);
        selected = null;
    }

    function val(v) { 
        const m = {'A':1,'2':2,'3':3,'4':4,'5':5,'6':6,'7':7,'8':8,'9':9,'10':10,'J':11,'Q':12,'K':13}; 
        return m[v]; 
    }

    function checkWin(ci) {
        const col = columns[ci];
        if (col.length < 13) return;
        for (let j = 0; j <= col.length - 13; j++) {
            if (val(col[j].v) !== 13) continue;
            let match = true;
            for (let k = 0; k < 12; k++) {
                if (!col[j+k].f || val(col[j+k].v) !== val(col[j+k+1].v) + 1) {
                    match = false; break;
                }
            }
            if (match && val(col[j+12].v) === 1) {
                col.splice(j, 13);
                if (col.length > 0) col[col.length-1].f = true;
                saveHistory(); 
                alert("Sarja valmis! ‚ô†");
                if (columns.every(c => c.length === 0) && deck.length === 0) {
                    const time = Math.floor((Date.now() - startTime) / 1000);
                    stats.finished++;
                    if (!stats.bestTime || time < stats.bestTime) stats.bestTime = time;
                    saveStats(); alert("VOITTO!");
                }
                return;
            }
        }
    }

    function formatTime(s) { return `${Math.floor(s/60)}m ${s%60}s`; }

    initGame();
</script>
</body>
</html>
