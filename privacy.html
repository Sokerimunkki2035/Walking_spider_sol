<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Walking Spider Sol</title>

  <!-- Google AdSense (Auto Ads + mahdolliset ad-paikat). Vaihda client jos tarvii. -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7652525244986434"
    crossorigin="anonymous"></script>

  <style>
    :root{
      --bg:#0b5f52;
      --bg2:#074c42;
      --card:#ffffff;
      --txt:#10211e;
      --muted:#5b6f6b;
      --line:#dbe5e3;
      --btn:#0b5f52;
      --btn2:#1f8b63;
      --warn:#b42318;
      --shadow:0 10px 26px rgba(0,0,0,.22);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg2),var(--bg));
      color:#fff;
    }
    .wrap{max-width:820px;margin:0 auto;padding:14px 14px 24px}
    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom:10px;
    }
    .brand{
      font-weight:900;letter-spacing:.2px;
      font-size:20px;
    }
    .pillrow{display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;align-items:center;justify-content:center;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:#fff;text-decoration:none;font-weight:800;
      backdrop-filter: blur(6px);
    }
    .pill:active{transform:scale(.98)}
    .card{
      background:var(--card); color:var(--txt);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:16px; margin:12px 0;
    }
    h1{margin:6px 0 8px;font-size:34px;letter-spacing:-.5px}
    h2{margin:0 0 10px;font-size:22px;letter-spacing:-.3px}
    p{margin:8px 0;line-height:1.6}
    .small{font-size:13px;color:var(--muted);line-height:1.45}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1;min-width:220px}
    .btn{
      width:100%;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:14px 14px;border-radius:16px;border:0;
      background:var(--btn);color:#fff;font-size:16px;font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .btn.secondary{background:#2a6f62}
    .btn.green{background:var(--btn2)}
    .btn.ghost{
      background:transparent;color:var(--btn);
      border:2px solid var(--line);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn:active{transform:scale(.99)}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      background:#eafff5;border:1px solid #cbe9df;
      color:#0b5f52;
      padding:6px 10px;border-radius:999px;
      font-weight:900;font-size:13px;
    }
    .kpi{
      display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;justify-content:space-between
    }
    .big{
      font-size:58px;font-weight:1000;line-height:1;margin:0;color:#0b5f52;
      letter-spacing:-1px;
    }
    .mono{font-variant-numeric:tabular-nums}
    .progress{
      height:12px;border-radius:999px;background:#e8f4f1;border:1px solid #d3ebe5;overflow:hidden;
      margin:10px 0 2px;
    }
    .bar{height:100%;width:0%;background:#38a169}
    .danger{color:var(--warn);font-weight:900}
    .adbox{
      background:rgba(11,95,82,.08);
      border:2px dashed rgba(11,95,82,.25);
      color:rgba(11,95,82,.85);
      border-radius:16px;
      padding:14px;
      text-align:center;
      font-weight:900;
    }
    footer{opacity:.85;text-align:center;font-size:13px;margin-top:12px}
    footer a{color:#eafff5;text-decoration:none;font-weight:900}

    /* Overlay (liike-tila) */
    .overlay{
      position:fixed;inset:0;
      display:none;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index:9999;
      padding:14px;
    }
    .overlay.show{display:block}
    .ovcard{
      max-width:820px;margin:0 auto;
      background:rgba(20,20,20,.72);
      border:1px solid rgba(255,255,255,.15);
      border-radius:22px;
      padding:16px;
      color:#fff;
      box-shadow:0 18px 44px rgba(0,0,0,.35);
    }
    .ovtitle{font-size:30px;font-weight:1000;margin:0 0 6px}
    .ovmuted{opacity:.9;margin:0 0 14px}
    .timer{
      font-size:64px;font-weight:1000;letter-spacing:-1px;margin:0;
    }
    .ovgrid{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .hintbox{
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      border-radius:18px;
      padding:12px;
      margin-top:12px;
    }
    .longpress{
      display:inline-flex;align-items:center;justify-content:center;
      width:100%;
      padding:14px 14px;
      border-radius:16px;border:1px solid rgba(255,255,255,.22);
      background:rgba(255,255,255,.08);
      color:#fff;font-size:16px;font-weight:1000;
      user-select:none;
    }
    .longpress:active{transform:scale(.99)}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.78);color:#fff;
      padding:10px 12px;border-radius:999px;
      font-weight:900;font-size:13px;
      display:none;z-index:10000;
      border:1px solid rgba(255,255,255,.14)
    }
    .toast.show{display:block}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">Walking Spider Sol</div>
      <div class="pillrow">
        <a class="pill" href="./privacy.html">Tietosuoja</a>
      </div>
    </div>

    <!-- Mainospaikka A (n√§kyy etusivulla). Auto Ads voi my√∂s k√§ytt√§√§ t√§t√§ sivua. -->
    <div class="card">
      <div class="adbox">Auto Ads ‚Äì paikka A (etusivu)</div>
      <!-- Jos k√§yt√§t manuaalista ad-yksikk√∂√§, laita t√§h√§n ins + (adsbygoogle). -->
    </div>

    <div class="card">
      <h1>üëü P√§iv√§n tavoite</h1>
      <p style="margin-top:0">Tavoite mitataan <b>minuutteina</b>. Kun tavoite t√§yttyy, Spider aukeaa.</p>

      <div class="row">
        <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:0">
          <h2 style="margin-top:0">Valitse tavoite</h2>
          <div class="row" style="margin-top:8px">
            <button class="btn secondary" id="goal3">3 min</button>
            <button class="btn secondary" id="goal5">5 min</button>
            <button class="btn secondary" id="goal7">7 min</button>
          </div>
          <p class="small" id="goalText" style="margin-top:10px"></p>
        </div>

        <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:0">
          <div class="kpi">
            <div>
              <div class="small">P√§iv√§</div>
              <div class="tag mono" id="todayTag">‚Äî</div>
            </div>
            <div style="text-align:right">
              <div class="small">Striikki</div>
              <div class="tag">üî• <span class="mono" id="streak">0</span></div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="kpi">
            <div>
              <div class="small">T√§n√§√§n tehty</div>
              <div class="big mono"><span id="doneMin">0</span> min</div>
            </div>
            <div style="text-align:right">
              <div class="small">Tavoite</div>
              <div class="tag mono"><span id="goalMin">5</span> min</div>
            </div>
          </div>

          <div class="progress" aria-label="edistyminen">
            <div class="bar" id="bar"></div>
          </div>
          <div class="small" id="statusLine">‚Äî</div>

          <div style="height:12px"></div>
          <button class="btn" id="startMove">Aloita liike-tila</button>
          <div style="height:10px"></div>
          <button class="btn green" id="openSpider" disabled>üï∑Ô∏è Avaa Spider (uusi v√§lilehti)</button>
          <p class="small" style="margin-top:10px">
            Vinkki: tee p√§iv√§n liike ensin. Sitten avaa Spider.
          </p>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üèÅ Kierros valmis</h2>
      <p class="small" style="margin-top:-2px">
        Kun olet pelannut Spider-kierroksen, paina t√§st√§. T√§m√§ avaa <b>palkitsevan pelinj√§lkeisen n√§kym√§n</b> + mini√§√§niopin.
      </p>
      <div class="row">
        <button class="btn green" id="finishWin" disabled>üëë Voitin kierroksen</button>
        <button class="btn secondary" id="finishLoss" disabled>üí™ H√§visin / keskeytin</button>
      </div>
      <p class="small" id="finishHint" style="margin-top:10px"></p>
    </div>

    <!-- Mainospaikka B (n√§kyy sivulla, mutta PIILOSSA liike-tilassa). -->
    <div class="card" id="adCardB">
      <div class="adbox">Auto Ads ‚Äì paikka B (ennen/ j√§lkeen oppihetken)</div>
    </div>

    <div class="card" id="rewardCard" style="display:none">
      <h2>üéÅ Palkinto</h2>
      <p class="small" id="rewardWhy"></p>
      <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:0">
        <div class="tag">Perchance-prompt ‚ú®</div>
        <p id="promptText" style="font-weight:900;margin:10px 0 12px"></p>
        <button class="btn" id="copyPrompt">Kopioi promptti</button>
        <p class="small" id="copyHint" style="margin-top:10px"></p>
      </div>
    </div>

    <footer>
      <div>Walking Spider Sol ‚Ä¢ <a href="./privacy.html">Tietosuoja</a></div>
    </footer>
  </div>

  <!-- Liike-tila overlay -->
  <div class="overlay" id="moveOverlay" aria-hidden="true">
    <div class="ovcard">
      <div class="ovgrid">
        <div>
          <div class="ovtitle">Liike-tila k√§ynniss√§</div>
          <p class="ovmuted">Kosketus on lukossa, jotta et vahingossa n√§pp√§ile. Liiku vapaasti.</p>
        </div>
        <div style="text-align:right">
          <div class="small" style="color:rgba(255,255,255,.85)">T√§n√§√§n tehty</div>
          <div class="tag" style="background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.18);color:#fff">
            ‚úÖ <span class="mono" id="ovDone">0</span> / <span class="mono" id="ovGoal">5</span> min
          </div>
        </div>
      </div>

      <div class="hintbox">
        <div class="small" style="color:rgba(255,255,255,.88)">Aikaa j√§ljell√§</div>
        <p class="timer mono" id="ovTime">‚Äî</p>
        <div class="progress" style="background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.16)">
          <div class="bar" id="ovBar"></div>
        </div>
        <p class="small" id="ovSense" style="color:rgba(255,255,255,.88);margin-top:10px">Liikehavainto: ‚Äî</p>
        <p class="small" style="color:rgba(255,255,255,.88)">
          Liike-tilassa mainokset ovat piilossa ja palaavat automaattisesti.
        </p>
      </div>

      <div style="height:12px"></div>
      <div class="longpress" id="stopMove">Lopeta (pid√§ pohjassa 2 s)</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const LS = {
    goal: "ws_goal_min",
    done: "ws_done_min_today",
    day:  "ws_day",
    streak: "ws_streak",
    lastDoneDay: "ws_last_done_day",
    lesson: "ws_lesson_idx",
    promptUnlocked: "ws_prompt_unlocked_day"
  };

  function todayISO(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1800);
  }

  function speakFi(text){
    try{
      if(!("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "fi-FI";
      u.rate = 1.02;
      u.pitch = 1.0;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }catch(e){}
  }

  function setText(id, val){ $(id).textContent = String(val); }

  // ---------- State ----------
  const state = {
    day: todayISO(),
    goalMin: Number(localStorage.getItem(LS.goal) || 5),
    doneMin: 0,
    streak: Number(localStorage.getItem(LS.streak) || 0),
    lessonIdx: Number(localStorage.getItem(LS.lesson) || 0),
    move: {
      running:false,
      secondsLeft:0,
      totalSeconds:0,
      tick:null,
      // "liikehavainto"
      motionCount: 0,
      motionLast: 0
    }
  };

  function rolloverDayIfNeeded(){
    const storedDay = localStorage.getItem(LS.day);
    if(storedDay !== state.day){
      // uusi p√§iv√§ => nollaa p√§iv√§n minuutit, mutta striikki pysyy (p√§ivitet√§√§n kun p√§iv√§n tavoite t√§yttyy)
      localStorage.setItem(LS.day, state.day);
      localStorage.setItem(LS.done, "0");
    }
  }

  function loadToday(){
    rolloverDayIfNeeded();
    state.doneMin = Number(localStorage.getItem(LS.done) || 0);
    state.doneMin = clamp(state.doneMin, 0, 999);
  }

  function saveToday(){
    localStorage.setItem(LS.goal, String(state.goalMin));
    localStorage.setItem(LS.done, String(state.doneMin));
    localStorage.setItem(LS.day, state.day);
    localStorage.setItem(LS.streak, String(state.streak));
    localStorage.setItem(LS.lesson, String(state.lessonIdx));
  }

  function progressPct(){
    return clamp((state.doneMin / state.goalMin) * 100, 0, 100);
  }

  function isUnlocked(){
    return state.doneMin >= state.goalMin;
  }

  function refreshUI(){
    setText("todayTag", state.day);
    setText("goalMin", state.goalMin);
    setText("doneMin", state.doneMin);
    setText("streak", state.streak);

    const pct = progressPct();
    $("bar").style.width = pct + "%";

    const left = Math.max(0, state.goalMin - state.doneMin);
    const unlocked = isUnlocked();

    $("statusLine").innerHTML = unlocked
      ? "P√§iv√§ tehty ‚úÖ Spider on auki. Hyv√§ ty√∂."
      : `Viel√§ <b>${left} min</b> j√§ljell√§.`;

    $("openSpider").disabled = !unlocked;
    $("finishWin").disabled = !unlocked;
    $("finishLoss").disabled = !unlocked;

    $("finishHint").textContent = unlocked
      ? "Pelaa kierros ja paina Voitin / H√§visin. Saat miniopin + seuraavan tavoitteen."
      : "Tee ensin p√§iv√§n liike, niin Spider ja pelinj√§lkeinen palkinto aukeaa.";

    $("goalText").textContent = `Nykyinen tavoite: ${state.goalMin} min. (Voit vaihtaa koska vaan.)`;
  }

  // ---------- Motion sensing (kevyt) ----------
  // Jos DeviceMotionEvent toimii, lasketaan pieni√§ liikkeit√§ "motionCount":iin.
  // Ei ole pakko toimia ‚Äî ajastin riitt√§√§ silti.
  async function tryEnableMotion(){
    try{
      if(typeof DeviceMotionEvent === "undefined") return false;
      if(typeof DeviceMotionEvent.requestPermission === "function"){
        const res = await DeviceMotionEvent.requestPermission();
        return res === "granted";
      }
      return true;
    }catch(e){
      return false;
    }
  }

  function onMotion(e){
    try{
      const a = e.accelerationIncludingGravity;
      if(!a) return;
      const x = a.x || 0, y = a.y || 0, z = a.z || 0;
      const mag = Math.sqrt(x*x + y*y + z*z);
      // karkeasti: jos muuttuu, lasketaan liike
      const now = Date.now();
      const delta = Math.abs(mag - (state.move.motionLast || mag));
      state.move.motionLast = mag;
      if(delta > 0.9 && (now - state.move.motionCountTs || 0) > 250){
        state.move.motionCount++;
        state.move.motionCountTs = now;
      }
    }catch(e){}
  }

  function motionStatusText(){
    const c = state.move.motionCount;
    // n√§ytet√§√§n numero, jotta n√§et ett√§ sensori "el√§√§"
    return `Liike OK (${String(90000 + (c % 9999)).padStart(5,'0')})`;
  }

  // ---------- Move mode ----------
  function openOverlay(seconds){
    state.move.running = true;
    state.move.totalSeconds = seconds;
    state.move.secondsLeft = seconds;
    state.move.motionCount = 0;
    state.move.motionLast = 0;

    // piilota mainoskortti B liike-tilassa
    $("adCardB").style.display = "none";

    $("moveOverlay").classList.add("show");
    $("moveOverlay").setAttribute("aria-hidden","false");

    setText("ovDone", state.doneMin);
    setText("ovGoal", state.goalMin);

    tickOverlay();
    state.move.tick = setInterval(tickOverlay, 250);

    speakFi("Liike-tila k√§ynniss√§. Hyv√§. Liiku rauhassa.");
  }

  function closeOverlay(){
    state.move.running = false;
    if(state.move.tick) clearInterval(state.move.tick);
    state.move.tick = null;

    $("moveOverlay").classList.remove("show");
    $("moveOverlay").setAttribute("aria-hidden","true");

    // palauta mainoskortti B
    $("adCardB").style.display = "";

    refreshUI();
  }

  function tickOverlay(){
    if(!state.move.running) return;
    // laske aikaa
    state.move.secondsLeft = Math.max(0, state.move.secondsLeft - 0.25);

    const s = Math.ceil(state.move.secondsLeft);
    $("ovTime").textContent = s + " s";
    $("ovSense").textContent = "Liikehavainto: " + motionStatusText();

    const pct = clamp(((state.move.totalSeconds - state.move.secondsLeft) / state.move.totalSeconds) * 100, 0, 100);
    $("ovBar").style.width = pct + "%";

    // kehu harvakseltaan
    if(s === Math.floor(state.move.totalSeconds * 0.66)) speakFi("Hyv√§. Jatka.");
    if(s === Math.floor(state.move.totalSeconds * 0.33)) speakFi("Hienoa. Viel√§ v√§h√§n.");

    // valmis
    if(state.move.secondsLeft <= 0){
      // lis√§√§ MINUUTTEJA (ei metrej√§)
      const addMin = Math.round(state.move.totalSeconds / 60);
      state.doneMin = clamp(state.doneMin + addMin, 0, 999);
      saveToday();
      refreshUI();

      // jos p√§iv√§n tavoite t√§yttyy nyt, p√§ivit√§ striikki kerran/p√§iv√§
      if(isUnlocked()){
        const lastDone = localStorage.getItem(LS.lastDoneDay);
        if(lastDone !== state.day){
          localStorage.setItem(LS.lastDoneDay, state.day);
          state.streak = clamp(state.streak + 1, 0, 9999);
          saveToday();
        }
      }

      speakFi("Valmis. P√§iv√§n liike kirjattu.");
      toast("‚úÖ Liike kirjattu (" + addMin + " min)");
      closeOverlay();
    }
  }

  // Long press stop (2s)
  let lpTimer = null;
  $("stopMove").addEventListener("touchstart", () => {
    if(!state.move.running) return;
    lpTimer = setTimeout(() => {
      speakFi("Liike-tila lopetettu.");
      toast("Liike-tila lopetettu");
      closeOverlay();
    }, 2000);
  }, {passive:true});
  $("stopMove").addEventListener("touchend", () => { if(lpTimer) clearTimeout(lpTimer); lpTimer=null; }, {passive:true});
  $("stopMove").addEventListener("mousedown", () => {
    if(!state.move.running) return;
    lpTimer = setTimeout(() => {
      speakFi("Liike-tila lopetettu.");
      toast("Liike-tila lopetettu");
      closeOverlay();
    }, 2000);
  });
  window.addEventListener("mouseup", () => { if(lpTimer) clearTimeout(lpTimer); lpTimer=null; });

  // ---------- Post-game (palkitseva n√§kym√§) ----------
  const lessons = [
    {
      title: "Minioppi 1 ‚Äî Tyhj√§ sarake on moottori",
      text:
"Minioppi. Spiderissa tyhj√§ sarake on supervoima. Kun saat yhden sarakkeen tyhj√§ksi, pystyt siirt√§m√§√§n pitki√§ ketjuja ja j√§rjest√§m√§√§n p√∂yt√§√§si. Seuraavalla kierroksella tavoite on: tee yksi sarake tyhj√§ksi ja pid√§ se tyhj√§n√§ mahdollisimman pitk√§√§n."
    },
    {
      title: "Minioppi 2 ‚Äî √Ñl√§ jaa uusia kortteja liian aikaisin",
      text:
"Minioppi. Uusi jako tuntuu helpolta, mutta usein se sotkee p√∂yd√§n. Hyv√§ s√§√§nt√∂: ennen jakoa tee ainakin kolme siirtoa, vaikka ne olisivat pieni√§. Jos pystyt parantamaan j√§rjestyst√§ ennen jakoa, loppupeli helpottuu paljon."
    },
    {
      title: "Minioppi 3 ‚Äî Rakentaminen samaa maata kohti",
      text:
"Minioppi. Vaikka voit siirt√§√§ pinon ilman samaa maata, samaa maata olevat pinot ovat kultaa. Ne purkautuvat valmiiksi sarjoiksi helpommin. Seuraava tavoite: yrit√§ rakentaa yksi pitk√§ pino samaa maata kohti, vaikka se olisi hidas."
    },
    {
      title: "Minioppi 4 ‚Äî √Ñl√§ lukitse itse√§si",
      text:
"Minioppi. Spiderissa yleinen virhe on tehd√§ siirto, joka n√§ytt√§√§ hyv√§lt√§, mutta sulkee vaihtoehdot. Jos siirto vie sinulta ainoan tyhj√§n sarakkeen tai tekee kaksi saraketta t√§ysin liikkumattomiksi, pys√§hdy. Kysy: j√§√§k√∂ mulle seuraavaksi jotain j√§rkev√§√§ siirtoa?"
    },
    {
      title: "Minioppi 5 ‚Äî Pienet siirrot ovat siivousta",
      text:
"Minioppi. Pienet siirrot eiv√§t ole turhia. Ne ovat siivousta. Kun siirr√§t yhden kortin, saatat avata t√§rke√§n kortin tai vapauttaa sarakkeen. Seuraava tavoite: etsi yksi pieni siirto, joka paljastaa uuden kortin. Se on usein koko kierroksen k√§√§nnekohta."
    },
  ];

  const nextGoals = [
    "Tavoite: j√§t√§ 1 sarake tyhj√§ksi mahdollisimman pitk√§√§n.",
    "Tavoite: yrit√§ tehd√§ 1 pitk√§ pino samaa maata kohti ennen seuraavaa jakoa.",
    "Tavoite: √§l√§ jaa uusia kortteja ennen kuin olet tehnyt v√§hint√§√§n 3 siirtoa.",
    "Tavoite: avaa uusi jako vasta kun p√∂yt√§ on ‚Äòsiistimpi‚Äô kuin 10 sek sitten.",
    "Tavoite: tee yksi pieni siirto, joka paljastaa uuden kortin."
  ];

  function pickLearnLines(won){
    // Kevyt ‚Äúmit√§ opittiin‚Äù -logiikka: pidet√§√§n t√§m√§ supervarmana.
    const praise = won
      ? "‚úÖ Rytmi oli hyv√§ ‚Äì sait kierroksen maaliin."
      : "‚úÖ Hyv√§ yritys ‚Äì t√§m√§kin treenaa p√§√§t√∂ksi√§ ja k√§rsiv√§llisyytt√§.";
    const improve = won
      ? "üîé Seuraavaksi: ennen uutta jakoa tee viel√§ pari siirtoa, jos mahdollista."
      : "üîé Seuraavaksi: etsi yksi tyhj√§ sarake ja pid√§ se ‚Äòty√∂kaluna‚Äô pidemp√§√§n.";
    return [praise, improve];
  }

  function showPostGame(won){
    // Mainospaikka B on juuri t√§t√§ varten (ennen/j√§lkeen oppihetken).
    // Pidet√§√§n se n√§kyvill√§ normaalitilassa.
    $("adCardB").style.display = "";

    // Rakenna pelinj√§lkeinen kortti dynaamisesti (ei sotkua sivun pohjalle).
    const existing = document.getElementById("postGameCard");
    if(existing) existing.remove();

    const learn = pickLearnLines(won);
    const li = state.lessonIdx % lessons.length;
    const lesson = lessons[li];
    const goal = nextGoals[li % nextGoals.length];

    const card = document.createElement("div");
    card.className = "card";
    card.id = "postGameCard";
    card.innerHTML = `
      <h2 style="margin-top:0">${won ? "üëë Hyv√§! Kierros valmis." : "üí™ Hyv√§ yritys. Kierros valmis."}</h2>
      <p style="margin-top:-2px">T√§n√§√§n t√§rkeint√§ oli: <b>opit ja jatkat</b>.</p>

      <div class="card" style="box-shadow:none;border:1px solid var(--line);margin:12px 0 10px">
        <div style="font-weight:1000;margin-bottom:8px">üß† Mit√§ opittiin</div>
        <div style="line-height:1.7">
          <div>${learn[0]}</div>
          <div>${learn[1]}</div>
        </div>
      </div>

      <div class="row">
        <button class="btn green" id="playLesson">üéß Kuuntele p√§iv√§n minioppi (30 s)</button>
        <button class="btn secondary" id="showGoal">üéØ Seuraava tavoite</button>
      </div>

      <div class="card" id="goalBox" style="display:none;box-shadow:none;border:1px solid var(--line);margin:12px 0 10px">
        <div class="tag">üéØ Seuraava tavoite</div>
        <p style="font-weight:1000;margin:10px 0 0">${goal}</p>
        <p class="small" style="margin:8px 0 0">Vain yksi pieni tavoite kerrallaan = reilu ja palkitseva peli.</p>
      </div>

      <div class="row">
        <button class="btn" id="newRound">üîÅ Uusi kierros (avaa Spider)</button>
        <button class="btn ghost" id="closePost">Sulje</button>
      </div>

      <p class="small" style="margin-top:10px">
        Mainokset n√§kyv√§t fiksusti t√§ss√§ vaiheessa ‚Äì eiv√§t kesken pelin.
      </p>
    `;

    // Lis√§√§ kortti heti ‚ÄúKierros valmis‚Äù -kortin alle
    const after = $("adCardB");
    after.parentNode.insertBefore(card, after.nextSibling);

    // Bind
    $("playLesson").onclick = () => {
      speakFi(lesson.text);
      toast("üéß " + lesson.title);
      // etene oppi-jonossa vasta kun k√§ytt√§j√§ kuuntelee
      state.lessonIdx = (state.lessonIdx + 1) % lessons.length;
      saveToday();
      // palkinto-avaus
      maybeUnlockReward();
      // (Mainospaikka B on jo n√§kyvill√§ t√§ss√§ ymp√§rill√§)
    };

    $("showGoal").onclick = () => {
      $("goalBox").style.display = $("goalBox").style.display === "none" ? "block" : "none";
      if($("goalBox").style.display === "block") speakFi("Seuraava tavoite asetettu.");
    };

    $("newRound").onclick = () => {
      // Avaa Spider vain jos p√§iv√§n tavoite tehty (varmistus)
      if(!isUnlocked()){
        toast("Tee p√§iv√§n liike ensin üôÇ");
        return;
      }
      window.open("https://solitaire.com/spider-solitaire", "_blank", "noopener,noreferrer");
      toast("Avattu Spider uuteen v√§lilehteen");
    };

    $("closePost").onclick = () => card.remove();

    // Pieni ‚Äúpalkitsevuus‚Äù heti:
    speakFi(won ? "Hyv√§. Kierros valmis." : "Hyv√§ yritys. Kierros valmis.");
  }

  // ---------- Reward path (prompt) ----------
  function randomFrom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function buildPrompt(){
    const prompts = [
      "Piirr√§: korttipakka muuttuu k√§velypoluksi, talvi-ilta, l√§mmin valo ikkunasta, rauhallinen fiilis.",
      "Piirr√§: frisbeegolf-tunneli j√§rven rannalla, kes√§ilta, banderollit, ihmiset taustalla, rento tunnelma.",
      "Piirr√§: Spiderin kuningas-kortti ja k√§velykeng√§t, reilu peli -teema, minimalistinen tyyli.",
      "Piirr√§: vihre√§ k√§ytt√∂liittym√§, ‚Äòliike-tila‚Äô overlay, moderni mobiilidesign, pehme√§t varjot.",
      "Piirr√§: kortit j√§rjestyv√§t samaa maata kohti kuin juna, taustalla mets√§polku ja askel√§√§net."
    ];
    return randomFrom(prompts);
  }

  function maybeUnlockReward(){
    // Unelma: muu palkinto kuin raha. Tehd√§√§n t√§m√§ selke√§sti:
    // Palkinto n√§kyy kun striikki >= 3 TAI kun t√§n√§√§n kuuntelee miniopin (yksi/p√§iv√§).
    const already = localStorage.getItem(LS.promptUnlocked) === state.day;
    if(already) return;

    if(state.streak >= 3 || isUnlocked()){
      localStorage.setItem(LS.promptUnlocked, state.day);
      const prompt = buildPrompt();
      $("promptText").textContent = prompt;
      $("rewardWhy").textContent = state.streak >= 3
        ? "üî• 3+ p√§iv√§n striikki! T√§ss√§ p√§iv√§n luova promptti (kopioi Perchanceen)."
        : "‚úÖ P√§iv√§ tehty! T√§ss√§ pieni luova palkinto (kopioi Perchanceen).";
      $("rewardCard").style.display = "block";
      speakFi("Palkinto avattu. Kopioi promptti jos haluat.");
    }
  }

  $("copyPrompt").onclick = async () => {
    try{
      await navigator.clipboard.writeText($("promptText").textContent.trim());
      $("copyHint").textContent = "Kopioitu ‚úÖ";
      toast("Kopioitu ‚úÖ");
    }catch(e){
      $("copyHint").textContent = "Kopiointi ei onnistunut t√§ss√§ selaimessa. Valitse teksti ja kopioi k√§sin.";
      toast("Valitse ja kopioi k√§sin");
    }
  };

  // ---------- Buttons ----------
  function setGoal(min){
    state.goalMin = min;
    saveToday();
    refreshUI();
    toast("Tavoite: " + min + " min");
  }
  $("goal3").onclick = () => setGoal(3);
  $("goal5").onclick = () => setGoal(5);
  $("goal7").onclick = () => setGoal(7);

  $("startMove").onclick = async () => {
    // liike-tilassa kosketus lukkoon overlayn avulla
    // valitse automaattisesti ‚Äúpuuttuvat minuutit‚Äù mutta max 7 min kerralla
    const left = Math.max(0, state.goalMin - state.doneMin);
    const pick = left <= 0 ? 3 : clamp(left, 1, 7);
    const seconds = pick * 60;

    // Yrit√§ motion permission (ei pakollinen)
    const ok = await tryEnableMotion();
    if(ok && !state._motionOn){
      window.addEventListener("devicemotion", onMotion, {passive:true});
      state._motionOn = true;
    }

    openOverlay(seconds);
  };

  $("openSpider").onclick = () => {
    window.open("https://solitaire.com/spider-solitaire", "_blank", "noopener,noreferrer");
    toast("Avattu Spider uuteen v√§lilehteen");
  };

  $("finishWin").onclick = () => showPostGame(true);
  $("finishLoss").onclick = () => showPostGame(false);

  // ---------- Init ----------
  loadToday();
  $("todayTag").textContent = state.day;
  refreshUI();

  // N√§yt√§ palkinto jos jo avattu t√§lle p√§iv√§lle
  if(localStorage.getItem(LS.promptUnlocked) === state.day){
    $("promptText").textContent = buildPrompt();
    $("rewardWhy").textContent = "üéÅ P√§iv√§n palkinto (jo avattu t√§n√§√§n).";
    $("rewardCard").style.display = "block";
  }

})();
</script>
</body>
</html>
```Ó®Å0Ó®Ç
